# STM32F103 双串口RS485通信系统 - 项目总览

> **开发平台**: 正点原子 M48Z-M3 最小系统板 (STM32F103C8T6)  
> **构建系统**: CMake + GCC ARM Toolchain + Ninja  
> **开发环境**: VS Code + Cortex-Debug + PyOCD  
> **最后更新**: 2025-12-01

---

## 📋 目录导航

- **[01-开发环境配置](./01-开发环境配置.md)** - 工具链安装、VS Code插件、调试器驱动
- **[02-硬件连接指南](./02-硬件连接指南.md)** - 引脚定义、CMSIS-DAP连接、RS485接线
- **[03-双串口通信详解](./03-双串口通信详解.md)** - USART1/USART2配置、printf重定向
- **[04-时钟系统配置](./04-时钟系统配置.md)** - HSE+PLL设置、波特率计算原理
- **[05-CMake构建系统](./05-CMake构建系统.md)** - 编译命令、添加源文件、任务配置
- **[06-调试技巧与问题排查](./06-调试技巧与问题排查.md)** - 常见错误解决方案
- **[07-电机控制快速入门](./07-电机控制快速入门.md)** - 张大头Y系列电机使用指南

---

## 🎯 项目简介

本项目是基于STM32F103C8T6的**工业级双串口通信系统**，核心特性：

### 核心功能
- ✅ **双串口独立工作**：USART1调试输出 + USART2 RS485通信
- ✅ **72MHz高速运行**：HSE外部晶振 + PLL倍频
- ✅ **CMSIS-DAP调试**：支持PyOCD在线调试，虚拟串口同时可用
- ✅ **精确波特率控制**：115200bps标准通信速率
- ✅ **GCC工具链适配**：完整实现printf重定向（`__io_putchar`）

### 硬件配置
| 组件 | 型号/规格 | 用途 |
|-----|----------|------|
| 主控MCU | STM32F103C8T6 | 72MHz Cortex-M3，64KB Flash |
| 调试器 | 正点原子ATK-CMSIS-DAP | SWD调试 + 虚拟串口COM5 |
| RS485模块 | 正点原子ATK-MB024 | USART2接口，带CH340转USB |
| 外部晶振 | 8MHz HSE | 提供72MHz系统时钟基准 |

### 软件架构
```
STM32_485/
├── Core/
│   ├── App/                    # 应用层代码
│   │   └── main.c              # 主程序（双串口测试）
│   └── Src/                    # HAL库初始化
│       ├── main.c              # CubeMX生成入口
│       ├── syscalls.c          # GCC系统调用（关键！）
│       └── stm32f1xx_it.c      # 中断服务函数
├── Drivers/
│   ├── SYSTEM/                 # 核心系统驱动
│   │   ├── usart/              # ⭐ 双串口统一管理
│   │   ├── sys/                # 时钟配置
│   │   └── delay/              # 精确延时
│   ├── BSP/                    # 板级支持包
│   │   ├── LED/                # LED指示灯
│   │   ├── KEY/                # 按键输入
│   │   └── EMM_V5/             # 张大头电机协议
│   └── STM32F1xx_HAL_Driver/   # ST官方HAL库
├── cmake/                      # CMake工具链配置
│   └── gcc-arm-none-eabi.cmake
└── build/                      # 编译输出目录
```

---

## 🚀 快速开始（5分钟上手）

### 1. 环境准备
```powershell
# 1.1 安装工具链（已配置PATH环境变量）
arm-none-eabi-gcc --version   # 检查GCC版本
cmake --version               # 检查CMake版本
ninja --version               # 检查Ninja版本

# 1.2 安装PyOCD调试器
pip install pyocd==0.41.0
pyocd list                    # 检查CMSIS-DAP连接
```

### 2. 编译项目
```powershell
cd D:\STM32\Projects\ZDT\STM32_485

# 配置构建
cmake --preset Debug

# 编译
cmake --build --preset Debug

# 输出：build/Debug/STM32_485.elf
```

### 3. 烧录固件
```powershell
# 方法1：使用PyOCD（推荐）
pyocd flash build/Debug/STM32_485.elf --target stm32f103c8

# 方法2：使用STM32CubeProgrammer（GUI工具）
# 打开STM32CubeProgrammer -> 连接ST-Link -> 加载.elf文件 -> 下载
```

### 4. 测试通信
- **打开COM5**（CMSIS-DAP虚拟串口，115200-8-N-1）  
  → 查看printf调试信息和系统诊断报告
  
- **打开COM7**（RS485模块CH340，115200-8-N-1）  
  → 查看"UA"测试字符循环输出（每0.5秒）

---

## 📊 系统工作流程图

```
上电启动
   ↓
HSE晶振启动 (8MHz)
   ↓
PLL倍频 (×9 = 72MHz)
   ↓
配置APB1/APB2时钟
   ├─ APB2 = 72MHz → USART1
   └─ APB1 = 36MHz → USART2
   ↓
初始化GPIO/USART
   ├─ PA9/PA10 → USART1 (COM5)
   └─ PA2/PA3  → USART2 (COM7)
   ↓
主循环
   ├─ printf输出 → USART1 (调试信息)
   └─ HAL_UART_Transmit → USART2 (RS485数据)
```

---

## 🔧 关键技术要点

### 1. 双串口分工明确
| 串口 | 物理接口 | 波特率 | 时钟源 | BRR值 | 用途 |
|-----|---------|-------|-------|------|------|
| USART1 | PA9/PA10 | 115200 | APB2 72MHz | 0x0271 (625) | printf调试输出 |
| USART2 | PA2/PA3 | 115200 | APB1 36MHz | 0x0138 (312) | RS485电机通信 |

### 2. GCC工具链printf实现
```c
// Drivers/SYSTEM/usart/usart.c

/* GCC Newlib使用__io_putchar，而不是fputc */
int __io_putchar(int ch)
{
    while ((USART1->SR & USART_SR_TXE) == 0);  // 等待发送缓冲区空
    USART1->DR = (uint8_t)ch;
    return ch;
}

/* 兼容MDK编译器（可选） */
int fputc(int ch, FILE *f)
{
    while ((USART1->SR & USART_SR_TXE) == 0);
    USART1->DR = (uint8_t)ch;
    return ch;
}
```

**调用链**：`printf()` → `_write()` (syscalls.c) → `__io_putchar()` (usart.c) → USART1硬件

### 3. 时钟配置关键代码
```c
// Drivers/SYSTEM/sys/sys.c

void sys_stm32_clock_init(uint32_t plln)
{
    // 配置HSE + PLL
    rcc_osc_init.OscillatorType = RCC_OSCILLATORTYPE_HSE;
    rcc_osc_init.HSEState = RCC_HSE_ON;
    rcc_osc_init.PLL.PLLState = RCC_PLL_ON;
    rcc_osc_init.PLL.PLLSource = RCC_PLLSOURCE_HSE;
    rcc_osc_init.PLL.PLLMUL = RCC_PLL_MUL9;  // 8MHz × 9 = 72MHz
    
    // 配置总线分频
    rcc_clk_init.APB1CLKDivider = RCC_HCLK_DIV2;  // APB1 = 36MHz
    rcc_clk_init.APB2CLKDivider = RCC_HCLK_DIV1;  // APB2 = 72MHz
}
```

---

## ⚠️ 常见问题速查

| 问题现象 | 可能原因 | 解决方案 |
|---------|---------|---------|
| COM5无输出 | 未实现`__io_putchar` | 检查usart.c第96行函数定义 |
| COM7乱码 | 波特率不匹配 | 确认BRR=0x0138，时钟36MHz |
| 编译失败 | 工具链版本不对 | 使用arm-none-eabi-gcc 10.3+ |
| 烧录失败 | CMSIS-DAP未识别 | `pyocd list`检查连接 |
| 系统不启动 | HSE晶振未起振 | 检查8MHz晶振焊接/短接 |

---

## 📚 学习路径建议

**第一天：环境搭建**
1. 阅读 [01-开发环境配置](./01-开发环境配置.md)
2. 安装工具链和VS Code插件
3. 完成第一次编译和烧录

**第二天：理解架构**
1. 阅读 [02-硬件连接指南](./02-硬件连接指南.md)
2. 阅读 [03-双串口通信详解](./03-双串口通信详解.md)
3. 修改main.c测试printf输出

**第三天：深入原理**
1. 阅读 [04-时钟系统配置](./04-时钟系统配置.md)
2. 理解BRR计算公式
3. 尝试修改波特率

**第四天：实战调试**
1. 阅读 [06-调试技巧与问题排查](./06-调试技巧与问题排查.md)
2. 使用VS Code断点调试
3. 练习GDB命令

**第五天：电机控制**
1. 阅读 [07-电机控制快速入门](./07-电机控制快速入门.md)
2. 连接张大头电机测试
3. 发送位置控制命令

---

## 🎓 参考资料

### 官方文档
- [STM32F103数据手册](https://www.st.com/resource/en/datasheet/stm32f103c8.pdf)
- [STM32F103参考手册](https://www.st.com/resource/en/reference_manual/cd00171190.pdf)
- [HAL库用户手册](https://www.st.com/resource/en/user_manual/dm00154093.pdf)

### 工具文档
- [PyOCD官方文档](https://pyocd.io/)
- [CMake官方教程](https://cmake.org/cmake/help/latest/guide/tutorial/index.html)
- [Cortex-Debug插件文档](https://github.com/Marus/cortex-debug)

### 相关例程
- 正点原子M48Z-M3例程（Keil版）：`bak/Docs/【正点原子】ATK-MB024 485模块/`
- 张大头电机例程（标准库版）：`Docs/STM32_ZDT_PosMode/`

---

## 💡 项目亮点

1. **完整的GCC工具链适配** - 解决printf重定向问题（`__io_putchar`实现）
2. **双调试器支持** - PyOCD + ST-Link均可使用，配置文件完整
3. **工业级代码规范** - 统一命名规则、完整注释、Doxygen风格
4. **真实硬件验证** - 所有代码均在正点原子M48Z-M3开发板实测通过
5. **详细开发文档** - 7篇配套文档，覆盖从入门到精通

---

## 📞 技术支持

- **问题反馈**: 在VS Code中查看错误信息，参考 [06-调试技巧与问题排查](./06-调试技巧与问题排查.md)
- **代码示例**: 所有示例代码均在 `Core/App/` 目录中
- **更新日志**: 查看 `bak/migration_guide.md` 了解历史演进

---

**下一步**: 👉 开始阅读 [01-开发环境配置](./01-开发环境配置.md)
