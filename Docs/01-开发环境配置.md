# 01 - 开发环境配置完整指南

> **难度**: ⭐⭐☆☆☆  
> **预计时间**: 30-60分钟  
> **前置要求**: Windows 10/11 系统，至少5GB硬盘空间

---

## 📋 目录

1. [工具链安装](#1-工具链安装)
2. [VS Code配置](#2-vs-code配置)
3. [调试器驱动安装](#3-调试器驱动安装)
4. [验证环境](#4-验证环境)
5. [常见问题](#5-常见问题)

---

## 1. 工具链安装

### 1.1 ARM GCC编译器

**方法一：使用STM32CubeCLT（推荐）**

STM32CubeCLT集成了完整的GCC工具链，一次安装包含所有工具。

```powershell
# 下载地址
https://www.st.com/en/development-tools/stm32cubeclt.html
# 版本：v1.19.0 或更高

# 安装路径（默认）
C:\ST\STM32CubeCLT_1.19.0\

# 验证安装
arm-none-eabi-gcc --version
# 输出：arm-none-eabi-gcc (GNU Arm Embedded Toolchain 13.2.1) 13.2.1
```

**方法二：独立安装ARM工具链**

```powershell
# 下载地址
https://developer.arm.com/downloads/-/gnu-rm
# 版本：GNU Arm Embedded Toolchain 10.3-2021.10 或更高

# 安装后配置环境变量
# 系统属性 -> 环境变量 -> Path -> 新增：
C:\Program Files (x86)\GNU Arm Embedded Toolchain\10 2021.10\bin
```

**验证工具链**：
```powershell
# 检查GCC
arm-none-eabi-gcc --version

# 检查GDB（调试器）
arm-none-eabi-gdb --version

# 检查objcopy（生成.bin文件）
arm-none-eabi-objcopy --version

# 检查size（查看固件大小）
arm-none-eabi-size --version
```

---

### 1.2 CMake构建工具

```powershell
# 下载地址
https://cmake.org/download/
# 版本：3.28.1 或更高

# 安装时勾选："Add CMake to the system PATH for all users"

# 验证
cmake --version
# 输出：cmake version 3.28.1
```

---

### 1.3 Ninja构建系统

Ninja比Make更快，适合大型项目。

```powershell
# 下载地址
https://github.com/ninja-build/ninja/releases
# 下载：ninja-win.zip

# 解压到工具链目录（推荐）
C:\Tools\ninja\ninja.exe

# 配置环境变量
# Path -> 新增：C:\Tools\ninja

# 验证
ninja --version
# 输出：1.11.1
```

---

### 1.4 Python与PyOCD

PyOCD是开源的CMSIS-DAP调试器后端，支持多种芯片。

```powershell
# 检查Python版本（需要3.8+）
python --version

# 安装PyOCD
pip install pyocd==0.41.0

# 验证安装
pyocd --version
# 输出：0.41.0

# 下载STM32支持包（首次使用必须执行）
pyocd pack install stm32f103c8

# 查看已安装的支持包
pyocd pack show
```

**可选：安装libusb驱动（Windows）**

如果PyOCD无法识别CMSIS-DAP，需要安装libusb驱动：

```powershell
# 下载Zadig工具
https://zadig.akeo.ie/

# 运行Zadig
# 1. Options -> List All Devices
# 2. 选择 "CMSIS-DAP v2" 或 "ALIENTEK CMSIS-DAP"
# 3. 驱动选择 "WinUSB (v6.x.x.x)"
# 4. 点击 "Replace Driver"
```

---

## 2. VS Code配置

### 2.1 安装VS Code

```powershell
# 下载地址
https://code.visualstudio.com/
# 版本：1.85.0 或更高

# 安装时勾选：
☑ 添加到PATH
☑ 将"通过Code打开"操作添加到文件资源管理器右键菜单
☑ 将"通过Code打开"操作添加到目录资源管理器右键菜单
```

---

### 2.2 安装必需插件

打开VS Code，按 `Ctrl+Shift+X` 打开扩展面板，安装以下插件：

#### 核心插件（必装）

1. **C/C++ Extension Pack** (ID: `ms-vscode.cpptools-extension-pack`)
   - 包含C/C++智能提示、调试、代码格式化

2. **Cortex-Debug** (ID: `marus25.cortex-debug`)
   - STM32调试支持，支持PyOCD/OpenOCD/JLink

3. **CMake Tools** (ID: `ms-vscode.cmake-tools`)
   - CMake项目管理和构建

#### 推荐插件（可选）

4. **Better Comments** (ID: `aaron-bond.better-comments`)
   - 彩色注释高亮

5. **Doxygen Documentation Generator** (ID: `cschlosser.doxdocgen`)
   - 自动生成函数注释

6. **Hex Editor** (ID: `ms-vscode.hexeditor`)
   - 查看.bin/.elf二进制文件

---

### 2.3 配置VS Code设置

按 `Ctrl+,` 打开设置，搜索以下项目并配置：

```json
{
    // C/C++配置
    "C_Cpp.default.compilerPath": "C:/ST/STM32CubeCLT_1.19.0/GNU-tools-for-STM32/bin/arm-none-eabi-gcc.exe",
    "C_Cpp.default.intelliSenseMode": "gcc-arm",
    "C_Cpp.default.cStandard": "c11",
    
    // CMake配置
    "cmake.configureOnOpen": false,
    "cmake.generator": "Ninja",
    
    // 文件关联
    "files.associations": {
        "*.ld": "linkerscript",
        "*.s": "arm"
    }
}
```

---

## 3. 调试器驱动安装

### 3.1 正点原子ATK-CMSIS-DAP驱动

**正点原子CMSIS-DAP无需安装驱动**，Windows 10/11自动识别为以下设备：

- **调试接口**: CMSIS-DAP v2（用于SWD调试）
- **虚拟串口**: USB Serial Device (COM5)

**验证连接**：

```powershell
# 方法1：使用PyOCD
pyocd list
# 输出示例：
#   #   Probe/Board                        Unique ID       Target
#   0   ALIENTEK ATK-CMSIS-DAP             ATK-20240820    n/a

# 方法2：检查设备管理器
# 设备管理器 -> 端口(COM和LPT) -> 应看到：
#   USB Serial Device (COM5)
```

**如果未识别**：

1. **检查USB连接**：CMSIS-DAP的电源指示灯应常亮
2. **更换USB端口**：建议使用USB 2.0端口（避免USB 3.0兼容问题）
3. **安装libusb驱动**：参考 [1.4节](#14-python与pyocd)

---

### 3.2 ST-Link驱动（可选）

如果您还使用ST-Link调试器：

```powershell
# 下载地址
https://www.st.com/en/development-tools/stsw-link009.html

# 安装后验证
# 设备管理器 -> 通用串行总线控制器 -> 应看到：
#   STMicroelectronics STLink dongle
```

---

## 4. 验证环境

### 4.1 克隆/打开项目

```powershell
# 方法1：已有项目
cd D:\STM32\Projects\ZDT\STM32_485
code .

# 方法2：从Git克隆（如果有仓库）
git clone <repository_url> STM32_485
cd STM32_485
code .
```

---

### 4.2 配置CMake

在VS Code中：

1. 按 `Ctrl+Shift+P`，输入 `CMake: Select a Kit`
2. 选择 **[Unspecified]**（使用cmake/gcc-arm-none-eabi.cmake指定的工具链）
3. 按 `Ctrl+Shift+P`，输入 `CMake: Configure`
4. 等待配置完成（首次配置较慢）

**或使用终端命令**：

```powershell
# 配置Debug版本
cmake --preset Debug

# 输出应包含：
# -- The C compiler identification is GNU 13.2.1
# -- Configuring done
# -- Generating done
# -- Build files have been written to: D:/STM32/Projects/ZDT/STM32_485/build/Debug
```

---

### 4.3 编译项目

```powershell
# 方法1：使用CMake命令
cmake --build --preset Debug

# 输出示例：
# [45/45] Linking C executable STM32_485.elf
# Memory region         Used Size  Region Size  %age Used
#              RAM:        4632 B        20 KB     22.62%
#            FLASH:       31092 B        64 KB     47.44%

# 方法2：使用VS Code任务
# 按 Ctrl+Shift+B -> 选择 "Build Debug (STM32_485)"
```

**成功标志**：在 `build/Debug/` 目录下生成以下文件：
- `STM32_485.elf` - 可调试固件（包含调试符号）
- `STM32_485.bin` - 纯二进制固件
- `STM32_485.map` - 内存映射文件

---

### 4.4 烧录测试

**连接硬件**：
1. 用USB线连接CMSIS-DAP到电脑
2. CMSIS-DAP的SWDIO/SWCLK连接STM32的PA13/PA14
3. 共地线（GND）必须连接

**烧录固件**：

```powershell
# 使用PyOCD烧录
pyocd flash build/Debug/STM32_485.elf --target stm32f103c8

# 输出示例：
# 0001720 I Loading D:\STM32\Projects\ZDT\STM32_485\build\Debug\STM32_485.elf [load_cmd]
# [==================================================] 100%
# 0011625 I Erased 31744 bytes (31 sectors), programmed 31744 bytes (31 pages) at 3.13 kB/s
```

---

### 4.5 调试测试

在VS Code中：

1. 打开 `Core/App/main.c`
2. 在 `main()` 函数第一行设置断点（点击行号左侧）
3. 按 `F5` 启动调试
4. 程序应在断点处停止

**调试控制**：
- `F5` - 继续运行
- `F10` - 单步跳过
- `F11` - 单步进入
- `Shift+F11` - 跳出函数
- `Shift+F5` - 停止调试

---

### 4.6 串口测试

**打开串口助手**（推荐XCOM/MobaXterm/Putty）：

| 串口 | 波特率 | 数据位 | 停止位 | 校验 | 预期输出 |
|-----|-------|-------|-------|------|---------|
| COM5 | 115200 | 8 | 1 | None | 系统诊断报告（printf输出） |
| COM7 | 115200 | 8 | 1 | None | "UA"字符循环输出 |

**按STM32复位按钮**，应看到：

**COM5输出**：
```
========================================
  STM32F103 Dual USART Configuration
========================================
Clock Source:     HSE 8MHz + PLL ×9
SystemCoreClock:  72000000 Hz (expect 72MHz)
...
```

**COM7输出**：
```
UA
UA
UA
...
```

---

## 5. 常见问题

### 5.1 编译错误

**问题1**: `arm-none-eabi-gcc: command not found`

**原因**：环境变量未配置

**解决**：
```powershell
# 检查PATH
echo $env:Path | Select-String "arm-none-eabi"

# 如无输出，手动添加：
# 系统属性 -> 环境变量 -> Path -> 新增：
C:\ST\STM32CubeCLT_1.19.0\GNU-tools-for-STM32\bin
```

---

**问题2**: `Could not find a package configuration file provided by "CMSIS"`

**原因**：CMake未找到CMSIS库路径

**解决**：检查 `CMakeLists.txt` 是否包含：
```cmake
add_subdirectory(cmake/stm32cubemx)
```

---

### 5.2 调试器问题

**问题1**: `pyocd list` 无输出

**原因**：CMSIS-DAP驱动未安装

**解决**：
```powershell
# 安装libusb驱动（使用Zadig工具）
# 参考 1.4节
```

---

**问题2**: VS Code调试时提示 `Error: Could not connect to target`

**原因**：PyOCD服务器未正确启动

**解决**：
1. 检查 `.vscode/launch.json` 中的 `serverArgs`：
   ```json
   "serverArgs": [
       "--target", "stm32f103c8",
       "--frequency", "4000000"
   ]
   ```
2. 手动启动PyOCD测试：
   ```powershell
   pyocd gdbserver --target stm32f103c8 --frequency 4000000
   ```

---

**问题3**: 调试时断点不命中

**原因**：编译优化级别过高，调试符号缺失

**解决**：检查 `cmake/gcc-arm-none-eabi.cmake`：
```cmake
# Debug模式必须使用 -O0 -g3
set(CMAKE_C_FLAGS_DEBUG "-O0 -g3")
```

---

### 5.3 串口问题

**问题1**: COM5/COM7不存在

**原因**：设备未正确识别

**解决**：
```powershell
# 检查设备管理器
# 端口(COM和LPT) -> 应看到：
#   USB Serial Device (COMx)

# 如果在"其他设备"中显示黄色感叹号，右键更新驱动
# 选择"自动搜索驱动程序"
```

---

**问题2**: 串口乱码

**原因**：波特率不匹配

**解决**：
- 确认串口助手波特率设置为 **115200**
- 检查 `main.c` 中的初始化：
  ```c
  usart1_init(115200);
  usart2_init(115200);
  ```

---

## ✅ 环境验证清单

完成以下检查项，确保环境配置正确：

- [ ] `arm-none-eabi-gcc --version` 有输出
- [ ] `cmake --version` 输出 3.28.1+
- [ ] `ninja --version` 有输出
- [ ] `pyocd list` 显示CMSIS-DAP设备
- [ ] VS Code安装了Cortex-Debug插件
- [ ] 项目编译成功，生成.elf文件
- [ ] PyOCD烧录成功，无错误提示
- [ ] VS Code按F5可启动调试，断点生效
- [ ] COM5/COM7均能接收到数据

---

## 🎯 下一步

环境配置完成后，继续学习：

- **[02-硬件连接指南](./02-硬件连接指南.md)** - 了解引脚定义和连线方式
- **[03-双串口通信详解](./03-双串口通信详解.md)** - 深入理解USART配置

---

**返回**: [00-项目总览](./00-项目总览.md)
