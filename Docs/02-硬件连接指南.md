# 02 - 硬件连接指南

> **难度**: ⭐☆☆☆☆  
> **预计时间**: 15分钟  
> **前置要求**: 已完成 [01-开发环境配置](./01-开发环境配置.md)

---

## 📋 目录

1. [硬件清单](#1-硬件清单)
2. [引脚定义](#2-引脚定义)
3. [连线方式](#3-连线方式)
4. [硬件验证](#4-硬件验证)
5. [注意事项](#5-注意事项)

---

## 1. 硬件清单

### 1.1 必需硬件

| 序号 | 名称 | 型号/规格 | 数量 | 用途 | 购买链接 |
|-----|------|----------|-----|------|---------|
| 1 | STM32开发板 | 正点原子M48Z-M3 (STM32F103C8T6) | 1 | 主控MCU | [淘宝](https://openedv.taobao.com) |
| 2 | CMSIS-DAP调试器 | 正点原子ATK-CMSIS-DAP | 1 | SWD调试+虚拟串口 | 同上 |
| 3 | RS485模块 | 正点原子ATK-MB024 | 1 | USART2转RS485 | 同上 |
| 4 | USB数据线 | Micro-USB或Type-C | 2 | 供电和通信 | - |
| 5 | 杜邦线 | 公对母 20cm | 10根 | 连接模块 | - |

### 1.2 可选硬件

| 序号 | 名称 | 型号/规格 | 用途 |
|-----|------|----------|------|
| 6 | 步进电机 | 张大头Y系列42步进电机 | 测试RS485通信 |
| 7 | 电源适配器 | 12V/2A | 电机供电 |
| 8 | 逻辑分析仪 | DSLogic/Saleae | 波形分析 |

---

## 2. 引脚定义

### 2.1 STM32F103C8T6引脚分配

| 功能 | STM32引脚 | 连接目标 | 说明 |
|------|----------|---------|------|
| **SWD调试** |
| SWDIO | PA13 | CMSIS-DAP的SWDIO | 数据线 |
| SWCLK | PA14 | CMSIS-DAP的SWCLK | 时钟线 |
| GND | GND | CMSIS-DAP的GND | 共地 |
| 3V3 | 3V3 | CMSIS-DAP的3V3 | 供电（可选） |
| **USART1（调试串口）** |
| TX | PA9 | CMSIS-DAP的RX | 发送到调试器 |
| RX | PA10 | CMSIS-DAP的TX | 接收来自调试器（可选） |
| **USART2（RS485通信）** |
| TX | PA2 | ATK-MB024的TX | 发送到RS485模块 |
| RX | PA3 | ATK-MB024的RX | 接收来自RS485模块 |
| **LED指示灯** |
| LED0 | PC13 | 板载LED | 低电平点亮 |
| **按键输入** |
| KEY0 | PC13 | 板载按键 | 复用LED引脚（使用时需注意） |
| WKUP | PA0 | 唤醒按键 | 高电平有效 |

### 2.2 正点原子ATK-CMSIS-DAP引脚

| CMSIS-DAP接口 | 功能 | 连接到STM32 | 说明 |
|--------------|------|------------|------|
| SWDIO | SWD数据线 | PA13 | 双向数据 |
| SWCLK | SWD时钟线 | PA14 | 时钟信号 |
| GND | 地线 | GND | 必须连接 |
| 3V3 | 3.3V电源 | 3V3 | 可为目标供电 |
| RX | 虚拟串口接收 | PA9 (STM32的TX) | 接收STM32发送的数据 |
| TX | 虚拟串口发送 | PA10 (STM32的RX) | 发送数据到STM32（可选） |
| nRST | 复位信号 | NRST | 可远程复位STM32 |

**重要提示**：
- **CMSIS-DAP的RX指示灯**：当PA9有数据发送时会闪烁，用于验证USART1工作
- **虚拟串口COM5**：CMSIS-DAP自动在电脑上虚拟出一个串口设备

### 2.3 正点原子ATK-MB024 RS485模块引脚

| 模块接口 | 功能 | 连接到STM32 | 说明 |
|---------|------|------------|------|
| TX | UART发送 | PA2 (USART2_TX) | STM32发送数据 |
| RX | UART接收 | PA3 (USART2_RX) | STM32接收数据 |
| VCC | 5V电源 | 5V | 模块供电 |
| GND | 地线 | GND | 共地 |
| **RS485总线端** |
| A+ | RS485 A线 | 连接电机/设备A+ | 差分信号正 |
| B- | RS485 B线 | 连接电机/设备B- | 差分信号负 |

**模块特性**：
- 内置CH340 USB转UART芯片，在电脑上虚拟COM7串口
- 自动收发控制（无需手动切换RE/DE引脚）
- 支持3.3V和5V UART电平

---

## 3. 连线方式

### 3.1 标准连接方式（推荐）

```
电脑USB口
   │
   ├─── CMSIS-DAP (USB Micro)
   │      ├─ SWDIO ──────────┐
   │      ├─ SWCLK ──────────┤
   │      ├─ GND ────────────┤
   │      ├─ 3V3 ────────────┤ (可选供电)
   │      └─ RX ─────────────┤ (接PA9，用于COM5虚拟串口)
   │                          │
   │                     STM32F103C8T6
   │                          ├─ PA13 (SWDIO)
   │                          ├─ PA14 (SWCLK)
   │                          ├─ GND
   │                          ├─ 3V3
   │                          ├─ PA9 (USART1_TX)
   │                          ├─ PA10 (USART1_RX) - 可不连接
   │                          ├─ PA2 (USART2_TX) ──┐
   │                          ├─ PA3 (USART2_RX) ──┤
   │                          ├─ 5V ────────────────┤
   │                          └─ GND ───────────────┤
   │                                                │
   └─── ATK-MB024 RS485模块 (USB Micro)           │
          ├─ TX ────────────────────────────────────┘
          ├─ RX ────────────────────────────────────┘
          ├─ VCC (5V) ──────────────────────────────┘
          ├─ GND ───────────────────────────────────┘
          └─ A+/B- ──> 连接到电机或其他RS485设备
```

### 3.2 详细步骤

#### 步骤1：连接CMSIS-DAP调试器

```
CMSIS-DAP          杜邦线          STM32开发板
SWDIO    ──────────────────────>  PA13
SWCLK    ──────────────────────>  PA14
GND      ──────────────────────>  GND
RX       ──────────────────────>  PA9 (USART1_TX)
```

**连线颜色建议**（方便识别）：
- 红色：3V3/5V电源
- 黑色：GND
- 黄色：SWDIO
- 白色：SWCLK
- 绿色：USART TX
- 蓝色：USART RX

#### 步骤2：连接RS485模块

```
ATK-MB024          杜邦线          STM32开发板
TX       ──────────────────────>  PA2 (USART2_TX)
RX       ──────────────────────>  PA3 (USART2_RX)
VCC (5V) ──────────────────────>  5V
GND      ──────────────────────>  GND
```

#### 步骤3：USB连接

1. **CMSIS-DAP的USB线** → 电脑USB口
   - 电脑识别为：CMSIS-DAP设备 + COM5虚拟串口

2. **ATK-MB024的USB线** → 电脑USB口
   - 电脑识别为：COM7串口设备（CH340驱动）

#### 步骤4：电源检查

- **STM32开发板**：通过CMSIS-DAP 3V3供电，或独立5V供电
- **LED指示灯**：CMSIS-DAP电源指示灯应常亮
- **电流消耗**：约100mA（无电机负载时）

---

### 3.3 可选连接方式

#### 方式A：仅CMSIS-DAP调试（无RS485）

```
CMSIS-DAP ──> STM32
  - SWDIO ──> PA13
  - SWCLK ──> PA14
  - GND ───> GND
  - RX ────> PA9
```

**用途**：仅调试和printf输出，COM5可用

#### 方式B：仅RS485通信（无调试）

```
ATK-MB024 ──> STM32
  - TX ────> PA2
  - RX ────> PA3
  - VCC ───> 5V
  - GND ───> GND
```

**用途**：生产环境，COM7通信，无调试功能

#### 方式C：同时使用ST-Link和RS485

```
ST-Link ──> STM32 (SWD调试)
ATK-MB024 ──> STM32 (RS485通信)
```

**注意**：ST-Link不提供虚拟串口，printf输出需通过独立USB转TTL模块

---

## 4. 硬件验证

### 4.1 连接检查清单

在上电前，请逐项检查：

- [ ] CMSIS-DAP的SWDIO/SWCLK正确连接到PA13/PA14
- [ ] 所有GND线已连接（共地是关键！）
- [ ] USART1的TX (PA9) 连接到CMSIS-DAP的RX
- [ ] USART2的TX/RX (PA2/PA3) 连接到ATK-MB024的RX/TX（**注意交叉**）
- [ ] 电源线无短路（用万用表测量VCC和GND电阻 > 10kΩ）
- [ ] USB线插接牢固，无松动

### 4.2 上电验证

```powershell
# 1. 连接CMSIS-DAP的USB线
#    - 设备管理器应出现：CMSIS-DAP设备 + COM5

# 2. 验证调试器连接
pyocd list
# 输出：
#   #   Probe/Board                   Unique ID       Target
#   0   ALIENTEK ATK-CMSIS-DAP        ATK-20240820    n/a

# 3. 连接ATK-MB024的USB线
#    - 设备管理器应出现：COM7 (CH340)

# 4. 检查串口列表
mode
# 输出应包含：
#   COM5: 波特率...
#   COM7: 波特率...
```

### 4.3 指示灯验证

| 指示灯 | 位置 | 正常状态 | 异常状态 |
|-------|------|---------|---------|
| CMSIS-DAP电源灯 | 调试器上 | 常亮（红色） | 不亮：USB供电异常 |
| CMSIS-DAP RX灯 | 调试器上 | 程序运行时闪烁 | 不闪：PA9无数据 |
| ATK-MB024电源灯 | 模块上 | 常亮（红色） | 不亮：USB供电异常 |
| STM32 LED0 | PC13 | 闪烁（可编程） | 不变化：程序未运行 |

### 4.4 功能测试

**测试1：烧录固件**

```powershell
pyocd flash build/Debug/STM32_485.elf --target stm32f103c8
# 成功标志：
# - 无错误提示
# - 显示 "programmed XX bytes"
# - STM32自动复位运行
```

**测试2：串口输出**

打开串口助手，配置如下：

| 串口 | 波特率 | 数据位 | 停止位 | 校验 |
|-----|-------|-------|-------|------|
| COM5 | 115200 | 8 | 1 | None |
| COM7 | 115200 | 8 | 1 | None |

按STM32复位按钮，应看到：
- **COM5**：系统诊断报告（printf输出）
- **COM7**："UA"字符循环输出

**测试3：调试器连接**

1. 在VS Code中打开 `Core/App/main.c`
2. 在 `while(1)` 循环内设置断点
3. 按 `F5` 启动调试
4. 程序应在断点处暂停

---

## 5. 注意事项

### 5.1 硬件注意事项

⚠️ **电源**
- STM32工作电压：3.3V（CMSIS-DAP可直接供电）
- ATK-MB024工作电压：5V（从USB取电）
- **禁止**将5V直接接入STM32的3.3V引脚

⚠️ **静电防护**
- STM32 IO口耐压：VDD+4V（最高3.3V+4V=7.3V）
- 触摸开发板前，先触摸金属物体释放静电
- 冬季干燥环境尤其注意

⚠️ **连线顺序**
1. **先连接所有杜邦线（断电状态）**
2. **检查无误后，再插USB供电**
3. **拔线时，先拔USB线，再拔杜邦线**

⚠️ **短路检测**
```powershell
# 使用万用表测量（STM32断电状态）
# 1. 测量VCC和GND之间电阻
#    正常：> 10kΩ
#    异常：< 1kΩ（可能短路）

# 2. 测量3.3V和GND之间电阻
#    正常：> 5kΩ
#    异常：< 100Ω（严重短路）
```

### 5.2 接线常见错误

❌ **错误1**：USART2的TX连到RS485模块的TX（应连RX）
- **症状**：COM7无输出或乱码
- **解决**：USART2 TX → RS485 RX，USART2 RX → RS485 TX

❌ **错误2**：忘记连接GND（未共地）
- **症状**：调试器无法识别STM32
- **解决**：所有设备的GND必须连接在一起

❌ **错误3**：RS485的A+/B-接反
- **症状**：电机无响应
- **解决**：A+ to A+，B- to B-（并联连接）

❌ **错误4**：CMSIS-DAP的RX连到STM32的PA10
- **症状**：COM5无输出
- **解决**：CMSIS-DAP RX → STM32 PA9 (TX)

### 5.3 线缆选择建议

| 线缆类型 | 推荐长度 | 用途 | 注意事项 |
|---------|---------|------|---------|
| 杜邦线 | 10-20cm | CMSIS-DAP连接 | 长度过长会引入干扰 |
| USB线 | 50-100cm | 供电和通信 | 使用屏蔽线，避免数据丢失 |
| RS485双绞线 | < 50m | 电机通信 | 长距离需使用屏蔽双绞线 |

### 5.4 环境要求

- **温度**：0°C - 40°C
- **湿度**：20% - 80% RH
- **电压稳定性**：USB供电电压波动 < 5%
- **电磁干扰**：远离大功率电机、变频器、微波炉

---

## 🎯 下一步

硬件连接完成后，继续学习：

- **[03-双串口通信详解](./03-双串口通信详解.md)** - 深入理解USART配置和printf实现
- **[04-时钟系统配置](./04-时钟系统配置.md)** - 学习波特率计算和时钟树

---

**返回**: [00-项目总览](./00-项目总览.md) | **上一篇**: [01-开发环境配置](./01-开发环境配置.md)
