# 03 - åŒä¸²å£é€šä¿¡è¯¦è§£

> **éš¾åº¦**: â­â­â­â˜†â˜†  
> **é¢„è®¡æ—¶é—´**: 45åˆ†é’Ÿ  
> **å‰ç½®è¦æ±‚**: ç†è§£UARTé€šä¿¡åŸç†ï¼Œå®Œæˆç¡¬ä»¶è¿æ¥

---

## ğŸ“‹ ç›®å½•

1. [åŒä¸²å£æ¶æ„è®¾è®¡](#1-åŒä¸²å£æ¶æ„è®¾è®¡)
2. [USART1é…ç½®è¯¦è§£](#2-usart1é…ç½®è¯¦è§£)
3. [USART2é…ç½®è¯¦è§£](#3-usart2é…ç½®è¯¦è§£)
4. [printfé‡å®šå‘åŸç†](#4-printfé‡å®šå‘åŸç†)
5. [å®æˆ˜ç¤ºä¾‹](#5-å®æˆ˜ç¤ºä¾‹)

---

## 1. åŒä¸²å£æ¶æ„è®¾è®¡

### 1.1 è®¾è®¡ç†å¿µ

æœ¬é¡¹ç›®é‡‡ç”¨**åŠŸèƒ½éš”ç¦»**çš„åŒä¸²å£è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STM32F103C8T6 (72MHz)               â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  USART1        â”‚      â”‚  USART2        â”‚ â”‚
â”‚  â”‚  APB2: 72MHz   â”‚      â”‚  APB1: 36MHz   â”‚ â”‚
â”‚  â”‚  BRR: 625      â”‚      â”‚  BRR: 312      â”‚ â”‚
â”‚  â”‚  115200 bps    â”‚      â”‚  115200 bps    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                      â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚
            â”‚ PA9/PA10             â”‚ PA2/PA3
            â†“                      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CMSIS-DAP     â”‚      â”‚ ATK-MB024    â”‚
    â”‚ è™šæ‹Ÿä¸²å£COM5  â”‚      â”‚ RS485æ¨¡å—    â”‚
    â”‚ printfè°ƒè¯•    â”‚      â”‚ ç”µæœºé€šä¿¡     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†å·¥æ˜ç¡®**ï¼š
- **USART1**ï¼šå•å‘è¾“å‡ºï¼ˆTX onlyï¼‰ï¼Œç”¨äº`printf`è°ƒè¯•ä¿¡æ¯
- **USART2**ï¼šåŒå‘é€šä¿¡ï¼ˆTX+RXï¼‰ï¼Œç”¨äºRS485ç”µæœºæ§åˆ¶

**ä¼˜ç‚¹**ï¼š
- è°ƒè¯•ä¿¡æ¯å’Œä¸šåŠ¡æ•°æ®äº’ä¸å¹²æ‰°
- å¯åŒæ—¶ç›‘æ§ä¸¤è·¯æ•°æ®æµ
- æ˜“äºé—®é¢˜å®šä½å’Œæ€§èƒ½åˆ†æ

---

### 1.2 æ—¶é’Ÿåˆ†é…

STM32F103çš„USARTæŒ‚è½½åœ¨ä¸åŒçš„APBæ€»çº¿ä¸Šï¼š

| USART | æ€»çº¿ | æ—¶é’Ÿé¢‘ç‡ | æœ€é«˜æ³¢ç‰¹ç‡ | BRRè®¡ç®—åŸºå‡† |
|-------|------|---------|-----------|------------|
| USART1 | APB2 | 72MHz | 4.5Mbps | `72000000 / baudrate` |
| USART2 | APB1 | 36MHz | 2.25Mbps | `36000000 / baudrate` |
| USART3 | APB1 | 36MHz | 2.25Mbps | `36000000 / baudrate` |

**å…³é”®ä»£ç ** (`Drivers/SYSTEM/sys/sys.c`):
```c
void sys_stm32_clock_init(uint32_t plln)
{
    // HSE 8MHz + PLL Ã—9 = 72MHz SYSCLK
    rcc_osc_init.OscillatorType = RCC_OSCILLATORTYPE_HSE;
    rcc_osc_init.HSEState = RCC_HSE_ON;
    rcc_osc_init.PLL.PLLState = RCC_PLL_ON;
    rcc_osc_init.PLL.PLLMUL = RCC_PLL_MUL9;
    
    // APB1 = HCLK / 2 = 36MHz (USART2/3)
    rcc_clk_init.APB1CLKDivider = RCC_HCLK_DIV2;
    
    // APB2 = HCLK / 1 = 72MHz (USART1)
    rcc_clk_init.APB2CLKDivider = RCC_HCLK_DIV1;
}
```

---

## 2. USART1é…ç½®è¯¦è§£

### 2.1 ç¡¬ä»¶å‚æ•°

**æ–‡ä»¶ä½ç½®**: `Drivers/SYSTEM/usart/usart.h`

```c
/* USART1é…ç½®å®å®šä¹‰ */
#define USART1_TX_GPIO_PORT         GPIOA
#define USART1_TX_GPIO_PIN          GPIO_PIN_9
#define USART1_TX_GPIO_CLK_ENABLE() do{ __HAL_RCC_GPIOA_CLK_ENABLE(); }while(0)

#define USART1_RX_GPIO_PORT         GPIOA
#define USART1_RX_GPIO_PIN          GPIO_PIN_10
#define USART1_RX_GPIO_CLK_ENABLE() do{ __HAL_RCC_GPIOA_CLK_ENABLE(); }while(0)

#define USART1_EN_RX                0  /* 0=ç¦ç”¨æ¥æ”¶ä¸­æ–­, 1=å¯ç”¨æ¥æ”¶ä¸­æ–­ */
```

**å…³é”®è®¾è®¡**ï¼š
- `USART1_EN_RX = 0`ï¼šä»…å‘é€æ¨¡å¼ï¼ŒèŠ‚çœä¸­æ–­èµ„æº
- PA9é…ç½®ä¸º**å¤ç”¨æ¨æŒ½è¾“å‡º**ï¼ˆAF_PPï¼‰
- PA10é…ç½®ä¸º**å¤ç”¨è¾“å…¥**ï¼ˆAF_INPUTï¼‰ï¼Œä½†æœªä½¿ç”¨

---

### 2.2 åˆå§‹åŒ–æµç¨‹

**æ–‡ä»¶ä½ç½®**: `Drivers/SYSTEM/usart/usart.c`

```c
void usart1_init(uint32_t baudrate)
{
    /* é…ç½®USART1å¥æŸ„ */
    g_uart1_handle.Instance = USART1;
    g_uart1_handle.Init.BaudRate = baudrate;        // 115200
    g_uart1_handle.Init.WordLength = UART_WORDLENGTH_8B;  // 8ä½æ•°æ®
    g_uart1_handle.Init.StopBits = UART_STOPBITS_1;       // 1ä½åœæ­¢ä½
    g_uart1_handle.Init.Parity = UART_PARITY_NONE;        // æ— æ ¡éªŒ
    g_uart1_handle.Init.HwFlowCtl = UART_HWCONTROL_NONE;  // æ— ç¡¬ä»¶æµæ§
    g_uart1_handle.Init.Mode = UART_MODE_TX_RX;           // æ”¶å‘æ¨¡å¼
    
    /* HALåº“è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆè°ƒç”¨HAL_UART_MspInité…ç½®GPIOå’Œæ—¶é’Ÿï¼‰ */
    HAL_UART_Init(&g_uart1_handle);
}
```

**HALåº“è‡ªåŠ¨å®Œæˆçš„å·¥ä½œ**ï¼š
1. ä½¿èƒ½USART1æ—¶é’Ÿï¼š`__HAL_RCC_USART1_CLK_ENABLE()`
2. é…ç½®GPIOå¤ç”¨åŠŸèƒ½
3. è®¡ç®—å¹¶è®¾ç½®BRRå¯„å­˜å™¨
4. ä½¿èƒ½USART1å¤–è®¾ï¼š`USART1->CR1 |= USART_CR1_UE`

---

### 2.3 GPIOé…ç½®ï¼ˆMSPå±‚ï¼‰

**æ–‡ä»¶ä½ç½®**: `Drivers/SYSTEM/usart/usart.c`

```c
void HAL_UART_MspInit(UART_HandleTypeDef *huart)
{
    if (huart->Instance == USART1)
    {
        GPIO_InitTypeDef gpio_init_struct;
        
        /* ä½¿èƒ½æ—¶é’Ÿ */
        __HAL_RCC_USART1_CLK_ENABLE();
        __HAL_RCC_GPIOA_CLK_ENABLE();
        
        /* é…ç½®PA9 (TX) - å¤ç”¨æ¨æŒ½è¾“å‡º */
        gpio_init_struct.Pin = GPIO_PIN_9;
        gpio_init_struct.Mode = GPIO_MODE_AF_PP;        // å¤ç”¨æ¨æŒ½
        gpio_init_struct.Pull = GPIO_PULLUP;            // ä¸Šæ‹‰
        gpio_init_struct.Speed = GPIO_SPEED_FREQ_HIGH;  // é«˜é€Ÿ
        HAL_GPIO_Init(GPIOA, &gpio_init_struct);
        
        /* é…ç½®PA10 (RX) - å¤ç”¨è¾“å…¥ï¼ˆæœ¬é¡¹ç›®æœªå¯ç”¨ä¸­æ–­ï¼‰ */
        gpio_init_struct.Pin = GPIO_PIN_10;
        gpio_init_struct.Mode = GPIO_MODE_AF_INPUT;     // å¤ç”¨è¾“å…¥
        HAL_GPIO_Init(GPIOA, &gpio_init_struct);
    }
}
```

**STM32F1çš„GPIOå¤ç”¨è§„åˆ™**ï¼š
- **å¤ç”¨æ¨æŒ½ï¼ˆAF_PPï¼‰**ï¼šç”¨äºUART TXã€SPI MOSI/SCKç­‰è¾“å‡º
- **å¤ç”¨è¾“å…¥ï¼ˆAF_INPUTï¼‰**ï¼šç”¨äºUART RXã€SPI MISOç­‰è¾“å…¥
- **ä¸Šæ‹‰ç”µé˜»**ï¼šé˜²æ­¢æ‚¬ç©ºçŠ¶æ€ä¸‹çš„è¯¯è§¦å‘

---

### 2.4 æ³¢ç‰¹ç‡å¯„å­˜å™¨è®¡ç®—

**BRR (Baud Rate Register) è®¡ç®—å…¬å¼**ï¼š

$$
\text{BRR} = \frac{f_{PCLK}}{\text{baudrate}}
$$

**å¯¹äºUSART1 (APB2 = 72MHz, æ³¢ç‰¹ç‡ = 115200)**ï¼š

$$
\text{BRR} = \frac{72000000}{115200} = 625 = 0x0271
$$

**HALåº“è‡ªåŠ¨è®¡ç®—ä»£ç ** (`stm32f1xx_hal_uart.c`):
```c
uint32_t usartdiv = UART_DIV_SAMPLING16(pclk, huart->Init.BaudRate);
huart->Instance->BRR = (uint16_t)usartdiv;
```

**éªŒè¯BRRå€¼**ï¼š
```c
printf("USART1 BRR = 0x%04X (%lu)\n", USART1->BRR, USART1->BRR);
// è¾“å‡ºï¼šUSART1 BRR = 0x0271 (625)
```

---

## 3. USART2é…ç½®è¯¦è§£

### 3.1 ç¡¬ä»¶å‚æ•°

**æ–‡ä»¶ä½ç½®**: `Drivers/SYSTEM/usart/usart.h`

```c
/* USART2é…ç½®å®å®šä¹‰ */
#define USART2_TX_GPIO_PORT         GPIOA
#define USART2_TX_GPIO_PIN          GPIO_PIN_2
#define USART2_TX_GPIO_CLK_ENABLE() do{ __HAL_RCC_GPIOA_CLK_ENABLE(); }while(0)

#define USART2_RX_GPIO_PORT         GPIOA
#define USART2_RX_GPIO_PIN          GPIO_PIN_3
#define USART2_RX_GPIO_CLK_ENABLE() do{ __HAL_RCC_GPIOA_CLK_ENABLE(); }while(0)

#define USART2_EN_RX                1  /* å¯ç”¨æ¥æ”¶ä¸­æ–­ï¼ˆç”µæœºé€šä¿¡ï¼‰ */
```

**å…³é”®è®¾è®¡**ï¼š
- `USART2_EN_RX = 1`ï¼šå¯ç”¨RXNE + IDLEåŒä¸­æ–­
- ä½¿ç”¨ç¯å½¢FIFOç¼“å†²åŒºæ¥æ”¶å¸§æ•°æ®

---

### 3.2 åˆå§‹åŒ–æµç¨‹

**æ–‡ä»¶ä½ç½®**: `Drivers/SYSTEM/usart/usart.c`

```c
void usart2_init(uint32_t baudrate)
{
    /* é…ç½®USART2å¥æŸ„ */
    g_uart2_handle.Instance = USART2;
    g_uart2_handle.Init.BaudRate = baudrate;
    g_uart2_handle.Init.WordLength = UART_WORDLENGTH_8B;
    g_uart2_handle.Init.StopBits = UART_STOPBITS_1;
    g_uart2_handle.Init.Parity = UART_PARITY_NONE;
    g_uart2_handle.Init.HwFlowCtl = UART_HWCONTROL_NONE;
    g_uart2_handle.Init.Mode = UART_MODE_TX_RX;
    
    /* HALåº“åˆå§‹åŒ– */
    HAL_UART_Init(&g_uart2_handle);

#if USART2_EN_RX
    /* åˆå§‹åŒ–FIFOç¼“å†²åŒº */
    emm_fifo_init();
    
    /* å¼€å¯åŒä¸­æ–­ï¼šRXNEï¼ˆæ¥æ”¶ç¼“å†²åŒºéç©ºï¼‰ + IDLEï¼ˆç©ºé—²çº¿è·¯æ£€æµ‹ï¼‰ */
    __HAL_UART_ENABLE_IT(&g_uart2_handle, UART_IT_RXNE);
    __HAL_UART_ENABLE_IT(&g_uart2_handle, UART_IT_IDLE);
#endif
}
```

---

### 3.3 IDLEä¸­æ–­å¸§æ£€æµ‹æœºåˆ¶

**è®¾è®¡æ€è·¯**ï¼š
- RS485é€šä¿¡çš„å¸§é•¿åº¦ä¸å›ºå®šï¼ˆ4-10å­—èŠ‚ï¼‰
- ä½¿ç”¨IDLEä¸­æ–­æ£€æµ‹å¸§è¾¹ç•Œï¼ˆæ€»çº¿ç©ºé—²è¶…è¿‡1å­—èŠ‚æ—¶é—´ï¼‰

**ä¸­æ–­æœåŠ¡å‡½æ•°** (`Drivers/SYSTEM/usart/usart.c`):
```c
void USART2_IRQHandler(void)
{
    uint32_t isrflags = READ_REG(USART2->SR);
    uint8_t data;
    
    /* RXNEä¸­æ–­ï¼šæ¥æ”¶åˆ°1å­—èŠ‚æ•°æ® */
    if (isrflags & USART_SR_RXNE)
    {
        data = (uint8_t)READ_REG(USART2->DR);  // è¯»å–æ•°æ®
        emm_fifo_write(data);                   // å†™å…¥FIFO
    }
    
    /* IDLEä¸­æ–­ï¼šæ€»çº¿ç©ºé—²ï¼Œä¸€å¸§æ•°æ®æ¥æ”¶å®Œæˆ */
    if (isrflags & USART_SR_IDLE)
    {
        __HAL_UART_CLEAR_IDLEFLAG(&g_uart2_handle);  // æ¸…é™¤æ ‡å¿—
        
        /* ä»FIFOè¯»å–å®Œæ•´å¸§æ•°æ® */
        g_emm_rx_count = emm_fifo_read(g_emm_rx_cmd, sizeof(g_emm_rx_cmd));
        g_emm_frame_complete = 1;  // è®¾ç½®å¸§å®Œæˆæ ‡å¿—
    }
}
```

**å·¥ä½œæµç¨‹**ï¼š
```
ç”µæœºå‘é€æ•°æ®
   â†“
RXNEä¸­æ–­ï¼ˆå­—èŠ‚1ï¼‰ â†’ å†™å…¥FIFO
RXNEä¸­æ–­ï¼ˆå­—èŠ‚2ï¼‰ â†’ å†™å…¥FIFO
RXNEä¸­æ–­ï¼ˆå­—èŠ‚3ï¼‰ â†’ å†™å…¥FIFO
   ...
æ€»çº¿ç©ºé—² > 1å­—èŠ‚æ—¶é—´
   â†“
IDLEä¸­æ–­ â†’ ä»FIFOè¯»å–å®Œæ•´å¸§ â†’ è®¾ç½®g_emm_frame_completeæ ‡å¿—
   â†“
ä¸»å¾ªç¯æ£€æµ‹åˆ°æ ‡å¿—ï¼Œè§£æå¸§æ•°æ®
```

---

### 3.4 FIFOç¯å½¢ç¼“å†²åŒº

**æ–‡ä»¶ä½ç½®**: `Drivers/BSP/EMM_V5/emm_fifo.c`

```c
#define EMM_FIFO_SIZE  256  // 2çš„å¹‚æ¬¡ï¼Œä¾¿äºä½è¿ç®—ä¼˜åŒ–

typedef struct {
    uint8_t buffer[EMM_FIFO_SIZE];
    volatile uint16_t write_index;
    volatile uint16_t read_index;
} emm_fifo_t;

static emm_fifo_t g_emm_fifo;

/* å†™å…¥1å­—èŠ‚ï¼ˆRXNEä¸­æ–­è°ƒç”¨ï¼‰ */
void emm_fifo_write(uint8_t data)
{
    uint16_t next_index = (g_emm_fifo.write_index + 1) & (EMM_FIFO_SIZE - 1);
    
    if (next_index != g_emm_fifo.read_index)  // æ£€æŸ¥ç¼“å†²åŒºæœªæ»¡
    {
        g_emm_fifo.buffer[g_emm_fifo.write_index] = data;
        g_emm_fifo.write_index = next_index;
    }
}

/* è¯»å–å¤šå­—èŠ‚ï¼ˆIDLEä¸­æ–­è°ƒç”¨ï¼‰ */
uint16_t emm_fifo_read(uint8_t *data, uint16_t len)
{
    uint16_t count = 0;
    
    while (g_emm_fifo.read_index != g_emm_fifo.write_index && count < len)
    {
        data[count++] = g_emm_fifo.buffer[g_emm_fifo.read_index];
        g_emm_fifo.read_index = (g_emm_fifo.read_index + 1) & (EMM_FIFO_SIZE - 1);
    }
    
    return count;
}
```

**ä¼˜ç‚¹**ï¼š
- ä½è¿ç®—å–æ¨¡ï¼ˆ`& (EMM_FIFO_SIZE - 1)`ï¼‰æ¯” `% EMM_FIFO_SIZE` å¿«5å€
- æ— éœ€ç¦ç”¨ä¸­æ–­ï¼Œè¯»å†™åˆ†ç¦»è®¾è®¡
- è‡ªåŠ¨ä¸¢å¼ƒæº¢å‡ºæ•°æ®ï¼ˆoldest data policyï¼‰

---

## 4. printfé‡å®šå‘åŸç†

### 4.1 GCCå·¥å…·é“¾çš„printfå®ç°

**è°ƒç”¨é“¾**ï¼š
```
printf("Hello %d", 123)
   â†“
vprintf() [Newlib Cåº“]
   â†“
_write(1, buffer, len) [syscalls.c]
   â†“
__io_putchar(buffer[i]) [usart.c]
   â†“
USART1->DR = ch [ç¡¬ä»¶å¯„å­˜å™¨]
   â†“
PA9å¼•è„šè¾“å‡ºä¸²è¡Œæ•°æ®
```

### 4.2 å…³é”®ä»£ç å®ç°

#### æ­¥éª¤1ï¼šå®ç°`__io_putchar`å‡½æ•°

**æ–‡ä»¶ä½ç½®**: `Drivers/SYSTEM/usart/usart.c`

```c
/* GCCå·¥å…·é“¾éœ€è¦å®ç°__io_putcharï¼ˆsyscalls.cä¸­çš„_writeä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼‰ */
int __io_putchar(int ch)
{
    /* ä½¿ç”¨USART1ä½œä¸ºprintfè¾“å‡ºï¼ˆCOM5 CMSIS-DAPè™šæ‹Ÿä¸²å£ï¼‰ */
    while ((USART1->SR & USART_SR_TXE) == 0);  /* ç­‰å¾…TXEæ ‡å¿—ï¼ˆå‘é€ç¼“å†²åŒºç©ºï¼‰ */
    USART1->DR = (uint8_t)ch;
    
    return ch;
}

/* å…¼å®¹MDKç¼–è¯‘å™¨ï¼ˆå¯é€‰ï¼‰ */
int fputc(int ch, FILE *f)
{
    (void)f;
    while ((USART1->SR & USART_SR_TXE) == 0);
    USART1->DR = (uint8_t)ch;
    return ch;
}
```

**å…³é”®å¯„å­˜å™¨**ï¼š
- `USART1->SR`ï¼šçŠ¶æ€å¯„å­˜å™¨
  - `USART_SR_TXE` (bit 7)ï¼šå‘é€æ•°æ®å¯„å­˜å™¨ç©ºæ ‡å¿—
    - 0 = æ•°æ®æœªä¼ è¾“åˆ°ç§»ä½å¯„å­˜å™¨
    - 1 = æ•°æ®å·²ä¼ è¾“ï¼Œå¯å†™å…¥æ–°æ•°æ®
- `USART1->DR`ï¼šæ•°æ®å¯„å­˜å™¨ï¼ˆè¯»å†™å…±ç”¨ï¼‰

#### æ­¥éª¤2ï¼šsyscalls.cä¸­çš„_writeå‡½æ•°

**æ–‡ä»¶ä½ç½®**: `Core/Src/syscalls.c`

```c
/* å£°æ˜å¼±ç¬¦å·ï¼ˆå…è®¸ç”¨æˆ·é‡å†™ï¼‰ */
extern int __io_putchar(int ch) __attribute__((weak));

/* printfæœ€ç»ˆè°ƒç”¨æ­¤å‡½æ•° */
__attribute__((weak)) int _write(int file, char *ptr, int len)
{
    (void)file;
    int DataIdx;

    for (DataIdx = 0; DataIdx < len; DataIdx++)
    {
        __io_putchar(*ptr++);  // é€å­—èŠ‚è¾“å‡º
    }
    return len;
}
```

---

### 4.3 MDK vs GCCçš„å·®å¼‚

| ç‰¹æ€§ | Keil MDK | GCC (Newlib) |
|------|----------|--------------|
| **Cåº“** | ARM Cåº“ (ARMCC) | Newlib Cåº“ |
| **printfåº•å±‚å‡½æ•°** | `fputc()` | `__io_putchar()` |
| **åŠä¸»æœºæ¨¡å¼** | é»˜è®¤å¯ç”¨ | é»˜è®¤ç¦ç”¨ |
| **FILEç»“æ„ä½“** | éœ€è¦å®šä¹‰ | å¯é€‰ |
| **ç³»ç»Ÿè°ƒç”¨** | æ— éœ€syscalls.c | éœ€è¦syscalls.c |

**æœ¬é¡¹ç›®åŒæ—¶å®ç°äº†ä¸¤è€…**ï¼Œç¡®ä¿è·¨ç¼–è¯‘å™¨å…¼å®¹ï¼š
```c
int fputc(int ch, FILE *f);        // MDKä½¿ç”¨
int __io_putchar(int ch);           // GCCä½¿ç”¨
```

---

### 4.4 æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**ï¼šprintfåœ¨ä¸­æ–­ä¸­ä½¿ç”¨å¯èƒ½å¯¼è‡´é˜»å¡

**è§£å†³æ–¹æ¡ˆ1**ï¼šä½¿ç”¨DMAå‘é€ï¼ˆé«˜çº§ï¼‰
```c
// å¾…å®ç°ï¼šä½¿ç”¨DMA + ç¯å½¢ç¼“å†²åŒº
HAL_UART_Transmit_DMA(&g_uart1_handle, buffer, len);
```

**è§£å†³æ–¹æ¡ˆ2**ï¼šç¼©çŸ­è¾“å‡ºå†…å®¹
```c
// âŒ ä¸æ¨èï¼šåœ¨ä¸­æ–­ä¸­ä½¿ç”¨å†—é•¿çš„printf
void TIM2_IRQHandler(void)
{
    printf("Timer interrupt at %lu ms with data=%d\n", HAL_GetTick(), sensor_data);
}

// âœ… æ¨èï¼šç®€åŒ–è¾“å‡ºæˆ–ä½¿ç”¨æ ‡å¿—ä½
void TIM2_IRQHandler(void)
{
    g_timer_flag = 1;  // ä¸»å¾ªç¯å¤„ç†
}
```

---

## 5. å®æˆ˜ç¤ºä¾‹

### 5.1 åŸºç¡€è¾“å‡ºæµ‹è¯•

**æ–‡ä»¶ä½ç½®**: `Core/App/main.c`

```c
int main(void)
{
    HAL_Init();
    sys_stm32_clock_init(RCC_PLL_MUL9);
    delay_init(72);
    
    usart1_init(115200);  // åˆå§‹åŒ–printfè¾“å‡º
    usart2_init(115200);  // åˆå§‹åŒ–RS485é€šä¿¡
    
    /* æµ‹è¯•1ï¼šåŸºç¡€printf */
    printf("\r\n=== System Startup ===\r\n");
    printf("Clock: %lu Hz\r\n", SystemCoreClock);
    
    /* æµ‹è¯•2ï¼šæ ¼å¼åŒ–è¾“å‡º */
    uint32_t voltage = 3300;  // mV
    printf("VDD = %lu.%03lu V\r\n", voltage / 1000, voltage % 1000);
    // è¾“å‡ºï¼šVDD = 3.300 V
    
    /* æµ‹è¯•3ï¼šæµ®ç‚¹æ•°è¾“å‡ºï¼ˆéœ€å¯ç”¨-u _printf_floaté“¾æ¥é€‰é¡¹ï¼‰ */
    float temperature = 25.6f;
    printf("Temperature = %.1f C\r\n", temperature);
    // è¾“å‡ºï¼šTemperature = 25.6 C
    
    while (1)
    {
        HAL_Delay(1000);
        printf("Tick: %lu\r\n", HAL_GetTick());
    }
}
```

---

### 5.2 RS485åŒå‘é€šä¿¡ç¤ºä¾‹

```c
/* å‘é€å‘½ä»¤åˆ°ç”µæœº */
void motor_send_command(uint8_t addr, uint8_t cmd, uint8_t *data, uint8_t len)
{
    uint8_t frame[32];
    frame[0] = addr;
    frame[1] = cmd;
    memcpy(&frame[2], data, len);
    
    /* é€šè¿‡USART2å‘é€ */
    HAL_UART_Transmit(&g_uart2_handle, frame, len + 2, 100);
}

/* ä¸»å¾ªç¯å¤„ç†æ¥æ”¶åˆ°çš„å“åº” */
while (1)
{
    if (g_emm_frame_complete)
    {
        g_emm_frame_complete = 0;
        
        /* è§£æå¸§æ•°æ® */
        printf("[RX] Addr=0x%02X, Cmd=0x%02X, Len=%d\r\n",
               g_emm_rx_cmd[0], g_emm_rx_cmd[1], g_emm_rx_count);
        
        /* ä¸šåŠ¡é€»è¾‘å¤„ç†... */
    }
}
```

---

### 5.3 è°ƒè¯•æŠ€å·§

**æŠ€å·§1ï¼šä½¿ç”¨æ¡ä»¶ç¼–è¯‘æ§åˆ¶è°ƒè¯•è¾“å‡º**

```c
#define DEBUG_LEVEL  2  // 0=å…³é—­, 1=é”™è¯¯, 2=è­¦å‘Š, 3=ä¿¡æ¯

#if DEBUG_LEVEL >= 3
    #define DEBUG_INFO(fmt, ...)  printf("[INFO] " fmt, ##__VA_ARGS__)
#else
    #define DEBUG_INFO(fmt, ...)
#endif

#if DEBUG_LEVEL >= 2
    #define DEBUG_WARN(fmt, ...)  printf("[WARN] " fmt, ##__VA_ARGS__)
#else
    #define DEBUG_WARN(fmt, ...)
#endif

// ä½¿ç”¨ç¤ºä¾‹
DEBUG_INFO("Motor speed set to %d RPM\r\n", speed);
DEBUG_WARN("Low voltage detected: %lu mV\r\n", voltage);
```

**æŠ€å·§2ï¼šæ—¶é—´æˆ³è¾“å‡º**

```c
void debug_printf(const char *fmt, ...)
{
    printf("[%06lu] ", HAL_GetTick());  // æ¯«ç§’æ—¶é—´æˆ³
    
    va_list args;
    va_start(args, fmt);
    vprintf(fmt, args);
    va_end(args);
}

// è¾“å‡ºç¤ºä¾‹ï¼š[001234] Motor enabled
```

**æŠ€å·§3ï¼šåå…­è¿›åˆ¶dump**

```c
void hex_dump(const uint8_t *data, uint16_t len)
{
    printf("Hex Dump (%d bytes):\r\n", len);
    for (uint16_t i = 0; i < len; i++)
    {
        printf("%02X ", data[i]);
        if ((i + 1) % 16 == 0) printf("\r\n");
    }
    if (len % 16 != 0) printf("\r\n");
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ·±å…¥ç†è§£åŒä¸²å£é€šä¿¡åï¼Œç»§ç»­å­¦ä¹ ï¼š

- **[04-æ—¶é’Ÿç³»ç»Ÿé…ç½®](./04-æ—¶é’Ÿç³»ç»Ÿé…ç½®.md)** - æŒæ¡BRRè®¡ç®—å’Œæ³¢ç‰¹ç‡è¯¯å·®åˆ†æ
- **[06-è°ƒè¯•æŠ€å·§ä¸é—®é¢˜æ’æŸ¥](./06-è°ƒè¯•æŠ€å·§ä¸é—®é¢˜æ’æŸ¥.md)** - å¸¸è§ä¸²å£é—®é¢˜è§£å†³

---

**è¿”å›**: [00-é¡¹ç›®æ€»è§ˆ](./00-é¡¹ç›®æ€»è§ˆ.md) | **ä¸Šä¸€ç¯‡**: [02-ç¡¬ä»¶è¿æ¥æŒ‡å—](./02-ç¡¬ä»¶è¿æ¥æŒ‡å—.md)
