# 06 - è°ƒè¯•æŠ€å·§ä¸é—®é¢˜æ’æŸ¥å®Œæ•´æŒ‡å—

> **éš¾åº¦**: â­â­â­â­â˜†  
> **é¢„è®¡æ—¶é—´**: 90åˆ†é’Ÿ  
> **å‰ç½®è¦æ±‚**: å®Œæˆå‰5ç« å­¦ä¹ ï¼Œäº†è§£åŸºæœ¬çš„GDBè°ƒè¯•å‘½ä»¤

---

## ğŸ“‹ ç›®å½•

1. [VS Codeè°ƒè¯•é…ç½®](#1-vs-codeè°ƒè¯•é…ç½®)
2. [PyOCDè°ƒè¯•å®æˆ˜](#2-pyocdè°ƒè¯•å®æˆ˜)
3. [å¸¸è§é—®é¢˜æ’æŸ¥](#3-å¸¸è§é—®é¢˜æ’æŸ¥)
4. [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](#4-æ€§èƒ½åˆ†æä¸ä¼˜åŒ–)
5. [å†å²è°ƒè¯•æ¡ˆä¾‹](#5-å†å²è°ƒè¯•æ¡ˆä¾‹)

---

## 1. VS Codeè°ƒè¯•é…ç½®

### 1.1 launch.jsonå®Œæ•´é…ç½®

**æ–‡ä»¶ä½ç½®**: `.vscode/launch.json`

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "CMSIS-DAP Debug (PyOCD)",
            "type": "cortex-debug",
            "request": "launch",
            "cwd": "${workspaceFolder}",
            "executable": "${workspaceFolder}/build/Debug/STM32_485.elf",
            "servertype": "pyocd",
            "device": "stm32f103c8",
            "serverArgs": [
                "--target", "stm32f103c8",
                "--frequency", "4000000",
                "--no-wait"
            ],
            "runToEntryPoint": "main",
            "showDevDebugOutput": "parsed",
            "svdFile": "${workspaceFolder}/STM32F103.svd",
            "preLaunchTask": "Build Debug (STM32_485)"
        },
        {
            "name": "ST-Link Debug (Official)",
            "type": "cortex-debug",
            "request": "launch",
            "cwd": "${workspaceFolder}",
            "executable": "${workspaceFolder}/build/Debug/STM32_485.elf",
            "servertype": "stlink",
            "device": "STM32F103C8",
            "interface": "swd",
            "serialNumber": "",
            "runToEntryPoint": "main",
            "svdFile": "${workspaceFolder}/STM32F103.svd"
        }
    ]
}
```

**å…³é”®å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | ä½œç”¨ | å¸¸è§å€¼ |
|------|------|--------|
| `servertype` | è°ƒè¯•å™¨ç±»å‹ | `pyocd`, `stlink`, `jlink`, `openocd` |
| `device` | ç›®æ ‡èŠ¯ç‰‡ | `stm32f103c8` |
| `frequency` | SWDæ—¶é’Ÿé¢‘ç‡ | `4000000` (4MHz, ç¨³å®š) / `8000000` (8MHz, æ›´å¿«) |
| `runToEntryPoint` | è¿è¡Œåˆ°å…¥å£ç‚¹ | `main`, `Reset_Handler` |
| `showDevDebugOutput` | è°ƒè¯•è¾“å‡ºçº§åˆ« | `none`, `parsed`, `raw`, `vscode` |
| `svdFile` | å¤–è®¾å¯„å­˜å™¨å®šä¹‰ | SVDæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œæä¾›å¯„å­˜å™¨æŸ¥çœ‹ï¼‰ |

---

### 1.2 è°ƒè¯•æ§åˆ¶å¿«æ·é”®

| å¿«æ·é”® | åŠŸèƒ½ | è¯´æ˜ |
|--------|------|------|
| `F5` | å¯åŠ¨è°ƒè¯•/ç»§ç»­ | ä»å½“å‰ä½ç½®ç»§ç»­æ‰§è¡Œ |
| `Shift+F5` | åœæ­¢è°ƒè¯• | ç»ˆæ­¢è°ƒè¯•ä¼šè¯ |
| `Ctrl+Shift+F5` | é‡å¯è°ƒè¯• | é‡æ–°çƒ§å½•å¹¶å¤ä½ |
| `F9` | åˆ‡æ¢æ–­ç‚¹ | åœ¨å½“å‰è¡Œè®¾ç½®/å–æ¶ˆæ–­ç‚¹ |
| `F10` | å•æ­¥è·³è¿‡ | æ‰§è¡Œå½“å‰è¡Œï¼Œä¸è¿›å…¥å‡½æ•° |
| `F11` | å•æ­¥è¿›å…¥ | è¿›å…¥å‡½æ•°å†…éƒ¨ |
| `Shift+F11` | è·³å‡ºå‡½æ•° | æ‰§è¡Œå®Œå½“å‰å‡½æ•° |
| `Ctrl+F10` | è¿è¡Œåˆ°å…‰æ ‡ | æ‰§è¡Œåˆ°å…‰æ ‡æ‰€åœ¨è¡Œ |

---

### 1.3 æ–­ç‚¹ç±»å‹

#### æ™®é€šæ–­ç‚¹

```c
int main(void)
{
    HAL_Init();                    // åœ¨æ­¤è¡ŒæŒ‰F9è®¾ç½®æ–­ç‚¹
    sys_stm32_clock_init(RCC_PLL_MUL9);
    delay_init(72);
    
    usart1_init(115200);           // ç¨‹åºä¼šåœ¨æ­¤æš‚åœ
    usart2_init(115200);
}
```

#### æ¡ä»¶æ–­ç‚¹

å³é”®æ–­ç‚¹ â†’ "Edit Breakpoint" â†’ è¾“å…¥æ¡ä»¶ï¼š

```c
while (1)
{
    counter++;                     // å³é”®è®¾ç½®æ¡ä»¶æ–­ç‚¹
    HAL_Delay(100);                // æ¡ä»¶: counter > 100
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¾ªç¯ä¸­çš„ç‰¹å®šè¿­ä»£
- ç‰¹å®šå˜é‡å€¼è§¦å‘
- é”™è¯¯çŠ¶æ€æ•è·

#### æ—¥å¿—æ–­ç‚¹ï¼ˆLogpointï¼‰

å³é”® â†’ "Add Logpoint" â†’ è¾“å…¥æ¶ˆæ¯ï¼š

```c
void motor_control(uint8_t speed)
{
    // Logpoint: "Speed set to {speed}"
    g_motor_speed = speed;         // ä¸æš‚åœï¼Œä»…è¾“å‡ºæ—¥å¿—
}
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
Logpoint: Speed set to 150
Logpoint: Speed set to 200
```

---

### 1.4 å˜é‡ç›‘è§†

#### æ–¹å¼1ï¼šæ‚¬åœæŸ¥çœ‹

é¼ æ ‡æ‚¬åœåœ¨å˜é‡ä¸Šï¼Œè‡ªåŠ¨æ˜¾ç¤ºå€¼ï¼š

```c
uint32_t voltage = 3300;           // é¼ æ ‡æ‚¬åœæ˜¾ç¤º: voltage = 3300
float temp = 25.6f;                // æ˜¾ç¤º: temp = 25.6000004
```

#### æ–¹å¼2ï¼šç›‘è§†çª—å£

Debugä¾§è¾¹æ  â†’ "WATCH" â†’ æ·»åŠ è¡¨è¾¾å¼ï¼š

```c
// ç›‘è§†è¡¨è¾¾å¼ç¤ºä¾‹
SystemCoreClock                    // 72000000
HAL_GetTick()                      // å®æ—¶æ›´æ–°æ—¶é—´æˆ³
g_uart1_handle.Instance->SR        // æŸ¥çœ‹USART1çŠ¶æ€å¯„å­˜å™¨
GPIOC->ODR & GPIO_PIN_13           // æŸ¥çœ‹PC13å¼•è„šçŠ¶æ€
```

#### æ–¹å¼3ï¼šè°ƒè¯•æ§åˆ¶å°

è°ƒè¯•æ—¶æŒ‰ `` Ctrl+` `` æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥GDBå‘½ä»¤ï¼š

```gdb
# æ‰“å°å˜é‡
print SystemCoreClock
# è¾“å‡º: $1 = 72000000

# æ‰“å°åå…­è¿›åˆ¶
print/x USART1->SR
# è¾“å‡º: $2 = 0xc0

# æ‰“å°äºŒè¿›åˆ¶
print/t GPIOC->IDR
# è¾“å‡º: $3 = 10011111111111111111

# ä¿®æ”¹å˜é‡
set variable g_motor_speed = 200

# æŸ¥çœ‹å†…å­˜
x/16xb 0x20000000
# è¾“å‡º: 0x20000000:  0x00 0x50 0x00 0x20 0x31 0x00 0x00 0x08 ...
```

---

### 1.5 å¤–è®¾å¯„å­˜å™¨æŸ¥çœ‹ï¼ˆSVDï¼‰

**ä¸‹è½½STM32F103 SVDæ–‡ä»¶**ï¼š

```powershell
# ä¸‹è½½åœ°å€
https://github.com/posborne/cmsis-svd/blob/master/data/STMicro/STM32F103xx.svd

# ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•
STM32_485/STM32F103.svd
```

**æŸ¥çœ‹å¯„å­˜å™¨**ï¼š

Debugä¾§è¾¹æ  â†’ "CORTEX PERIPHERALS" â†’ å±•å¼€å¤–è®¾ï¼š

```
USART1
â”œâ”€ SR (Status Register)     = 0x00C0
â”‚  â”œâ”€ TXE (Transmit Empty)  = 1
â”‚  â”œâ”€ TC (Transfer Complete) = 1
â”‚  â””â”€ RXNE (Receive Not Empty) = 0
â”œâ”€ DR (Data Register)        = 0x0000
â”œâ”€ BRR (Baud Rate Register)  = 0x0271 (625)
â””â”€ CR1 (Control Register 1)  = 0x200C
   â”œâ”€ UE (USART Enable)      = 1
   â”œâ”€ TE (Transmit Enable)   = 1
   â””â”€ RE (Receive Enable)    = 1
```

---

## 2. PyOCDè°ƒè¯•å®æˆ˜

### 2.1 PyOCDå‘½ä»¤è¡Œå·¥å…·

#### åŸºç¡€å‘½ä»¤

```powershell
# åˆ—å‡ºæ‰€æœ‰è¿æ¥çš„è°ƒè¯•å™¨
pyocd list
# è¾“å‡ºï¼š
#   #   Probe/Board                   Unique ID       Target
#   0   ALIENTEK ATK-CMSIS-DAP        ATK-20240820    n/a

# æŸ¥çœ‹æ”¯æŒçš„ç›®æ ‡èŠ¯ç‰‡
pyocd pack show

# å¯åŠ¨GDBæœåŠ¡å™¨ï¼ˆæ‰‹åŠ¨è°ƒè¯•ï¼‰
pyocd gdbserver --target stm32f103c8 --frequency 4000000
# GDBæœåŠ¡å™¨ç›‘å¬ç«¯å£: localhost:3333

# çƒ§å½•å›ºä»¶
pyocd flash build/Debug/STM32_485.elf --target stm32f103c8

# æ“¦é™¤èŠ¯ç‰‡
pyocd erase --chip --target stm32f103c8

# è¯»å–å†…å­˜
pyocd commander --target stm32f103c8
>>> read8 0x08000000 256              # è¯»å–Flashå‰256å­—èŠ‚
>>> read32 0x20000000 64              # è¯»å–RAMå‰64ä¸ªå­—(256å­—èŠ‚)
```

---

### 2.2 GDBå‘½ä»¤è¡Œè°ƒè¯•

**å¯åŠ¨GDBè¿æ¥**ï¼š

```powershell
# ç»ˆç«¯1ï¼šå¯åŠ¨PyOCDæœåŠ¡å™¨
pyocd gdbserver --target stm32f103c8 --frequency 4000000

# ç»ˆç«¯2ï¼šå¯åŠ¨GDBå®¢æˆ·ç«¯
arm-none-eabi-gdb build/Debug/STM32_485.elf

# GDBæç¤ºç¬¦ä¸‹è¿æ¥
(gdb) target remote localhost:3333
(gdb) monitor reset halt
(gdb) load
(gdb) continue
```

**å¸¸ç”¨GDBå‘½ä»¤**ï¼š

```gdb
# ===== ç¨‹åºæ§åˆ¶ =====
run                     # è¿è¡Œç¨‹åº
continue (c)            # ç»§ç»­æ‰§è¡Œ
step (s)                # å•æ­¥è¿›å…¥
next (n)                # å•æ­¥è·³è¿‡
finish                  # æ‰§è¡Œå®Œå½“å‰å‡½æ•°
until                   # æ‰§è¡Œåˆ°æŒ‡å®šè¡Œ

# ===== æ–­ç‚¹ç®¡ç† =====
break main              # åœ¨mainå‡½æ•°è®¾ç½®æ–­ç‚¹
break usart.c:150       # åœ¨usart.cç¬¬150è¡Œè®¾ç½®æ–­ç‚¹
break *0x08000400       # åœ¨åœ°å€0x08000400è®¾ç½®æ–­ç‚¹
info breakpoints        # æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹
delete 1                # åˆ é™¤æ–­ç‚¹1
clear main              # æ¸…é™¤mainå‡½æ•°çš„æ–­ç‚¹

# ===== å˜é‡æŸ¥çœ‹ =====
print variable          # æ‰“å°å˜é‡
print/x variable        # åå…­è¿›åˆ¶æ‰“å°
print/t variable        # äºŒè¿›åˆ¶æ‰“å°
display variable        # æ¯æ¬¡åœæ­¢æ—¶è‡ªåŠ¨æ˜¾ç¤º
info locals             # æŸ¥çœ‹å±€éƒ¨å˜é‡
info args               # æŸ¥çœ‹å‡½æ•°å‚æ•°

# ===== å†…å­˜æ“ä½œ =====
x/16xb 0x20000000       # æŸ¥çœ‹å†…å­˜ï¼ˆ16å­—èŠ‚ï¼Œåå…­è¿›åˆ¶ï¼‰
set {int}0x20000000 = 123  # ä¿®æ”¹å†…å­˜
dump binary memory dump.bin 0x08000000 0x08010000  # å¯¼å‡ºFlash

# ===== å¯„å­˜å™¨æŸ¥çœ‹ =====
info registers          # æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨
info registers r0 r1    # æŸ¥çœ‹R0ã€R1å¯„å­˜å™¨
set $r0 = 0x12345678    # ä¿®æ”¹R0å¯„å­˜å™¨

# ===== è°ƒç”¨æ ˆ =====
backtrace (bt)          # æŸ¥çœ‹è°ƒç”¨æ ˆ
frame 2                 # åˆ‡æ¢åˆ°æ ˆå¸§2
info frame              # æŸ¥çœ‹å½“å‰æ ˆå¸§ä¿¡æ¯

# ===== PyOCDç‰¹æœ‰å‘½ä»¤ =====
monitor reset           # å¤ä½MCU
monitor halt            # æš‚åœMCU
monitor reg             # æŸ¥çœ‹å¯„å­˜å™¨
monitor help            # æŸ¥çœ‹æ‰€æœ‰monitorå‘½ä»¤
```

---

### 2.3 å®æˆ˜æ¡ˆä¾‹ï¼šæŸ¥æ‰¾æ­»å¾ªç¯

**é—®é¢˜**ï¼šç¨‹åºå¯åŠ¨åæ— å“åº”ï¼ŒLEDä¸é—ªçƒ

**è°ƒè¯•æ­¥éª¤**ï¼š

```gdb
# 1. è¿æ¥å¹¶æš‚åœç¨‹åº
(gdb) target remote localhost:3333
(gdb) monitor halt

# 2. æŸ¥çœ‹å½“å‰PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰
(gdb) info registers pc
pc             0x800142a    0x800142a <HardFault_Handler+6>

# å‘ç°ï¼šç¨‹åºå¡åœ¨HardFault_Handlerï¼

# 3. æŸ¥çœ‹è°ƒç”¨æ ˆ
(gdb) backtrace
#0  0x0800142a in HardFault_Handler () at Core/Src/stm32f1xx_it.c:72
#1  <signal handler called>
#2  0x080002e8 in sys_stm32_clock_init (plln=9) at Drivers/SYSTEM/sys/sys.c:128
#3  0x08000156 in main () at Core/App/main.c:35

# å‘ç°ï¼šsys_stm32_clock_initè°ƒç”¨åè§¦å‘HardFault

# 4. è·³è½¬åˆ°å‡ºé”™çš„æ ˆå¸§
(gdb) frame 2
(gdb) list
123         ret = HAL_RCC_OscConfig(&rcc_osc_init);
124         if (ret != HAL_OK)
125         {
126             while (1);  // â† å¯èƒ½å¡åœ¨è¿™é‡Œ
127         }

# 5. æŸ¥çœ‹retå€¼
(gdb) print ret
$1 = 1 (HAL_ERROR)

# ç»“è®ºï¼šHSEå¯åŠ¨å¤±è´¥ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼šå‚è€ƒ [04-æ—¶é’Ÿç³»ç»Ÿé…ç½®](./04-æ—¶é’Ÿç³»ç»Ÿé…ç½®.md#41-hseå¯åŠ¨å¤±è´¥)

---

## 3. å¸¸è§é—®é¢˜æ’æŸ¥

### 3.1 ç¼–è¯‘é—®é¢˜

#### é—®é¢˜1ï¼šæ‰¾ä¸åˆ°å¤´æ–‡ä»¶

```
fatal error: delay.h: No such file or directory
   42 | #include "delay.h"
      |          ^~~~~~~~~
```

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨**ï¼š
   ```powershell
   Test-Path Drivers/SYSTEM/delay/delay.h
   # è¾“å‡º: True â†’ æ–‡ä»¶å­˜åœ¨
   ```

2. **æ£€æŸ¥CMakeLists.txt**ï¼š
   ```cmake
   target_include_directories(${CMAKE_PROJECT_NAME} PRIVATE
       Drivers/SYSTEM/delay  # â† æ˜¯å¦åŒ…å«æ­¤è¡Œï¼Ÿ
   )
   ```

3. **é‡æ–°é…ç½®CMake**ï¼š
   ```powershell
   Remove-Item -Recurse build
   cmake --preset Debug
   ```

---

#### é—®é¢˜2ï¼šé“¾æ¥é”™è¯¯ï¼ˆundefined referenceï¼‰

```
undefined reference to `delay_ms'
```

**åŸå› **ï¼šå£°æ˜äº†å‡½æ•°ä½†æœªå®šä¹‰ï¼Œæˆ–æœªæ·»åŠ åˆ°CMakeLists.txt

**æ’æŸ¥**ï¼š

```powershell
# 1. æ£€æŸ¥å‡½æ•°å®šä¹‰æ˜¯å¦å­˜åœ¨
Select-String -Path Drivers/SYSTEM/delay/delay.c -Pattern "void delay_ms"
# è¾“å‡º: åº”æœ‰åŒ¹é…è¡Œ

# 2. æ£€æŸ¥CMakeLists.txtæ˜¯å¦åŒ…å«æºæ–‡ä»¶
Select-String -Path CMakeLists.txt -Pattern "delay.c"
# è¾“å‡º: Drivers/SYSTEM/delay/delay.c
```

---

### 3.2 çƒ§å½•é—®é¢˜

#### é—®é¢˜1ï¼šPyOCDæ‰¾ä¸åˆ°è®¾å¤‡

```
Error: No device available
```

**æ’æŸ¥**ï¼š

```powershell
# 1. æ£€æŸ¥USBè¿æ¥
pyocd list
# æ— è¾“å‡º â†’ æœªè¯†åˆ«

# 2. æ£€æŸ¥è®¾å¤‡ç®¡ç†å™¨
# æŸ¥çœ‹æ˜¯å¦æœ‰"CMSIS-DAP"è®¾å¤‡
# å¦‚æ˜¾ç¤ºé»„è‰²æ„Ÿå¹å· â†’ é©±åŠ¨é—®é¢˜

# 3. é‡æ–°å®‰è£…libusbé©±åŠ¨ï¼ˆä½¿ç”¨Zadigå·¥å…·ï¼‰
# å‚è€ƒ: [01-å¼€å‘ç¯å¢ƒé…ç½®](./01-å¼€å‘ç¯å¢ƒé…ç½®.md#14-pythonä¸pyocd)

# 4. æ›´æ¢USBç«¯å£ï¼ˆå»ºè®®USB 2.0ï¼‰
```

---

#### é—®é¢˜2ï¼šçƒ§å½•å¤±è´¥ï¼ˆFlashå†™å…¥é”™è¯¯ï¼‰

```
Error: Failed to program flash
```

**å¯èƒ½åŸå› **ï¼š
1. Flashè¯»ä¿æŠ¤ï¼ˆRDPï¼‰å·²ä½¿èƒ½
2. èŠ¯ç‰‡å·²æŸå
3. ç”µå‹ä¸ç¨³å®š

**è§£å†³æ–¹æ¡ˆ**ï¼š

```powershell
# æ–¹æ¡ˆ1ï¼šå…¨ç‰‡æ“¦é™¤ï¼ˆè§£é™¤è¯»ä¿æŠ¤ï¼‰
pyocd erase --chip --target stm32f103c8

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ST-Link Utilityè§£é™¤è¯»ä¿æŠ¤
# Target â†’ Option Bytes â†’ Read Out Protection â†’ Level 0

# æ–¹æ¡ˆ3ï¼šæ£€æŸ¥ä¾›ç”µç”µå‹
# ç”¨ä¸‡ç”¨è¡¨æµ‹é‡3.3Vå¼•è„šï¼Œåº”åœ¨3.2-3.4Vä¹‹é—´
```

---

### 3.3 ä¸²å£é€šä¿¡é—®é¢˜

#### é—®é¢˜1ï¼šCOM5æ— è¾“å‡ºï¼ˆprintfä¸å·¥ä½œï¼‰

**æ’æŸ¥æ¸…å•**ï¼š

- [ ] æ£€æŸ¥`__io_putchar`å‡½æ•°æ˜¯å¦å®ç°
  ```c
  // Drivers/SYSTEM/usart/usart.c
  int __io_putchar(int ch)
  {
      while ((USART1->SR & USART_SR_TXE) == 0);
      USART1->DR = (uint8_t)ch;
      return ch;
  }
  ```

- [ ] æ£€æŸ¥USART1åˆå§‹åŒ–
  ```c
  usart1_init(115200);  // æ˜¯å¦è°ƒç”¨ï¼Ÿ
  ```

- [ ] æ£€æŸ¥PA9 GPIOé…ç½®
  ```c
  // GPIOåº”é…ç½®ä¸ºå¤ç”¨æ¨æŒ½è¾“å‡º
  gpio_init_struct.Mode = GPIO_MODE_AF_PP;
  ```

- [ ] æ£€æŸ¥BRRå€¼
  ```c
  printf("USART1 BRR = 0x%04X\n", USART1->BRR);
  // 72MHz APB2æ—¶é’Ÿåº”ä¸º0x0271 (625)
  ```

- [ ] æµ‹è¯•HALç›´æ¥å‘é€
  ```c
  const char *test = "TEST\r\n";
  HAL_UART_Transmit(&g_uart1_handle, (uint8_t*)test, 6, 100);
  ```

---

#### é—®é¢˜2ï¼šCOM7ä¹±ç 

**å¯èƒ½åŸå› **ï¼š
1. æ³¢ç‰¹ç‡ä¸åŒ¹é…
2. BRRå€¼é”™è¯¯
3. æ—¶é’Ÿé…ç½®é”™è¯¯

**è¯Šæ–­ä»£ç **ï¼š

```c
void diagnose_uart2(void)
{
    uint32_t pclk1 = HAL_RCC_GetPCLK1Freq();
    uint32_t brr = USART2->BRR;
    uint32_t actual_baud = pclk1 / brr;
    
    printf("[USART2 Diagnostics]\r\n");
    printf("APB1 Clock: %lu Hz\r\n", pclk1);
    printf("BRR Register: 0x%04lX (%lu)\r\n", brr, brr);
    printf("Actual Baudrate: %lu bps\r\n", actual_baud);
    printf("Expected BRR: 0x0138 (312) for 115200@36MHz\r\n");
    
    if (brr == 312 && pclk1 == 36000000)
        printf("âœ“ Configuration OK\r\n");
    else
        printf("âœ— Configuration ERROR!\r\n");
}
```

---

### 3.4 è°ƒè¯•å™¨é—®é¢˜

#### é—®é¢˜1ï¼šVS Codeè°ƒè¯•æ—¶æ–­ç‚¹ä¸å‘½ä¸­

**åŸå› **ï¼šä¼˜åŒ–ç­‰çº§è¿‡é«˜ï¼Œä»£ç è¢«ä¼˜åŒ–æ‰

**è§£å†³**ï¼š

```cmake
# cmake/gcc-arm-none-eabi.cmake
# Debugæ¨¡å¼å¿…é¡»ä½¿ç”¨-O0
set(CMAKE_C_FLAGS_DEBUG "-O0 -g3 -DDEBUG")
```

**éªŒè¯**ï¼š

```powershell
# æ£€æŸ¥ç¼–è¯‘é€‰é¡¹
grep "CMAKE_C_FLAGS_DEBUG" cmake/gcc-arm-none-eabi.cmake
```

---

#### é—®é¢˜2ï¼šSWDè¿æ¥å¤±è´¥

```
Error: Could not find device
```

**æ’æŸ¥**ï¼š

1. **æ£€æŸ¥æ¥çº¿**ï¼š
   ```
   CMSIS-DAP SWDIO â†’ STM32 PA13
   CMSIS-DAP SWCLK â†’ STM32 PA14
   CMSIS-DAP GND   â†’ STM32 GND
   ```

2. **æ£€æŸ¥SW DP**ï¼š
   ```powershell
   pyocd commander --target stm32f103c8
   >>> status
   # è¾“å‡º: Should show "Connected"
   ```

3. **é™ä½SWDé¢‘ç‡**ï¼š
   ```json
   // .vscode/launch.json
   "serverArgs": [
       "--frequency", "1000000"  // é™ä½åˆ°1MHz
   ]
   ```

4. **æ£€æŸ¥NRSTå¼•è„š**ï¼š
   - ç¡®ä¿NRSTæœªè¢«å¤–éƒ¨ç”µè·¯æ‹‰ä½
   - å°è¯•è¿æ¥CMSIS-DAPçš„NRSTåˆ°STM32

---

## 4. æ€§èƒ½åˆ†æä¸ä¼˜åŒ–

### 4.1 ä»£ç ä½“ç§¯åˆ†æ

**æŸ¥çœ‹.mapæ–‡ä»¶æœ€å¤§ç¬¦å·**ï¼š

```powershell
# æå–ç¬¦å·å¤§å°å¹¶æ’åº
Select-String -Path build/Debug/STM32_485.map -Pattern "^\s+0x[0-9a-f]+\s+0x[0-9a-f]+" |
    Sort-Object {[int]($_ -split '\s+')[2]} -Descending |
    Select-Object -First 20
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
0x080012b4   0x00000358  HAL_UART_Init
0x0800160c   0x00000234  HAL_RCC_OscConfig
0x08001840   0x000001f4  printf
0x08001a34   0x00000180  HAL_GPIO_Init
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- ç§»é™¤æœªä½¿ç”¨çš„HALæ¨¡å—
- ä½¿ç”¨`-Os`ä¼˜åŒ–ç¼–è¯‘
- å¯ç”¨é“¾æ¥æ—¶ä¼˜åŒ–ï¼ˆLTOï¼‰

---

### 4.2 æ‰§è¡Œæ—¶é—´æµ‹é‡

**æ–¹æ³•1ï¼šDWTå‘¨æœŸè®¡æ•°å™¨**

```c
// åˆå§‹åŒ–DWTï¼ˆData Watchpoint and Traceï¼‰
void dwt_init(void)
{
    CoreDebug->DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;  // ä½¿èƒ½DWT
    DWT->CYCCNT = 0;                                  // æ¸…é›¶è®¡æ•°å™¨
    DWT->CTRL |= DWT_CTRL_CYCCNTENA_Msk;             // å¯åŠ¨è®¡æ•°å™¨
}

// æµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´
uint32_t start = DWT->CYCCNT;
function_to_measure();
uint32_t end = DWT->CYCCNT;
uint32_t cycles = end - start;
float time_us = (float)cycles / (SystemCoreClock / 1000000.0f);
printf("Execution time: %.2f us (%lu cycles)\r\n", time_us, cycles);
```

**æ–¹æ³•2ï¼šGPIOç¿»è½¬+é€»è¾‘åˆ†æä»ª**

```c
void test_function(void)
{
    HAL_GPIO_WritePin(GPIOC, GPIO_PIN_13, GPIO_PIN_SET);    // ç½®é«˜
    // ... è¢«æµ‹ä»£ç  ...
    HAL_GPIO_WritePin(GPIOC, GPIO_PIN_13, GPIO_PIN_RESET);  // ç½®ä½
}
// ç”¨é€»è¾‘åˆ†æä»ªæµ‹é‡PC13é«˜ç”µå¹³æŒç»­æ—¶é—´
```

---

### 4.3 RAMä½¿ç”¨åˆ†æ

**æŸ¥çœ‹æ ˆå’Œå †å¤§å°**ï¼š

```c
// STM32F103C8Tx_FLASH.ld
_Min_Heap_Size = 0x200;   /* 512 bytes */
_Min_Stack_Size = 0x400;  /* 1024 bytes */
```

**è¿è¡Œæ—¶æ£€æµ‹æ ˆæº¢å‡º**ï¼š

```c
extern uint32_t _estack;
extern uint32_t _sstack;

void check_stack_usage(void)
{
    uint32_t *stack_ptr;
    asm("mov %0, sp" : "=r" (stack_ptr));
    
    uint32_t stack_used = (uint32_t)&_estack - (uint32_t)stack_ptr;
    uint32_t stack_size = (uint32_t)&_estack - (uint32_t)&_sstack;
    
    printf("Stack Used: %lu / %lu bytes (%.1f%%)\r\n",
           stack_used, stack_size, (float)stack_used / stack_size * 100);
}
```

---

## 5. å†å²è°ƒè¯•æ¡ˆä¾‹

### 5.1 æ¡ˆä¾‹1ï¼šHSEæ™¶æŒ¯å¯åŠ¨å¤±è´¥

**æ—¥æœŸ**ï¼š2025-11-29

**ç—‡çŠ¶**ï¼š
- SystemCoreClock = 8000000ï¼ˆæœŸæœ›72000000ï¼‰
- ä¸²å£æ³¢ç‰¹ç‡ä¹±ç 
- LEDé—ªçƒæ¬¡æ•°ä¸º8æ¬¡ï¼ˆè¯Šæ–­ä»£ç æ˜¾ç¤º8MHzï¼‰

**æ’æŸ¥è¿‡ç¨‹**ï¼š

```c
// 1. ç¡®è®¤æ—¶é’Ÿæº
uint32_t rcc_cr = RCC->CR;
printf("RCC_CR = 0x%08lX\r\n", rcc_cr);
// bit 17 (HSERDY) = 0 â†’ HSEæœªå°±ç»ª

// 2. æ£€æŸ¥HAL_RCC_OscConfigè¿”å›å€¼
HAL_StatusTypeDef ret = HAL_RCC_OscConfig(&rcc_osc_init);
printf("HAL_RCC_OscConfig ret = %d\r\n", ret);
// è¿”å›: HAL_ERROR (1)
```

**æ ¹æœ¬åŸå› **ï¼šåˆæœŸè¯¯åˆ¤ä¸ºç¡¬ä»¶æ•…éšœï¼ˆæ™¶æŒ¯æœªç„Šæ¥ï¼‰ï¼Œå®é™…ä¸ºè½¯ä»¶é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¸´æ—¶æ–¹æ¡ˆï¼šåˆ‡æ¢åˆ°HSI 8MHzï¼Œæ‰‹åŠ¨è®¡ç®—BRRå€¼
- æœ€ç»ˆæ–¹æ¡ˆï¼šä¿®å¤sys.cé…ç½®ï¼Œä½¿ç”¨HSE+PLL 72MHz

**ç»éªŒæ•™è®­**ï¼š
- ç¡¬ä»¶é—®é¢˜éœ€è¦å¤šæ–¹éªŒè¯ï¼ˆç”¨æˆ·åœ¨Keil5ä¸­HSEæ­£å¸¸å·¥ä½œï¼‰
- ä¿ç•™è°ƒè¯•è¯Šæ–­ä»£ç ï¼Œä¾¿äºå¿«é€Ÿå®šä½

---

### 5.2 æ¡ˆä¾‹2ï¼šprintfæ— è¾“å‡ºï¼ˆGCCå·¥å…·é“¾å·®å¼‚ï¼‰

**æ—¥æœŸ**ï¼š2025-12-01

**ç—‡çŠ¶**ï¼š
- COM7æ”¶åˆ°å®Œæ•´è¯Šæ–­æŠ¥å‘Š
- COM5å®Œå…¨æ— è¾“å‡º
- CMSIS-DAP RXæŒ‡ç¤ºç¯ä¸é—ªçƒ

**æ’æŸ¥è¿‡ç¨‹**ï¼š

```c
// 1. æ£€æŸ¥fputcå®ç°
int fputc(int ch, FILE *f)
{
    while ((USART1->SR & USART_SR_TXE) == 0);
    USART1->DR = (uint8_t)ch;
    return ch;
}
// âœ“ å‡½æ•°å·²å®ç°

// 2. æµ‹è¯•HALç›´æ¥å‘é€
const char *test = "HAL TEST\r\n";
HAL_UART_Transmit(&g_uart1_handle, (uint8_t*)test, 10, 100);
// âœ“ COM5æ”¶åˆ°è¾“å‡ºï¼è¯´æ˜ç¡¬ä»¶æ­£å¸¸

// 3. ç»“è®ºï¼šprintfæ²¡æœ‰è°ƒç”¨fputc
```

**æ ¹æœ¬åŸå› **ï¼š
- MDKç¼–è¯‘å™¨ï¼š`printf` â†’ `fputc`
- GCC Newlibï¼š`printf` â†’ `_write` â†’ `__io_putchar`

**è§£å†³æ–¹æ¡ˆ**ï¼š

```c
// æ·»åŠ __io_putcharå®ç°
int __io_putchar(int ch)
{
    while ((USART1->SR & USART_SR_TXE) == 0);
    USART1->DR = (uint8_t)ch;
    return ch;
}
```

**ç»éªŒæ•™è®­**ï¼š
- è·¨ç¼–è¯‘å™¨ç§»æ¤éœ€æ³¨æ„åº•å±‚å®ç°å·®å¼‚
- ä¿ç•™fputcå’Œ__io_putcharåŒå®ç°ï¼Œç¡®ä¿å…¼å®¹æ€§

---

### 5.3 æ¡ˆä¾‹3ï¼šPyOCDçƒ§å½•è·³è¿‡ï¼ˆç¼“å­˜é—®é¢˜ï¼‰

**ç—‡çŠ¶**ï¼š
- ä¿®æ”¹ä»£ç åç¼–è¯‘æˆåŠŸ
- PyOCDçƒ§å½•æ˜¾ç¤º "skipped 31744 bytes"
- å®é™…å›ºä»¶æœªæ›´æ–°

**åŸå› **ï¼šPyOCDæ™ºèƒ½è·³è¿‡ç›¸åŒå†…å®¹çš„Flashé¡µ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```powershell
# æ–¹æ³•1ï¼šå…¨ç‰‡æ“¦é™¤åçƒ§å½•
pyocd erase --chip --target stm32f103c8
pyocd flash build/Debug/STM32_485.elf --target stm32f103c8

# æ–¹æ³•2ï¼šä½¿ç”¨--no-waité€‰é¡¹ï¼ˆç¦ç”¨æ™ºèƒ½è·³è¿‡ï¼‰
pyocd flash build/Debug/STM32_485.elf --target stm32f103c8 --trust-crc

# æ–¹æ³•3ï¼šåˆ é™¤CMakeç¼“å­˜é‡æ–°ç¼–è¯‘
Remove-Item -Recurse build/Debug/CMakeFiles/STM32_485.dir
cmake --build --preset Debug
```

---

## ğŸ¯ æ€»ç»“

æŒæ¡è°ƒè¯•æŠ€å·§åï¼Œæ‚¨å·²å…·å¤‡ï¼š
- âœ… å®Œæ•´çš„VS Codeè°ƒè¯•ç¯å¢ƒ
- âœ… PyOCDå’ŒGDBå‘½ä»¤è¡Œè°ƒè¯•èƒ½åŠ›
- âœ… å¸¸è§é—®é¢˜å¿«é€Ÿæ’æŸ¥æ–¹æ³•
- âœ… æ€§èƒ½åˆ†æå’Œä¼˜åŒ–æ‰‹æ®µ
- âœ… çœŸå®æ¡ˆä¾‹çš„å®æˆ˜ç»éªŒ

**ç»§ç»­å­¦ä¹ **ï¼š
- **[07-ç”µæœºæ§åˆ¶å¿«é€Ÿå…¥é—¨](./07-ç”µæœºæ§åˆ¶å¿«é€Ÿå…¥é—¨.md)** - å¼ å¤§å¤´ç”µæœºEmm_V5åè®®ä½¿ç”¨

---

**è¿”å›**: [00-é¡¹ç›®æ€»è§ˆ](./00-é¡¹ç›®æ€»è§ˆ.md) | **ä¸Šä¸€ç¯‡**: [05-CMakeæ„å»ºç³»ç»Ÿ](./05-CMakeæ„å»ºç³»ç»Ÿ.md)
