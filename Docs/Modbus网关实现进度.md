# Modbusç½‘å…³å®ç°è¿›åº¦æŠ¥å‘Š

## âœ… å·²å®Œæˆæ¨¡å—ï¼ˆ2025-12-01ï¼‰

### 1. Modbus RTUåè®®æ ¸å¿ƒ (`modbus_rtu.c/h`)

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… CRC16æ ¡éªŒï¼ˆæŸ¥è¡¨æ³•ï¼Œé«˜æ€§èƒ½ï¼‰
- âœ… å¸§è§£æä¸æ„å»ºï¼ˆæ”¯æŒæœ€å¤§256å­—èŠ‚å¸§ï¼‰
- âœ… 9ä¸ªæ ‡å‡†åŠŸèƒ½ç å¤„ç†å™¨ï¼š
  * 0x01: è¯»çº¿åœˆ
  * 0x02: è¯»ç¦»æ•£è¾“å…¥
  * 0x03: è¯»ä¿æŒå¯„å­˜å™¨ â­
  * 0x04: è¯»è¾“å…¥å¯„å­˜å™¨
  * 0x05: å†™å•ä¸ªçº¿åœˆ
  * 0x06: å†™å•ä¸ªå¯„å­˜å™¨ â­
  * 0x0F: å†™å¤šä¸ªçº¿åœˆ
  * 0x10: å†™å¤šä¸ªå¯„å­˜å™¨ â­
  * 0x17: è¯»å†™å¤šä¸ªå¯„å­˜å™¨ï¼ˆå¾…å®ç°ï¼‰
- âœ… å¼‚å¸¸å“åº”ç”Ÿæˆï¼ˆ8ç§å¼‚å¸¸ç ï¼‰
- âœ… ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸§è®¡æ•°ã€CRCé”™è¯¯ã€è¶…æ—¶ï¼‰
- âœ… æ¥æ”¶ç¼“å†²åŒºç®¡ç†ï¼ˆIDLEä¸­æ–­å›è°ƒæ¥å£ï¼‰

**ä»£ç ç»Ÿè®¡**:
- å¤´æ–‡ä»¶: 228è¡Œï¼Œ9ä¸ªå…¬å…±API
- å®ç°æ–‡ä»¶: 693è¡Œï¼ŒåŒ…å«256å­—èŠ‚CRC16æŸ¥è¡¨
- ç¼–è¯‘çŠ¶æ€: âœ… æ— é”™è¯¯ï¼Œ3ä¸ªè­¦å‘Šï¼ˆç±»å‹é™åˆ¶æ¯”è¾ƒï¼Œå·²ä¿®å¤ï¼‰

---

### 2. å¯„å­˜å™¨æ˜ å°„ç½‘å…³ (`modbus_gateway.c/h`)

**å¯„å­˜å™¨å¸ƒå±€**:
```
0x0000-0x007F: å…¨å±€æ§åˆ¶åŒºï¼ˆ128å¯„å­˜å™¨ï¼‰
    â”œâ”€ ç³»ç»Ÿé…ç½®ï¼ˆREG_SYS_ENABLE, REG_SYS_STATUS, REG_SYS_ERROR_CODEç­‰ï¼‰
    â”œâ”€ å›ºä»¶ç‰ˆæœ¬: 0x0100 (V1.0)
    â”œâ”€ ç¡¬ä»¶ç‰ˆæœ¬: 0xF103 (STM32F103)
    â””â”€ è®¾å¤‡ID/æ³¢ç‰¹ç‡/å¿ƒè·³/çœ‹é—¨ç‹—é…ç½®

0x0100-0x04FF: ç”µæœºæ§åˆ¶åŒºï¼ˆ16ç”µæœºÃ—64å¯„å­˜å™¨ï¼‰
    â”œâ”€ ç”µæœºNåŸºåœ°å€: 0x0100 + (N-1)Ã—64
    â”œâ”€ åç§»+0~+11: ä½¿èƒ½/æ¨¡å¼/æ–¹å‘/é€Ÿåº¦/åŠ é€Ÿåº¦/ä½ç½®/å‘½ä»¤/åŒæ­¥/ç”µæµ
    â””â”€ åç§»+8 EXEC_COMMANDè§¦å‘ç”µæœºåŠ¨ä½œ

0x0500-0x08FF: ç”µæœºçŠ¶æ€åŒºï¼ˆ16ç”µæœºÃ—64å¯„å­˜å™¨ï¼Œåªè¯»ï¼‰
    â”œâ”€ å®æ—¶ä½ç½®/é€Ÿåº¦/ç”µæµ/ç”µå‹/æ¸©åº¦
    â””â”€ çŠ¶æ€æ ‡å¿—/é”™è¯¯ç 

0x0C00-0x0C1F: çº¿åœˆåŒºï¼ˆ32çº¿åœˆï¼‰
    â”œâ”€ MOTOR1-16_ENABLE (å¿«é€Ÿä½¿èƒ½)
    â”œâ”€ EMERGENCY_STOP (ç´§æ€¥åœæ­¢)
    â””â”€ SYNC_MOTION_TRIGGER (åŒæ­¥è§¦å‘)

0x0C20-0x0C3F: ç¦»æ•£è¾“å…¥åŒºï¼ˆ32è¾“å…¥ï¼Œåªè¯»ï¼‰
    â””â”€ MOTOR1-16_ARRIVED (åˆ°ä½æ ‡å¿—)
```

**å·²å®ç°åŠŸèƒ½**:
- âœ… å¯„å­˜å™¨è¯»å†™APIï¼ˆæ”¯æŒ0x03/0x04/0x06/0x10åŠŸèƒ½ç ï¼‰
- âœ… çº¿åœˆ/ç¦»æ•£è¾“å…¥APIï¼ˆæ”¯æŒ0x01/0x02/0x05/0x0FåŠŸèƒ½ç ï¼‰
- âœ… EXEC_COMMANDå‘½ä»¤è§£æï¼ˆ8ç§å‘½ä»¤ï¼‰ï¼š
  1. ENABLE/DISABLE - æ˜ å°„åˆ°`Emm_V5_En_Control()`
  2. POS_MOVE - æ˜ å°„åˆ°`Emm_V5_Pos_Control()`ï¼ˆæ”¯æŒæ¢¯å½¢æ›²çº¿ï¼‰
  3. VEL_MOVE - æ˜ å°„åˆ°`Emm_V5_Vel_Control()`
  4. STOP - æ˜ å°„åˆ°`Emm_V5_Stop_Now()`
  5. CLEAR_POS - æ˜ å°„åˆ°`Emm_V5_Reset_CurPos_To_Zero()`
  6. HOMING/CLEAR_PROTECT - å¾…å®ç°
- âœ… ç‰¹æ®Šçº¿åœˆå¤„ç†ï¼ˆä½¿èƒ½ã€ç´§æ€¥åœæ­¢ã€åŒæ­¥è§¦å‘ï¼‰
- âœ… åªè¯»å¯„å­˜å™¨ä¿æŠ¤ï¼ˆæ‹’ç»å†™å…¥çŠ¶æ€åŒºï¼‰

**ä»£ç ç»Ÿè®¡**:
- å¤´æ–‡ä»¶: 317è¡Œï¼Œ20+ä¸ªAPI
- å®ç°æ–‡ä»¶: 560è¡Œ
- æ•°æ®ç»“æ„: 4ä¸ªä¸»è¦ç»“æ„ä½“ï¼ˆå…¨å±€æ§åˆ¶ã€ç”µæœºæ§åˆ¶ã€ç”µæœºçŠ¶æ€ã€çº¿åœˆ/ç¦»æ•£è¾“å…¥ï¼‰
- ç¼–è¯‘çŠ¶æ€: âœ… æ— é”™è¯¯ï¼Œ3ä¸ªè­¦å‘Šï¼ˆå·²å…¨éƒ¨ä¿®å¤ï¼‰

---

## ğŸ”„ è¿›è¡Œä¸­ä»»åŠ¡

### 3. USART1åŒå‘é€šè®¯å‡çº§

**å½“å‰çŠ¶æ€**: USART1ä»…æ”¯æŒprintfè¾“å‡ºï¼ˆè½®è¯¢å‘é€ï¼‰

**å¾…å®ç°åŠŸèƒ½**:
1. â±ï¸ æ·»åŠ IDLEä¸­æ–­æ£€æµ‹Modbuså¸§è¾¹ç•Œ
2. â±ï¸ é›†æˆFIFOæ¥æ”¶ç¼“å†²åŒºï¼ˆå¤ç”¨USART2çš„FIFOæœºåˆ¶ï¼‰
3. â±ï¸ åœ¨`USART1_IRQHandler`ä¸­è°ƒç”¨`modbus_rtu_rx_byte_callback()`å’Œ`modbus_rtu_idle_callback()`
4. â±ï¸ ä¿ç•™printfåŠŸèƒ½ï¼ˆé€šè¿‡æ ‡å¿—ä½åˆ‡æ¢ï¼‰

**é¢„è®¡æ–‡ä»¶ä¿®æ”¹**:
- `Drivers/SYSTEM/usart/usart.c`: æ·»åŠ USART1 IDLEä¸­æ–­å¤„ç†
- `Drivers/SYSTEM/usart/usart.h`: å¯¼å‡ºModbuså›è°ƒæ¥å£

---

## â­ï¸ å¾…å¼€å§‹ä»»åŠ¡

### 4. ä¸»ç¨‹åºé›†æˆä¸æµ‹è¯•

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**:
- `Core/App/main.c`:
  ```c
  /* USER CODE BEGIN 2 */
  modbus_rtu_init(1, 115200);      // åˆå§‹åŒ–Modbusåè®®
  modbus_gateway_init();           // åˆå§‹åŒ–å¯„å­˜å™¨æ˜ å°„
  /* USER CODE END 2 */
  
  /* USER CODE BEGIN 3 */
  while (1) {
      modbus_rtu_rx_buffer_t *rx_buf = modbus_rtu_get_rx_buffer();
      if (rx_buf->frame_complete) {
          uint8_t tx_buffer[256];
          uint16_t tx_len;
          
          modbus_rtu_process_request(rx_buf->buffer, rx_buf->rx_index, 
                                      tx_buffer, &tx_len);
          
          HAL_UART_Transmit(&g_uart1_handle, tx_buffer, tx_len, 100);
          
          rx_buf->frame_complete = false;
          rx_buf->rx_index = 0;
      }
      
      HAL_Delay(1);
  }
  /* USER CODE END 3 */
  ```

### 5. Pythonæµ‹è¯•è„šæœ¬å¼€å‘

**ç¤ºä¾‹1: è¯»å–ç³»ç»ŸçŠ¶æ€**
```python
from pymodbus.client import ModbusSerialClient

client = ModbusSerialClient(port='COM3', baudrate=115200, timeout=1)
client.connect()

# è¯»å–å›ºä»¶ç‰ˆæœ¬å’Œç¡¬ä»¶ç‰ˆæœ¬
result = client.read_holding_registers(0x0007, 2, unit=1)
fw_ver = result.registers[0]
hw_ver = result.registers[1]
print(f"å›ºä»¶ç‰ˆæœ¬: {fw_ver>>8}.{fw_ver&0xFF}")
print(f"ç¡¬ä»¶ç‰ˆæœ¬: 0x{hw_ver:04X}")

client.close()
```

**ç¤ºä¾‹2: å•ç”µæœºä½ç½®æ§åˆ¶**
```python
MOTOR1_BASE = 0x0100

# ä½¿èƒ½ç”µæœº1
client.write_register(MOTOR1_BASE + 0, 1)

# é…ç½®æ¢¯å½¢æ›²çº¿ä½ç½®æ¨¡å¼
client.write_registers(MOTOR1_BASE + 1, [
    3,      # CTRL_MODE = æ¢¯å½¢æ›²çº¿
    0,      # DIRECTION = CW
    10000,  # SPEED = 1000.0 RPM
    100,    # ACCELERATION
    100,    # DECELERATION
    0,      # POSITION_H = 0
    3600,   # POSITION_L = 360.0Â° (3600ä¸ª0.1Â°)
])

# æ‰§è¡Œä½ç½®è¿åŠ¨
client.write_register(MOTOR1_BASE + 8, 3)  # EXEC_COMMAND = POS_MOVE
```

### 6. ç”µæœºçŠ¶æ€è½®è¯¢å®ç°

**å¾…å®ç°å‡½æ•°**: `modbus_gateway_update_motor_status()`

**ä¼ªä»£ç **:
```c
void modbus_gateway_update_motor_status(void) {
    static uint32_t last_update_time = 0;
    uint32_t now = HAL_GetTick();
    
    // æ¯100msæ›´æ–°ä¸€æ¬¡
    if (now - last_update_time < 100) {
        return;
    }
    last_update_time = now;
    
    for (uint8_t motor_id = 1; motor_id <= MODBUS_MAX_MOTORS; motor_id++) {
        if (g_motor_control_regs[motor_id-1].enable) {
            // TODO: è°ƒç”¨Emm_V5_Read_Sys_Params()æŸ¥è¯¢
            // æ›´æ–°g_motor_status_regs[motor_id-1]
            // æ›´æ–°ç¦»æ•£è¾“å…¥ï¼ˆåˆ°ä½æ ‡å¿—ï¼‰
        }
    }
}
```

**æ³¨æ„äº‹é¡¹**: Yç³»åˆ—ç”µæœºä¸æ”¯æŒä¸»åŠ¨æŸ¥è¯¢ä½ç½®/é€Ÿåº¦ï¼ˆéœ€ä¾èµ–0x36/0x35å‘½ä»¤å“åº”ï¼‰ï¼Œå¯èƒ½éœ€è¦ï¼š
1. ä½¿ç”¨"å®šæ—¶è¿”å›"åŠŸèƒ½ï¼ˆå‘½ä»¤0x68ï¼‰è®©ç”µæœºè‡ªåŠ¨ä¸ŠæŠ¥
2. æˆ–é€šè¿‡è§£æUSART2æ¥æ”¶åˆ°çš„å“åº”å¸§æ›´æ–°çŠ¶æ€

---

## ğŸ“Š èµ„æºå ç”¨ä¼°ç®—

### Flashå ç”¨
```
Modbus RTUæ ¸å¿ƒ:     ~4KB (å«CRCè¡¨)
å¯„å­˜å™¨æ˜ å°„ç½‘å…³:     ~3KB
æ€»è®¡æ–°å¢:           ~7KB
å‰©ä½™ç©ºé—´:           64KB - 24KB(åŸæœ‰) - 7KB = 33KB (51%å¯ç”¨)
```

### RAMå ç”¨
```
å…¨å±€æ§åˆ¶å¯„å­˜å™¨:     128Ã—2 = 256å­—èŠ‚
ç”µæœºæ§åˆ¶å¯„å­˜å™¨:     16Ã—64Ã—2 = 2048å­—èŠ‚
ç”µæœºçŠ¶æ€å¯„å­˜å™¨:     16Ã—64Ã—2 = 2048å­—èŠ‚
çº¿åœˆ/ç¦»æ•£è¾“å…¥:      8å­—èŠ‚
Modbusæ¥æ”¶ç¼“å†²:     256å­—èŠ‚
æ€»è®¡æ–°å¢:           ~4.6KB
å‰©ä½™ç©ºé—´:           20KB - 3.3KB(åŸæœ‰) - 4.6KB = 12.1KB (60%å¯ç”¨)
```

**ç»“è®º**: STM32F103C8èµ„æºå……è¶³ï¼Œå¯æ”¯æŒå®Œæ•´V2.1æ¶æ„ âœ…

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### Phase 1: åŸºç¡€é€šè®¯éªŒè¯ï¼ˆé¢„è®¡1å°æ—¶ï¼‰
1. ä¿®æ”¹`usart.c`æ·»åŠ USART1 IDLEä¸­æ–­
2. é›†æˆModbuså›è°ƒåˆ°`main.c`
3. ç¼–è¯‘çƒ§å½•æµ‹è¯•
4. ä½¿ç”¨ä¸²å£åŠ©æ‰‹å‘é€Modbuså¸§éªŒè¯CRCè®¡ç®—

### Phase 2: åŠŸèƒ½æµ‹è¯•ï¼ˆé¢„è®¡2å°æ—¶ï¼‰
1. Pythonè¯»å–ç³»ç»ŸçŠ¶æ€å¯„å­˜å™¨ï¼ˆåŠŸèƒ½ç 0x03ï¼‰
2. Pythonå†™å…¥ç”µæœºå‚æ•°ï¼ˆåŠŸèƒ½ç 0x06/0x10ï¼‰
3. Pythonæ‰§è¡Œä½ç½®è¿åŠ¨å‘½ä»¤
4. éªŒè¯ç”µæœºå“åº”ï¼ˆLEDæŒ‡ç¤ºæˆ–ä¸²å£logï¼‰

### Phase 3: å®Œæ•´MVPï¼ˆé¢„è®¡4å°æ—¶ï¼‰
1. å®ç°4ä¸ªç”µæœºçš„å®Œæ•´æ§åˆ¶
2. æµ‹è¯•å¤šç”µæœºåŒæ­¥è¿åŠ¨ï¼ˆå†™SYNC_FLAG + Coilè§¦å‘ï¼‰
3. å®ç°çŠ¶æ€è½®è¯¢ï¼ˆå¦‚æœç”µæœºæ”¯æŒæŸ¥è¯¢ï¼‰
4. å‹åŠ›æµ‹è¯•ï¼ˆé«˜é¢‘è¯»å†™ï¼‰

---

## ğŸ“ å·²çŸ¥é™åˆ¶ä¸å¾…åŠ

### å½“å‰é™åˆ¶
1. âŒ ç”µæœºçŠ¶æ€åŒºæš‚ä¸ºç©ºï¼ˆæœªå®ç°è½®è¯¢ï¼‰
2. âŒ å›é›¶åŠŸèƒ½æœªå®ç°ï¼ˆéœ€æ˜ å°„å›é›¶å‚æ•°å¯„å­˜å™¨ï¼‰
3. âŒ é—´æ¥å¯»å€æœºåˆ¶æœªå®ç°ï¼ˆéœ€0x0900-0x093Fï¼‰
4. âŒ è½¨è¿¹ç¼“å†²åŒºæœªå®ç°ï¼ˆéœ€0x0A00-0x0BFFï¼‰
5. âŒ äº‹ä»¶ä¸­æ–­æœºåˆ¶æœªå®ç°

### ä¼˜å…ˆçº§å¾…åŠ
- ğŸ”¥ **P0**: USART1åŒå‘é€šè®¯ï¼ˆMVPå¿…éœ€ï¼‰
- ğŸ”¥ **P0**: ä¸»ç¨‹åºé›†æˆä¸åŸºç¡€æµ‹è¯•
- âš ï¸ **P1**: ç”µæœºçŠ¶æ€è½®è¯¢ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦ï¼‰
- âš ï¸ **P1**: å›é›¶åŠŸèƒ½å®ç°
- ğŸ“Œ **P2**: é—´æ¥å¯»å€æœºåˆ¶ï¼ˆè®¿é—®æ‰©å±•å‚æ•°ï¼‰
- ğŸ“Œ **P2**: è½¨è¿¹ç¼“å†²åŒºï¼ˆè¿ç»­è¿åŠ¨ï¼‰
- ğŸ“Œ **P3**: äº‹ä»¶ä¸­æ–­ï¼ˆå®šæ—¶è¿”å›ï¼‰

---

## ğŸ›¡ï¸ ä»£ç è´¨é‡ä¿è¯

### å·²å®æ–½çš„å®‰å…¨æªæ–½
- âœ… åœ°å€èŒƒå›´æ£€æŸ¥ï¼ˆé˜²æ­¢è¶Šç•Œè®¿é—®ï¼‰
- âœ… åªè¯»å¯„å­˜å™¨ä¿æŠ¤ï¼ˆæ‹’ç»å†™å…¥çŠ¶æ€åŒºï¼‰
- âœ… CRCæ ¡éªŒï¼ˆModbusæ ‡å‡†ï¼‰
- âœ… å‚æ•°åˆæ³•æ€§æ£€æŸ¥ï¼ˆå¯„å­˜å™¨æ•°é‡ã€çº¿åœˆæ•°é‡ï¼‰
- âœ… å¼‚å¸¸å“åº”ç”Ÿæˆï¼ˆ8ç§æ ‡å‡†å¼‚å¸¸ç ï¼‰

### è°ƒè¯•æ”¯æŒ
- âœ… DEBUGå®æ§åˆ¶æ‰“å°è¾“å‡º
- âœ… ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¸§è®¡æ•°ã€CRCé”™è¯¯ã€è¶…æ—¶ï¼‰
- âœ… è¯¦ç»†æ³¨é‡Šå’ŒDoxygenæ–‡æ¡£

### æµ‹è¯•è¦†ç›–
- â±ï¸ å•å…ƒæµ‹è¯•ï¼ˆå¾…å¼€å‘ï¼‰
- â±ï¸ é›†æˆæµ‹è¯•ï¼ˆå¾…å¼€å‘ï¼‰
- â±ï¸ å‹åŠ›æµ‹è¯•ï¼ˆå¾…å¼€å‘ï¼‰

---

**æœ€åæ›´æ–°**: 2025-12-01 20:30  
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡ï¼ˆgcc-arm-none-eabi 13.2.1ï¼‰  
**ä¸‹ä¸€é‡Œç¨‹ç¢‘**: USART1åŒå‘é€šè®¯é›†æˆ â†’ MVPåŠŸèƒ½éªŒè¯
