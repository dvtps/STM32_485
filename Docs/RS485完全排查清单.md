# RS485通信完全排查清单

## 当前状态确认

根据正点原子官方文档，ATK-MB024模块连接方式：

```
STM32开发板          ATK-MB024模块
PA2 (USART2_TX) --> RX (TTL接收)
PA3 (USART2_RX) <-- TX (TTL发送)
GND             --> GND
3.3V或5V        --> VCC

ATK-MB024模块        485转USB/电机
A               <--> A
B               <--> B
GND (可选)      <--> GND
```

## 🔍 逐项检查清单

### 硬件检查

#### 1. ATK-MB024模块供电
- [ ] 模块上的**电源指示灯是否亮**？
  - 如果不亮 → VCC或GND没接好
  - 应该常亮（红色或绿色LED）

#### 2. STM32到ATK-MB024连接
请用万用表测量：
- [ ] PA2和模块RX引脚**导通**吗？（应该<1Ω）
- [ ] PA3和模块TX引脚**导通**吗？（应该<1Ω）
- [ ] GND是否共地？
- [ ] PA2空闲电平应该是**3.3V高电平**

#### 3. ATK-MB024到485转USB连接
- [ ] A线对A线，B线对B线？
- [ ] **不能接反**！A-B接反完全收不到数据
- [ ] 如果不确定，试试交换A-B线

#### 4. 终端电阻
- [ ] ATK-MB024模块的拨码开关位置？
  - 短距离测试（<10米）：可以**OFF**
  - 长距离或多设备：两端设备打**ON**

#### 5. 485转USB模块
- [ ] 电脑设备管理器能看到COM口吗？
- [ ] COM口属性显示波特率是115200吗？
- [ ] 尝试拔插USB重新识别

### 软件检查

#### 6. 编译状态
```powershell
cmake --build --preset Debug
```
- [ ] 编译成功？Flash占用29384字节

#### 7. 测试模式配置
查看 `Core/App/test_mode.h`：
```c
#define RS485_TEST_MODE  1  // 应该是1（USART2测试）
```

#### 8. 串口助手配置
**485转USB串口助手**：
- [ ] 波特率：115200
- [ ] 数据位：8
- [ ] 停止位：1
- [ ] 校验位：无
- [ ] 显示方式：**HEX十六进制**

**USART1调试串口助手**（可选）：
- [ ] PA9/PA10连USB-TTL
- [ ] 115200-8-N-1
- [ ] 文本显示模式
- [ ] 看到"发送成功"等日志

### 行为验证

#### 9. LED闪烁
- [ ] LED0每200ms闪烁一次？
  - 如果不闪 → 程序没运行或死机
  - 按复位键重启

#### 10. 按KEY0测试
- [ ] 按下KEY0后，USART1有"RS485模块 发送的数据为..."？
- [ ] 485转USB串口助手收到200字节数据？

### 典型故障和解决

#### 现象A：LED不闪烁
**原因**：固件未烧录或程序死机
**解决**：
1. 重新烧录固件
2. 按复位键
3. 检查供电是否正常

#### 现象B：LED闪烁，USART1有日志，但485转USB无数据
**原因**：PA2/PA3到模块或A/B线问题
**解决**：
1. 用万用表蜂鸣档测试导通性
2. 交换A-B线试试
3. 更换ATK-MB024模块
4. 尝试USART1模式（`RS485_TEST_MODE=2`）

#### 现象C：485转USB收到数据但是乱码
**原因**：波特率不匹配
**解决**：
1. 确认STM32代码中是115200
2. 确认串口助手设置115200
3. 检查晶振是否准确（应该8MHz）

#### 现象D：只有按KEY0时才发送，没有自动发送
**正常**：这就是正确行为！V2.0测试代码改为**按键触发**，不是自动发送
- 按下KEY0 → 发送200字节
- LED每200ms闪烁 → 程序正常运行

### 终极测试方案

#### 方案1：回环测试（不需要485转USB）
将ATK-MB024模块的A-B短接：
```
ATK-MB024
A ----+
      |
B ----+
```
- 按KEY0发送
- 如果USART1看到"RS485模块 接收的数据为..."
- 说明发送和接收都正常

#### 方案2：两套设备对发
如果有两套STM32+ATK-MB024：
```
设备1                  设备2
ATK-MB024 A  <---->  ATK-MB024 A
ATK-MB024 B  <---->  ATK-MB024 B
GND          <---->  GND
```
- 设备1按KEY0发送
- 设备2应该收到并打印

#### 方案3：切换到USART1测试
修改 `test_mode.h`：
```c
#define RS485_TEST_MODE  2  // 改为2
```
重新连接：
```
STM32 PA9  (USART1_TX) --> ATK-MB024 RX
STM32 PA10 (USART1_RX) <-- ATK-MB024 TX
```
- 如果这样能通信 → 说明USART2或PA2/PA3有问题
- 如果还不能通信 → 说明ATK-MB024或485转USB有问题

###  补充技术细节

#### ATK-MB024自动收发原理
模块内部有自动收发电路：
- 默认接收模式
- 检测到TX引脚数据 → 自动切换到发送模式
- 发送完成 → 自动切回接收模式
- **不需要手动控制DE/RE引脚**

#### USART2波特率计算
```
系统时钟: 72MHz
USART2时钟: APB1 = 36MHz
波特率: 115200
BRR寄存器值: 36000000/115200 = 312.5 = 0x138

验证命令（通过USMART）:
rs485_print_config()  # 查看实际配置
```

#### 电平逻辑
```
TTL (MCU端):
  逻辑1 = 3.3V
  逻辑0 = 0V

RS485 (总线端):
  逻辑1 = A-B > +200mV  (典型±2V~±6V)
  逻辑0 = A-B < -200mV
```

## 🎯 推荐检查顺序

1. **先检查LED** → 确认程序运行
2. **测量供电** → ATK-MB024指示灯应该亮
3. **测导通性** → PA2-RX, PA3-TX, GND
4. **按KEY0** → USART1看日志，485转USB看数据
5. **如果无数据** → 交换A-B线试试
6. **仍然无数据** → 尝试回环测试
7. **还是不行** → 切换到USART1模式

## 📞 如果全都检查了还不行

请提供以下信息：
1. ATK-MB024模块电源灯状态（亮/不亮）
2. LED0闪烁状态（闪/不闪）
3. 按KEY0后USART1的完整输出
4. 485转USB串口助手的截图（HEX模式）
5. 万用表测量PA2对GND的电压（空闲时应该3.3V）
6. 尝试交换A-B线后的结果

---

**90%的问题是A-B接反或者没有共地！请务必仔细检查！**
