# RS485调试增强版 - 使用说明

> ⚠️ **文档已过时** (V3.0架构)
> 
> 本文档描述的 `RS485_TEST_MODE` 测试框架已在V3.0中移除。
> 
> **V3.0替代方案**:
> - **USMART串口调试**: 通过USART1发送命令，如 `motor_enable(1,1)`、`motor_pos_move(1,0,300,10,3200)`
> - **统计功能**: 调用 `emm_uart_print_stats()` 查看发送成功率、错误次数
> - **看门狗监控**: IWDG自动监控通信健康度
> 
> 详见 `Docs/USMART使用指南.md` 和 `.github/copilot-instructions.md`

---

## 🎯 当前状态（历史参考）

**好消息**：CH340有信号灯闪烁说明数据已经发送到RS485总线！

现在问题可能是：
1. 数据确实到达CH340但串口助手没收到
2. 数据格式或波特率问题
3. CH340驱动或USB线问题

## 📊 新增调试功能

### V2.1增强功能

现在测试代码会显示更多信息：
```
[1000] 发送测试帧 #1 (200字节): 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F ...
    --> 发送成功
    --> USART2状态寄存器: 0x00C0 [TXE] [TC] 
    --> IDLE中断次数: 0        ← 新增：监控是否有回环数据
    --> FIFO当前占用: 0%       ← 新增：监控FIFO状态
```

### 关键指标说明

#### IDLE中断次数
- **=0**: 没有收到任何数据（正常，因为是单向发送）
- **>0**: 收到了数据（可能是回环测试或对方设备回复）

#### FIFO占用率
- **0%**: FIFO为空（正常，没有接收数据）
- **>0%**: 有数据在FIFO中等待处理

## 🔍 逐步排查

### 第1步：确认发送成功

**期望看到**：
```
    --> 发送成功
    --> USART2状态寄存器: 0x00C0 [TXE] [TC]
```

**如果看到** `[ORE溢出!]` 或 `[FE帧错误!]` → 硬件问题

### 第2步：检查CH340串口助手

#### 串口助手配置核对清单
- [ ] 波特率：**115200**
- [ ] 数据位：**8**
- [ ] 停止位：**1**
- [ ] 校验位：**无**
- [ ] 显示方式：**HEX十六进制** （非常重要！）
- [ ] COM口选择：**正确的CH340端口**

#### 常见错误
1. **波特率错误**：
   - 如果设置成9600，数据会是乱码
   - 如果设置成256000，完全收不到
   
2. **显示方式错误**：
   - 如果是"文本显示"，二进制数据会显示乱码
   - 必须用"HEX显示"

3. **COM口选择错误**：
   - 检查设备管理器，确认CH340的COM口号
   - 如果有多个串口，可能选错了

### 第3步：验证CH340硬件

#### 测试方法1：回环测试
在CH340模块上短接A-B（如果有接线端子）：
```
CH340的A ----+
             |
CH340的B ----+
```
发送数据，如果能收到，说明CH340正常。

#### 测试方法2：更换USB线
- 某些USB线是充电线（没有数据线）
- 尝试更换USB数据线

#### 测试方法3：更换电脑USB口
- USB3.0口（蓝色）有时有兼容问题
- 尝试USB2.0口（黑色）

#### 测试方法4：重装驱动
```
设备管理器 → 端口 → CH340 → 右键 → 卸载设备
拔掉USB → 重新插上 → 自动安装驱动
```

### 第4步：验证数据是否真的发出去了

#### 方法1：用示波器/逻辑分析仪
测量PA2引脚：
- 空闲时：3.3V高电平
- 发送时：应该看到方波信号（115200bps = 8.68μs/bit）

#### 方法2：用另一套STM32设备
如果你有另一套STM32+RS485模块：
```
STM32_1 发送端         STM32_2 接收端
ATK-MB024 A  <----->  ATK-MB024 A
ATK-MB024 B  <----->  ATK-MB024 B
GND          <----->  GND
```
- STM32_1 `RS485_TEST_MODE=1` 发送模式
- STM32_2 `RS485_TEST_MODE=1` 接收模式
- 观察STM32_2的USART1日志

#### 方法3：简化测试（减少变量）
将STM32的ATK-MB024模块A-B短接（回环）：
```
ATK-MB024模块
A ----+
      |  (短接)
B ----+
```
- 如果IDLE中断次数增加 → 说明发送和接收都正常
- 如果收到数据 → 问题在CH340

## 🧪 特殊测试方案

### 方案A：超长时间观察
让程序运行5分钟：
```
按KEY0 → 发送200字节
等待1秒
再按KEY0 → 再发送200字节
...重复20次
```
观察CH340串口助手有没有**任何数据**（哪怕是1个字节的乱码）

### 方案B：大量数据测试
修改测试代码，连续发送：
```c
// 在KEY0按下后连续发送10次
for (int i = 0; i < 10; i++) {
    HAL_UART_Transmit(&g_uart2_handle, test_data, 200, 1000);
    HAL_Delay(10);
}
```
观察CH340是否有**持续的信号灯闪烁**

### 方案C：慢速发送测试
降低波特率到9600：
```c
// main.c
usart_init(9600);  // 改为9600
```
同时串口助手也设置9600，观察是否能收到。

## 📋 完整检查清单

### 硬件层
- [ ] ATK-MB024电源灯亮
- [ ] PA2/PA3导通性良好（万用表<1Ω）
- [ ] A-B线没有接反（A对A，B对B）
- [ ] 所有GND共地
- [ ] CH340的USB线是**数据线**（不是充电线）

### 软件层
- [ ] 固件编译成功（Flash: 29020B）
- [ ] LED0每200ms闪烁
- [ ] 按KEY0后USART1显示"发送成功"
- [ ] CH340驱动已安装（设备管理器可见）

### 串口助手层
- [ ] COM口选择正确
- [ ] 波特率115200
- [ ] HEX显示模式
- [ ] 勾选了"DTR"和"RTS"（如果有）
- [ ] 清空了接收缓冲区

### 逻辑层
- [ ] USART2状态是 `0x00C0 [TXE] [TC]`
- [ ] 没有 `[ORE]` 或 `[FE]` 错误
- [ ] `RS485_TEST_MODE=1` 已设置

## 🎯 下一步建议

### 立即尝试（优先级排序）

1. **检查串口助手HEX模式**（5秒）
   - 很多人忘记切换到HEX显示

2. **交换CH340的A-B线**（10秒）
   - 即使你确认没接反，还是试试

3. **回环测试ATK-MB024**（1分钟）
   - A-B短接，看IDLE中断次数是否增加

4. **更换USB线**（30秒）
   - 排除USB线问题

5. **重装CH340驱动**（2分钟）
   - 卸载后重新插入USB

6. **降低波特率到9600**（3分钟）
   - 修改代码和串口助手同步降速

7. **尝试USART1模式**（5分钟）
   - `RS485_TEST_MODE=2`，PA9/PA10连RS485

## 💡 关键诊断信息

**当前你需要告诉我**：

1. **USART1日志显示什么**？
   ```
   [1000] 发送测试帧 #1 (200字节): ...
       --> 发送成功/失败？
       --> USART2状态寄存器: 0x????
       --> IDLE中断次数: ??
       --> FIFO当前占用: ??%
   ```

2. **CH340串口助手显示什么**？
   - 完全没数据？
   - 有乱码？
   - 有部分数据？
   - 截图最好

3. **ATK-MB024回环测试结果**？
   - A-B短接后，IDLE中断次数有变化吗？

4. **CH340在设备管理器中的状态**？
   - COM口号是多少？
   - 有黄色感叹号吗？

---

**现在最重要的是：先做回环测试！这能快速定位问题是在STM32端还是CH340端！**
