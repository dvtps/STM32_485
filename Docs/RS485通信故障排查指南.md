# RS485通信故障排查指南

> ⚠️ **部分内容已过时** (V3.0架构)
> 
> 本文档部分章节引用的测试模式和函数已在V3.0架构优化中移除。
> 
> **V3.0更新**:
> - 不再使用 `RS485_TEST_MODE` 宏定义测试模式
> - `rs485_test_gpio()` 等调试函数已删除
> - 新增 **USMART串口调试工具**，通过串口命令调用电机函数
> - 新增 `emm_uart_print_stats()` 查看通信统计
> 
> **参考最新文档**:
> - `Docs/USMART使用指南.md` - 串口调试工具
> - `.github/copilot-instructions.md` - V3.0完整架构
> - `Docs/架构优化总结_V3.0.md` - 优化详情

---

## 问题描述
连接了ATK-MB024 RS485模块，模块另一侧通过485-USB转CH340连接到电脑串口助手，配置正确但收不到数据。

---

## 排查步骤

### 第一步：确认硬件连接（最常见问题）

#### 1.1 STM32到RS485模块连接
```
STM32 开发板                ATK-MB024 RS485模块
PA2 (USART2_TX)  --------> DI (数据输入)
PA3 (USART2_RX)  <-------- RO (数据输出)
GND              --------> GND
5V/3.3V          --------> VCC
```

**检查要点**:
- ✅ PA2必须连到**DI**（不是A或B！）
- ✅ PA3必须连到**RO**（不是A或B！）
- ✅ 共地是否连接
- ✅ 供电电压是否正确（3.3V或5V，查看模块标识）

#### 1.2 RS485模块到USB转换器连接
```
ATK-MB024              485转USB (CH340)
A+         <--------->  A+
B-         <--------->  B-
```

**检查要点**:
- ✅ **A对A，B对B**（不能交叉！）
- ✅ RS485是差分信号，只需两根线（不需要GND）
- ❌ 如果A-B接反，完全收不到数据

#### 1.3 USB转换器到电脑
- 驱动是否安装（设备管理器查看COM口）
- USB线是否正常（尝试更换）
- 串口号是否正确识别

---

### 第二步：启用RS485测试模式

#### 2.1 修改配置文件
打开 `Core/App/test_mode.h`，修改：
```c
#define RS485_TEST_MODE     1  // 从0改为1
```

#### 2.2 重新编译烧录
```powershell
cmake --build --preset Debug
# 烧录 build/Debug/STM32_485.elf
```

#### 2.3 观察测试输出

**连接USART1（调试口）到USB-TTL模块**:
```
STM32     USB-TTL
PA9(TX) → RX
PA10(RX)← TX
GND     → GND
```

打开串口助手（115200-8-N-1），你应该看到：
```
========================================
  RS485通信测试程序 V1.0
========================================
硬件连接检查:
  STM32 PA2(TX) --> RS485模块 DI
  STM32 PA3(RX) <-- RS485模块 RO
  RS485模块 A/B --> 485转USB A/B
  485转USB      --> 电脑串口助手

串口助手配置:
  波特率: 115200
  数据位: 8
  停止位: 1
  校验位: 无
  显示方式: HEX显示

开始每秒发送测试数据...
========================================
[1000] 发送测试帧 #1: AA 55 01 02 03 04 05 0D 0A 
    --> 发送成功
    --> USART2状态寄存器: 0x00C0 [TXE] [TC] 

[2000] 发送测试帧 #2: AA 55 01 02 03 04 05 0D 0A 
    --> 发送成功
    --> USART2状态寄存器: 0x00C0 [TXE] [TC] 
```

**同时观察485转USB串口助手（HEX显示模式）**:
如果硬件连接正确，你应该看到：
```
AA 55 01 02 03 04 05 0D 0A
AA 55 01 02 03 04 05 0D 0A
AA 55 01 02 03 04 05 0D 0A
（每秒重复）
```

---

### 第三步：判断问题位置

#### 情况A：USART1调试口有输出，但485转USB无数据
**问题定位**: STM32到RS485模块或RS485总线连接问题

**排查方法**:
1. 用万用表测量PA2引脚电平（空闲时应为高电平3.3V）
2. 检查RS485模块上的DI引脚是否有电平变化
3. 检查A/B端子是否有差分电压（空闲时约±200mV~±2V）
4. 尝试将RS485模块A-B短路（回环测试）
5. 更换RS485模块测试

#### 情况B：USART1调试口无输出
**问题定位**: STM32固件未运行或USART1连接问题

**排查方法**:
1. 检查固件是否正确烧录（LED是否闪烁？）
2. 检查PA9/PA10连接是否正确
3. 检查USB-TTL模块是否工作（更换测试）
4. 尝试按复位键重启

#### 情况C：USART2状态寄存器显示异常
如果看到 `[ORE溢出!]` / `[FE帧错误!]` / `[NE噪声!]`:

**解决方法**:
- ORE溢出：FIFO已满，检查接收处理
- FE帧错误：波特率不匹配或线路质量差
- NE噪声：接线有干扰，检查接地和屏蔽

---

### 第四步：使用USMART调试工具

测试模式下，可以通过USART1发送命令：

#### 4.1 查看USART2配置
在串口助手发送（带回车）:
```
rs485_print_config()
```

应输出：
```
========================================
  USART2配置信息
========================================
波特率: 115200
数据位: 8
停止位: 1
校验位: 无
模式: 收发

寄存器状态:
  SR (状态):   0x00C0
  CR1 (控制1): 0x200C
  ...
========================================
```

#### 4.2 检查GPIO状态
```
rs485_test_gpio()
```

应输出：
```
GPIO引脚状态检查:
  PA2(USART2_TX): 高电平  ← 正常
  PA3(USART2_RX): 高电平  ← 正常

时钟状态检查:
  GPIOA时钟: 已使能  ← 正常
  USART2时钟: 已使能 ← 正常
```

#### 4.3 手动发送单字节测试
```
rs485_send_byte(0xAA)
```

观察485转USB串口助手是否收到 `AA`。

#### 4.4 发送字符串测试
```
rs485_send_string(HELLO)
```

485转USB应收到 `48 45 4C 4C 4F`（HELLO的ASCII码）。

---

### 第五步：常见错误案例

#### 案例1：PA2/PA3直接连接到A/B
**错误**: 将STM32的PA2/PA3当作RS485信号直接连A/B
**现象**: 完全无数据，可能损坏芯片
**解决**: 必须通过RS485转换芯片（如MAX485）

#### 案例2：A-B接反
**错误**: RS485模块的A接到CH340的B，B接到A
**现象**: 完全收不到数据
**解决**: A对A，B对B重新连接

#### 案例3：忘记共地
**错误**: STM32和RS485模块之间没有连接GND
**现象**: 数据不稳定，时有时无
**解决**: 连接GND

#### 案例4：485转USB未上电
**错误**: CH340模块仅通过USB供电，但不足以驱动RS485芯片
**现象**: 电脑识别设备，但收不到数据
**解决**: 检查CH340模块的供电指示灯

#### 案例5：波特率不匹配
**错误**: STM32设置115200，串口助手设置9600
**现象**: 收到乱码
**解决**: 两侧波特率统一为115200

---

### 第六步：使用示波器/逻辑分析仪（高级）

如果有设备，可以测量：

1. **PA2 (TX)**: 应看到115200波特率的方波信号
2. **RS485模块A-B差分**: 应看到±2V~±6V的差分信号
3. **时序**: 每秒发送一次，每次发送9字节（约0.78ms）

---

## 恢复正常电机模式

测试完成后，恢复电机控制：

1. 打开 `Core/App/test_mode.h`
2. 修改 `#define RS485_TEST_MODE 0`
3. 重新编译烧录

---

## 快速诊断检查表

| 检查项 | 正常状态 | 异常处理 |
|-------|---------|---------|
| PA2连接DI | ✅ | 重新连线 |
| PA3连接RO | ✅ | 重新连线 |
| A对A, B对B | ✅ | 调换A-B线 |
| GND共地 | ✅ | 连接GND |
| USART1有调试输出 | ✅ | 检查固件烧录 |
| 485转USB驱动安装 | ✅ | 重装CH340驱动 |
| 两侧波特率115200 | ✅ | 统一波特率 |
| LED心跳闪烁 | ✅ | 按复位键 |
| USART2状态0x00C0 | ✅ | 检查错误标志 |

---

## 联系支持

如果按照以上步骤仍无法解决，请提供：
1. USART1调试输出的完整日志
2. `rs485_print_config()` 的输出结果
3. 硬件连接照片（清晰标注各引脚）
4. 使用的RS485模块型号
5. 使用的485转USB模块型号

---

**最后提示**: 99%的RS485通信问题都是硬件连接错误！请仔细核对接线。
