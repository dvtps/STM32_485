# USART1 RS485测试模式使用指南

> ⚠️ **文档已过时** (V3.0架构)
> 
> 本文档引用的测试文件（`rs485_test.c`、`usart1_rs485_test.c`等）已在V3.0架构优化中删除。
> 
> **V3.0推荐方案**:
> - 使用 **USMART串口调试工具**（通过USART1调用电机控制函数）
> - 参考 `Docs/USMART使用指南.md`
> - 查看 `.github/copilot-instructions.md` 了解V3.0架构

---

## 📋 适用场景（历史参考）

当你的USART2 + ATK-MB024无法通信时，可以用这个模式快速验证：
- ✅ RS485模块是否正常
- ✅ MODBUS设备是否响应
- ✅ 485转USB转换器是否工作

## ⚠️ 重要提示

**使用此模式会失去以下功能**：
- ❌ printf调试输出（被测试数据占用）
- ❌ USMART串口命令（USART1被RS485占用）
- ✅ 但LED闪烁仍然可用

## 🔧 使用步骤

### 第1步：修改测试模式配置

打开 `Core/App/test_mode.h`，修改：
```c
#define RS485_TEST_MODE     2  // 改为2，启用USART1 RS485测试
```

### 第2步：硬件连接

**STM32到RS485模块**：
```
STM32开发板             ATK-MB024模块
PA9  (USART1_TX) -----> RX
PA10 (USART1_RX) <----- TX
GND              -----> GND
3.3V/5V          -----> VCC
```

**RS485模块到MODBUS设备**：
```
ATK-MB024模块           MODBUS设备/485转USB
A                 <---> A
B                 <---> B
GND (可选)        <---> GND
```

### 第3步：编译烧录
```powershell
cmake --build --preset Debug
# 烧录 build/Debug/STM32_485.elf
```

### 第4步：观察现象

**打开485转USB串口助手**（HEX显示，115200波特率）:
```
AA 55 01 02 03 04 05 0D 0A   ← 每秒重复接收
AA 55 01 02 03 04 05 0D 0A
AA 55 01 02 03 04 05 0D 0A
```

**同时观察LED0**：应该每秒闪烁一次

---

## 🔍 对比三种测试模式

| 模式 | test_mode.h设置 | 使用串口 | 引脚 | printf可用 | 适用场景 |
|-----|----------------|---------|------|-----------|---------|
| **模式0** | `RS485_TEST_MODE=0` | 无测试 | - | ✅ 是 | 正常电机控制 |
| **模式1** | `RS485_TEST_MODE=1` | USART2 | PA2/PA3 | ✅ 是 | 测试USART2+RS485模块 |
| **模式2** | `RS485_TEST_MODE=2` | USART1 | PA9/PA10 | ❌ 否 | 测试USART1+RS485模块 |

---

## 📊 预期结果

### ✅ 成功的标志

1. **LED0每秒闪烁** - 说明程序正常运行
2. **485转USB每秒收到数据** - 说明USART1→RS485→485转USB链路正常
3. **数据内容正确** - `AA 55 01 02 03 04 05 0D 0A`

### ❌ 失败的可能原因

| 现象 | 可能原因 | 解决方法 |
|-----|---------|---------|
| LED不闪烁 | 固件未烧录/死机 | 重新烧录/按复位键 |
| 485转USB无数据 | PA9/PA10接线错误 | 检查TX→RX, RX→TX |
| 485转USB无数据 | A-B接反 | 交换A-B线 |
| 485转USB无数据 | RS485模块故障 | 更换模块 |
| 收到乱码 | 波特率不匹配 | 确认115200 |

---

## 🎯 诊断流程

### 如果模式2可以收到数据，模式1收不到

**说明**：USART1正常，问题在USART2或PA2/PA3
- 检查PA2/PA3的硬件连接
- 检查USART2初始化代码
- 可能是ATK-MB024模块有问题

### 如果模式1和模式2都收不到数据

**说明**：问题在RS485模块或485转USB
- 检查RS485模块供电（LED是否亮）
- 检查A-B接线（务必A对A，B对B）
- 更换RS485模块测试
- 更换485转USB转换器测试

### 如果两种模式都能收到数据

**说明**：STM32和RS485硬件都正常
- 恢复 `RS485_TEST_MODE=0` 进入正常模式
- 问题可能在电机通信协议层
- 检查电机地址、波特率配置

---

## 🔄 恢复正常模式

测试完成后，恢复电机控制模式：

1. 打开 `Core/App/test_mode.h`
2. 修改 `#define RS485_TEST_MODE 0`
3. **重新连接硬件**：
   - PA9/PA10 → USB-TTL（恢复调试功能）
   - PA2/PA3 → ATK-MB024模块（恢复电机通信）
4. 重新编译烧录

---

## 💡 使用技巧

### 快速验证RS485模块
如果你只是想快速确认RS485模块是否正常：
1. 设置 `RS485_TEST_MODE=2`
2. PA9/PA10连接RS485模块
3. 观察485转USB是否收到 `AA 55...`
4. 如果收到，说明模块正常

### 调试MODBUS通信
如果你要调试实际MODBUS协议：
1. 保持 `RS485_TEST_MODE=0`（正常模式）
2. PA9/PA10连USB-TTL看printf日志
3. PA2/PA3连RS485模块通信
4. 两个串口助手同时打开，完整监控

---

## ❓ 常见问题

**Q: 为什么模式2没有printf输出？**  
A: 因为USART1被RS485通信占用了，printf无法工作。但LED闪烁可以指示程序运行。

**Q: 能否同时使用USART1和USART2测试？**  
A: 可以，但需要修改代码。当前设计是三选一的模式切换。

**Q: 模式2下如何调试？**  
A: 只能通过LED闪烁、485转USB收到的数据、或者使用调试器断点。

**Q: 测试完忘记改回模式0会怎样？**  
A: 电机不会动，printf无输出，但不会损坏硬件。记得改回来即可。

---

**最后提醒**：模式2是排查工具，确认硬件正常后请立即切换回模式0或模式1！
