# V3.5 Phase 2: å¤šç”µæœºç®¡ç†ä¼˜åŒ–

## ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬**: V3.5 Phase 2
- **å¼€å§‹æ—¥æœŸ**: 2025-12-02
- **çŠ¶æ€**: ğŸš§ è§„åˆ’ä¸­
- **ä¾èµ–**: âœ… V3.5 Phase 1 å†…å­˜æ± æ¨¡å—å·²å®Œæˆ

## ä¸€ã€ç›®æ ‡ä¸åŠ¨æœº

### 1.1 å½“å‰ç—›ç‚¹
åŸºäºV3.0æ¶æ„çš„å•ç”µæœºæ§åˆ¶å·²ç¨³å®šè¿è¡Œ,ä½†å­˜åœ¨ä»¥ä¸‹å±€é™:

```c
// å½“å‰å®ç°(motor_zdt.c): å•ç”µæœºç¡¬ç¼–ç 
Emm_V5_Pos_Control(0x01, 0, 300, 10, 3200, false, false);  // å›ºå®šåœ°å€1
```

**é—®é¢˜åˆ†æ**:
1. **å¯æ‰©å±•æ€§å·®**: å¢åŠ ç”µæœºéœ€è¦å¤åˆ¶å¤§é‡ä»£ç 
2. **èµ„æºæµªè´¹**: æ¯ä¸ªç”µæœºéœ€è¦ç‹¬ç«‹çš„çŠ¶æ€å˜é‡å’Œå¸§ç¼“å†²åŒº
3. **é”™è¯¯å¤„ç†åˆ†æ•£**: è¶…æ—¶ã€é‡ä¼ é€»è¾‘é‡å¤å®ç°
4. **è°ƒè¯•å›°éš¾**: å¤šç”µæœºçŠ¶æ€éš¾ä»¥ç»Ÿä¸€ç›‘æ§

### 1.2 è®¾è®¡ç›®æ ‡
1. **åŠ¨æ€ç®¡ç†**: æ”¯æŒ1-8ä¸ªç”µæœºåŠ¨æ€æ·»åŠ /ç§»é™¤
2. **èµ„æºå¤ç”¨**: ä½¿ç”¨Phase 1å†…å­˜æ± ,é¿å…é™æ€æ•°ç»„æµªè´¹
3. **ç»Ÿä¸€æ¥å£**: å°è£…`Emm_V5_*`ä½çº§API,æä¾›é«˜å±‚æ§åˆ¶æ¥å£
4. **çŠ¶æ€è¿½è¸ª**: å®æ—¶ç›‘æ§æ¯ä¸ªç”µæœºçš„ä½ç½®ã€é€Ÿåº¦ã€ä½¿èƒ½çŠ¶æ€
5. **æ‰¹é‡æ“ä½œ**: æ”¯æŒå¤šç”µæœºåŒæ­¥è¿åŠ¨ã€ä¸²è¡Œè¿åŠ¨
6. **å¥å£®æ€§**: è‡ªåŠ¨é‡è¯•ã€è¶…æ—¶æ£€æµ‹ã€é”™è¯¯æ¢å¤

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 å››å±‚æ¶æ„

```
åº”ç”¨å±‚ (motor_app.c)              # ä¸šåŠ¡é€»è¾‘: æŒ‰é”®æ§åˆ¶ã€åºåˆ—åŠ¨ä½œ
    â†“
å¤šç”µæœºç®¡ç†å±‚ (multi_motor_mgr.c)  # âœ¨ æ–°å¢: åŠ¨æ€ç®¡ç†ã€çŠ¶æ€è¿½è¸ª
    â†“
åè®®å±‚ (emm_v5.c)                  # ç°æœ‰: Emm_V5åè®®å°è£…
    â†“
é€šä¿¡å±‚ (emm_uart.c)                # ç°æœ‰: RS485ç»Ÿä¸€å‘é€æ¥å£
```

### 2.2 æ ¸å¿ƒæ•°æ®ç»“æ„

```c
/* å•ä¸ªç”µæœºçŠ¶æ€ (64å­—èŠ‚, ä½¿ç”¨status_pool) */
typedef struct {
    uint8_t  address;              // ç”µæœºåœ°å€(1-255)
    bool     enabled;              // ä½¿èƒ½çŠ¶æ€
    uint8_t  health;               // å¥åº·åº¦(0-100%)
    uint32_t position;             // å½“å‰ä½ç½®(è„‰å†²æ•°)
    int16_t  velocity;             // å½“å‰é€Ÿåº¦(RPM)
    uint16_t vbus;                 // æ€»çº¿ç”µå‹(mV)
    uint32_t error_count;          // ç´¯è®¡é”™è¯¯æ¬¡æ•°
    uint32_t last_response_tick;   // æœ€åå“åº”æ—¶é—´(ms)
    uint8_t  reserved[36];         // é¢„ç•™æ‰©å±•
} motor_state_t;

/* å¤šç”µæœºç®¡ç†å™¨ */
typedef struct {
    motor_state_t *motors[8];      // ç”µæœºçŠ¶æ€æŒ‡é’ˆæ•°ç»„(æœ€å¤š8ä¸ª)
    uint8_t motor_count;           // å½“å‰ç”µæœºæ•°é‡
    uint32_t last_scan_tick;       // æœ€åæ‰«ææ—¶é—´
    uint8_t scan_errors;           // æ‰«æé”™è¯¯è®¡æ•°
} motor_manager_t;
```

### 2.3 å†…å­˜æ± é›†æˆ

Phase 1å·²å®ç°çš„å†…å­˜æ± :
- **å¸§æ± **: 4å— Ã— 256B (ç”¨äºé€šä¿¡ç¼“å†²)
- **çŠ¶æ€æ± **: 8å— Ã— 64B (ç”¨äº`motor_state_t`)

```c
/* æ·»åŠ æ–°ç”µæœºæ—¶åˆ†é…çŠ¶æ€ */
motor_state_t *state = mem_pool_alloc(&g_status_pool);
if (state) {
    memset(state, 0, sizeof(motor_state_t));
    state->address = addr;
    mgr->motors[mgr->motor_count++] = state;
}

/* ç§»é™¤ç”µæœºæ—¶é‡Šæ”¾çŠ¶æ€ */
mem_pool_free(&g_status_pool, mgr->motors[idx]);
mgr->motors[idx] = NULL;
```

## ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 3.1 ç”µæœºå‘ç°ä¸åˆå§‹åŒ–

```c
/**
 * @brief æ‰«æRS485æ€»çº¿ä¸Šçš„ç”µæœº
 * @param start_addr èµ·å§‹åœ°å€(1-255)
 * @param end_addr ç»“æŸåœ°å€(1-255)
 * @return å‘ç°çš„ç”µæœºæ•°é‡
 */
uint8_t motor_mgr_scan(uint8_t start_addr, uint8_t end_addr);

/* å®ç°åŸç†:
 * 1. å¾ªç¯å‘é€æŸ¥è¯¢ä½¿èƒ½å‘½ä»¤(0x2A)åˆ°æ¯ä¸ªåœ°å€
 * 2. ç­‰å¾…50mså“åº”è¶…æ—¶
 * 3. æ”¶åˆ°å“åº”åˆ™è°ƒç”¨motor_mgr_add()æ·»åŠ ç”µæœº
 * 4. æ›´æ–°æ¯ä¸ªç”µæœºçš„åˆå§‹çŠ¶æ€
 */
```

### 3.2 çŠ¶æ€æŸ¥è¯¢ä¸ç›‘æ§

```c
/**
 * @brief æŸ¥è¯¢æ‰€æœ‰ç”µæœºçŠ¶æ€
 * @return HAL_StatusTypeDef HAL_OK=æˆåŠŸ
 */
HAL_StatusTypeDef motor_mgr_update_all_status(void);

/* æŸ¥è¯¢é¡¹ç›®:
 * - ä½¿èƒ½çŠ¶æ€: Emm_V5_Read_Sys_Params(addr, 0x2A, false)
 * - å½“å‰ä½ç½®: Emm_V5_Read_Sys_Params(addr, 0x33, false)
 * - å½“å‰é€Ÿåº¦: Emm_V5_Read_Sys_Params(addr, 0x35, false)
 * - æ€»çº¿ç”µå‹: Emm_V5_Read_Sys_Params(addr, 0x24, false)
 * 
 * æ›´æ–°é¢‘ç‡: 100ms(ä¸»å¾ªç¯è°ƒç”¨)
 * è¶…æ—¶å¤„ç†: 3æ¬¡å¤±è´¥æ ‡è®°ä¸ºç¦»çº¿
 */
```

### 3.3 æ‰¹é‡æ§åˆ¶æ¥å£

```c
/**
 * @brief æ‰¹é‡ä½¿èƒ½ç”µæœº
 * @param addrs ç”µæœºåœ°å€æ•°ç»„
 * @param count ç”µæœºæ•°é‡
 * @return æˆåŠŸä½¿èƒ½çš„æ•°é‡
 */
uint8_t motor_mgr_enable_batch(uint8_t *addrs, uint8_t count);

/**
 * @brief å¤šç”µæœºåŒæ­¥è¿åŠ¨
 * @param moves è¿åŠ¨å‚æ•°æ•°ç»„(åœ°å€ã€æ–¹å‘ã€é€Ÿåº¦ã€è„‰å†²æ•°)
 * @param count ç”µæœºæ•°é‡
 * @return HAL_StatusTypeDef
 */
HAL_StatusTypeDef motor_mgr_sync_move(motor_move_t *moves, uint8_t count);

/* å®ç°æµç¨‹:
 * 1. éå†æ•°ç»„,ä¾æ¬¡å‘é€ä½ç½®å‘½ä»¤(snF=true)
 * 2. æœ€åå‘é€åŒæ­¥è¿åŠ¨å‘½ä»¤(åœ°å€0)
 * 3. ç­‰å¾…æ‰€æœ‰ç”µæœºåˆ°ä½(æ£€æŸ¥FLAGå¼•è„šæˆ–è½®è¯¢çŠ¶æ€)
 */
```

### 3.4 é”™è¯¯å¤„ç†ä¸æ¢å¤

```c
/**
 * @brief æ£€æŸ¥ç”µæœºå¥åº·çŠ¶æ€
 * @param addr ç”µæœºåœ°å€
 * @return å¥åº·åº¦(0-100%)
 */
uint8_t motor_mgr_get_health(uint8_t addr);

/* å¥åº·åº¦è®¡ç®—:
 * - åŸºç¡€åˆ†: 100
 * - æ¯æ¬¡è¶…æ—¶: -10åˆ†
 * - æ¯æ¬¡æˆåŠŸå“åº”: +5åˆ†(æœ€é«˜100)
 * - <20åˆ†: æ ‡è®°ä¸ºæ•…éšœ,åœæ­¢å‘é€å‘½ä»¤
 * 
 * è‡ªåŠ¨æ¢å¤:
 * - æ¯30ç§’é‡æ–°æ‰«æç¦»çº¿ç”µæœº
 * - æ¢å¤åé‡æ–°ä½¿èƒ½
 */
```

## å››ã€å®ç°è®¡åˆ’

### 4.1 æ–‡ä»¶ç»„ç»‡

```
Drivers/Middlewares/MULTI_MOTOR/
â”œâ”€â”€ multi_motor_manager.c    # å¤šç”µæœºç®¡ç†æ ¸å¿ƒ
â”œâ”€â”€ multi_motor_manager.h    # APIæ¥å£
â””â”€â”€ motor_state.h             # çŠ¶æ€æ•°æ®ç»“æ„

Core/App/
â”œâ”€â”€ motor_app.c               # åº”ç”¨å±‚ç¤ºä¾‹(æ›¿æ¢motor_zdt.c)
â””â”€â”€ motor_app.h
```

### 4.2 å¼€å‘æ­¥éª¤

**Step 1: æ•°æ®ç»“æ„å®šä¹‰** (30åˆ†é’Ÿ)
- [ ] å®šä¹‰`motor_state_t`ç»“æ„ä½“
- [ ] å®šä¹‰`motor_manager_t`å…¨å±€ç®¡ç†å™¨
- [ ] å®ç°å†…å­˜æ± åˆ†é…/é‡Šæ”¾å°è£…å‡½æ•°

**Step 2: åŸºç¡€ç®¡ç†åŠŸèƒ½** (1å°æ—¶)
- [ ] `motor_mgr_init()` - åˆå§‹åŒ–ç®¡ç†å™¨
- [ ] `motor_mgr_add()` - æ·»åŠ ç”µæœº
- [ ] `motor_mgr_remove()` - ç§»é™¤ç”µæœº
- [ ] `motor_mgr_find()` - æ ¹æ®åœ°å€æŸ¥æ‰¾ç”µæœº

**Step 3: çŠ¶æ€æŸ¥è¯¢åŠŸèƒ½** (1.5å°æ—¶)
- [ ] `motor_mgr_query_enable()` - æŸ¥è¯¢ä½¿èƒ½çŠ¶æ€
- [ ] `motor_mgr_query_position()` - æŸ¥è¯¢ä½ç½®
- [ ] `motor_mgr_query_velocity()` - æŸ¥è¯¢é€Ÿåº¦
- [ ] `motor_mgr_update_all_status()` - æ‰¹é‡æ›´æ–°çŠ¶æ€

**Step 4: æ‰¹é‡æ§åˆ¶åŠŸèƒ½** (1å°æ—¶)
- [ ] `motor_mgr_enable_batch()` - æ‰¹é‡ä½¿èƒ½
- [ ] `motor_mgr_sync_move()` - åŒæ­¥è¿åŠ¨
- [ ] `motor_mgr_stop_all()` - æ€¥åœæ‰€æœ‰ç”µæœº

**Step 5: é”™è¯¯å¤„ç†ä¸ç›‘æ§** (1å°æ—¶)
- [ ] `motor_mgr_check_timeout()` - è¶…æ—¶æ£€æµ‹
- [ ] `motor_mgr_get_health()` - å¥åº·åº¦è®¡ç®—
- [ ] `motor_mgr_auto_recover()` - è‡ªåŠ¨æ¢å¤

**Step 6: USMARTè°ƒè¯•æ¥å£** (30åˆ†é’Ÿ)
- [ ] `mm_scan(start,end)` - æ‰«æç”µæœº
- [ ] `mm_list()` - åˆ—å‡ºæ‰€æœ‰ç”µæœºçŠ¶æ€
- [ ] `mm_move(addr,dir,speed,acc,pulse)` - å•ç”µæœºè¿åŠ¨
- [ ] `mm_sync_move(...)` - å¤šç”µæœºåŒæ­¥è¿åŠ¨

**Step 7: åº”ç”¨å±‚ç¤ºä¾‹** (1å°æ—¶)
- [ ] åˆ›å»º`motor_app.c`,å®ç°æŒ‰é”®æ§åˆ¶å¤šç”µæœº
- [ ] ç¤ºä¾‹1: KEY0è§¦å‘ç”µæœº1è½¬1åœˆ
- [ ] ç¤ºä¾‹2: WKUPè§¦å‘ç”µæœº1+2åŒæ­¥è¿åŠ¨
- [ ] ç¤ºä¾‹3: å®šæ—¶æŸ¥è¯¢æ‰€æœ‰ç”µæœºçŠ¶æ€

**Step 8: ç¡¬ä»¶æµ‹è¯•** (2å°æ—¶)
- [ ] å•ç”µæœºæ·»åŠ /ç§»é™¤æµ‹è¯•
- [ ] åŒç”µæœºåŒæ­¥è¿åŠ¨æµ‹è¯•
- [ ] å¥åº·åº¦ç›‘æ§æµ‹è¯•
- [ ] è¶…æ—¶æ¢å¤æµ‹è¯•
- [ ] èµ„æºå ç”¨æµ‹è¯•(Flash/RAM)

**é¢„è®¡æ€»æ—¶é—´**: 8.5å°æ—¶

### 4.3 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½æ€§æµ‹è¯•**:
1. âœ… æ‰«æå‘ç°2ä¸ªç”µæœº(åœ°å€1å’Œ2)
2. âœ… å•ç”µæœºæ§åˆ¶æ­£å¸¸(ä½¿èƒ½ã€è¿åŠ¨ã€åœæ­¢)
3. âœ… åŒç”µæœºåŒæ­¥è¿åŠ¨è¯¯å·®<5ms
4. âœ… çŠ¶æ€æŸ¥è¯¢å‡†ç¡®(ä½ç½®ã€é€Ÿåº¦ã€ç”µå‹)
5. âœ… è¶…æ—¶è‡ªåŠ¨æ ‡è®°ç¦»çº¿(3æ¬¡å¤±è´¥)
6. âœ… ç¦»çº¿ç”µæœºè‡ªåŠ¨æ¢å¤(30ç§’é‡è¯•)

**æ€§èƒ½æŒ‡æ ‡**:
- Flashå¢é‡: <8KB
- RAMå¢é‡: <1KB(åŠ¨æ€ä½¿ç”¨å†…å­˜æ± )
- çŠ¶æ€æ›´æ–°å‘¨æœŸ: 100ms
- å‘½ä»¤å“åº”å»¶è¿Ÿ: <50ms

**ä»£ç è´¨é‡**:
- æ— ç¼–è¯‘è­¦å‘Š
- Doxygenæ³¨é‡Šå®Œæ•´
- é€šè¿‡USMARTåŠŸèƒ½æµ‹è¯•
- æ›´æ–°é¡¹ç›®æ–‡æ¡£

## äº”ã€è¿›é˜¶æ‰©å±•(Phase 3å¯é€‰)

1. **è¿åŠ¨è§„åˆ’å™¨**:
   - æ¢¯å½¢åŠ å‡é€Ÿè½¨è¿¹ç”Ÿæˆ
   - å¤šè½´æ’è¡¥(ç›´çº¿ã€åœ†å¼§)
   - è·¯å¾„å¹³æ»‘

2. **åé¦ˆé—­ç¯**:
   - ç¼–ç å™¨ä½ç½®æ ¡å‡†
   - é€Ÿåº¦PIæ§åˆ¶
   - åŠ›çŸ©è¡¥å¿

3. **é€šä¿¡ä¼˜åŒ–**:
   - æŸ¥è¯¢å‘½ä»¤åˆå¹¶(å‡å°‘æ€»çº¿å ç”¨)
   - DMAä¼ è¾“(æå‡ååé‡)
   - ä¸»åŠ¨ä¸ŠæŠ¥æ¨¡å¼(å‡å°‘è½®è¯¢)

4. **æ•…éšœè¯Šæ–­**:
   - è¿‡æµæ£€æµ‹
   - å¤±æ­¥æ£€æµ‹
   - æ¸©åº¦ç›‘æ§

## å…­ã€å…¼å®¹æ€§ä¿è¯

**å‘åå…¼å®¹**:
- ä¿ç•™`Emm_V5_*` APIä¸å˜,ä»…å¢åŠ é«˜å±‚å°è£…
- `motor_zdt.c`å¯ç»§ç»­ä½¿ç”¨(å•ç”µæœºç®€å•åœºæ™¯)
- å†…å­˜æ± å¯é€‰(å¯å›é€€åˆ°é™æ€æ•°ç»„)

**é…ç½®å¼€å…³**:
```c
/* Core/App/app_config.h */
#define FEATURE_MULTI_MOTOR_ENABLE  1  // 0=ç¦ç”¨å¤šç”µæœºç®¡ç†
#define MAX_MOTOR_COUNT             8  // æœ€å¤§ç”µæœºæ•°é‡(1-16)
#define MOTOR_HEALTH_THRESHOLD      20 // å¥åº·åº¦é˜ˆå€¼
```

## ä¸ƒã€å‚è€ƒèµ„æ–™

- V3.5 Phase 1: å†…å­˜æ± æ¨¡å—(`Docs/V3.5-Phase1-å†…å­˜æ± æµ‹è¯•æŒ‡å—.md`)
- Emm_V5åè®®: `Docs/doc_Y57/02-é€šä¿¡åè®®.md`
- å¤šæœºé€šè®¯: `Docs/doc_Y57/06-å¤šæœºé€šè®¯.md`
- åŒæ­¥è¿åŠ¨: `Docs/doc_Y57/04-ä½ç½®å’Œé€Ÿåº¦æ§åˆ¶.md`(ç¬¬8èŠ‚)

---

**å¼€å‘è€…**: GitHub Copilot (Claude Sonnet 4.5)  
**æœ€åæ›´æ–°**: 2025-12-02 14:45
