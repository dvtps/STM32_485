# Phase 7: 生产级硬件验证测试指导文档

**版本**: V1.0  
**日期**: 2025-12-02  
**项目**: STM32F103 步进电机控制系统  
**测试目标**: 生产环境可靠性验证

---

## 📋 文档导航

本文档是Phase 7硬件验证测试的总览和入口，详细测试步骤分布在以下子文档中：

| 序号 | 文档名称 | 测试类型 | 预计耗时 | 文档路径 |
|------|----------|----------|----------|----------|
| 1 | **48小时长时间运行测试** | 稳定性测试 | 48小时 | `V3.5-Phase7-01-长时间运行测试.md` |
| 2 | **故障注入测试** | 容错性测试 | 8小时 | `V3.5-Phase7-02-故障注入测试.md` |
| 3 | **通信成功率压力测试** | 性能测试 | 4小时 | `V3.5-Phase7-03-通信压力测试.md` |
| 4 | **测试记录与数据分析** | 数据管理 | - | `V3.5-Phase7-04-测试记录模板.md` |

---

## 🎯 测试目标与验收标准

### 总体目标
验证STM32F103步进电机控制系统在生产环境下的可靠性、稳定性和容错能力，确保系统满足工业级应用要求。

### 核心验收标准

#### 1. 可靠性指标
- **MTBF（平均无故障时间）**: ≥ 1000小时（推算）
- **48小时连续运行**: 0次系统崩溃
- **看门狗复位次数**: ≤ 5次/48h（可接受范围）
- **电机失步率**: < 0.01%

#### 2. 通信性能指标
- **RS485通信成功率**: ≥ 99.9%
- **帧错误率**: < 0.1%
- **指令响应时间**: 平均 < 10ms, 最大 < 50ms
- **高并发命令处理**: 支持100次/秒连续指令

#### 3. 容错性指标
- **电源波动恢复**: 电压跌落至10.5V后自动恢复
- **通信超时处理**: 3次重试机制有效率 > 95%
- **异常保护响应**: 过流/堵转检测响应 < 100ms
- **紧急停止时间**: < 50ms

#### 4. 环境适应性
- **温度范围**: -10°C ~ 60°C正常工作
- **湿度范围**: 20% ~ 80% RH无凝露
- **EMI抗扰度**: GB/T 17626.4 Level 3（接触放电±6kV）

---

## 🔧 测试前准备工作

### 硬件清单

#### 必备设备
| 设备名称 | 数量 | 规格要求 | 用途 |
|----------|------|----------|------|
| 正点原子M48Z-M3开发板 | 1 | STM32F103C8 | 主控板 |
| 张大头Y57闭环步进电机 | 1-3 | 16细分，带编码器 | 被测电机 |
| ATK-MB024 RS485模块 | 1 | MAX485芯片 | 通信转换 |
| 稳压电源（24V） | 1 | 24V/3A, 纹波<100mV | 电机供电 |
| USB转TTL模块 | 1 | CH340/FT232 | USART1调试 |
| USB转RS485模块 | 1 | 可选，用于监控 | 通信监测 |
| 示波器 | 1 | 100MHz, 4通道 | 信号分析 |
| 数字万用表 | 1 | 真有效值 | 电压电流测量 |
| 负载模块（可选） | 1 | 机械负载/飞轮 | 负载测试 |

#### 辅助工具
- **数据记录工具**: Excel/CSV自动记录表格
- **串口助手**: 支持时间戳和日志保存（推荐XCOM、Putty）
- **秒表/计时器**: 精确计时
- **温湿度计**: 环境监测
- **UPS不间断电源**: 防止测试中断
- **散热风扇**: 长时间运行散热

### 软件准备

#### 固件版本
```bash
# 确保使用V3.0+版本固件
项目版本: STM32_485 V3.0
HAL库版本: STM32Cube_FW_F1_V1.8.0
编译日期: 2025-12-01
```

#### 配置检查清单
```c
// app_config.h 关键配置
#define MOTOR_ADDRESS            0x01    // 电机地址
#define MOTOR_SPEED              300     // 默认速度(RPM)
#define MOTOR_ACCELERATION       10      // 加速度
#define MOTOR_PULSES_PER_CIRCLE  3200    // 脉冲/圈
#define FEATURE_WATCHDOG_ENABLE  1       // 看门狗必须启用
#define RS485_TIMEOUT_MS         100     // 通信超时
```

#### 测试固件编译
```powershell
# 编译Debug版本（包含调试信息）
cmake --preset Debug
cmake --build --preset Debug

# 烧录到开发板
# 使用STM32CubeProgrammer或OpenOCD
openocd -f interface/stlink.cfg -f target/stm32f1x.cfg `
        -c "program build/Debug/STM32_485.elf verify reset exit"
```

### 测试环境搭建

#### 硬件连接图
```
┌─────────────────────────────────────────────────────────┐
│                     测试系统拓扑                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  PC (串口助手)                                          │
│    │                                                    │
│    │ USB                                                │
│    ▼                                                    │
│  USB转TTL ──── USART1(PA9/PA10) ──┐                   │
│                                    │                   │
│                              STM32F103C8               │
│                              (M48Z-M3)                 │
│  USB转RS485 ──┬── RS485-A ────────┤                   │
│    (监控可选)  │                    USART2(PA2/PA3)    │
│                │   RS485-B ────────┤                   │
│                │                    │                   │
│                │   A ───────────────┴─── ATK-MB024     │
│                │   B ────────────────────── (RS485)    │
│                │                                │       │
│                └── 监控分支(可选)              │       │
│                                                 │       │
│                                           RS485-A/B     │
│                                                 │       │
│                                        张大头Y57电机    │
│                                        (地址0x01)       │
│                                                 │       │
│  稳压电源 24V/3A ───────────────────────────┬──┘       │
│                                             │          │
│                                           Motor_VCC    │
│                                           Motor_GND    │
│                                                        │
│  备注:                                                 │
│  1. STM32的5V_IN供电可来自ST-Link或外部5V电源        │
│  2. 电机24V与STM32 5V必须共地                          │
│  3. RS485 A-A, B-B对应连接                            │
│  4. 监控分支使用Y型分线器（高阻抗）                   │
└─────────────────────────────────────────────────────────┘
```

#### 电源连接注意事项
```
⚠️ 关键安全要求:
1. STM32 5V与电机24V必须共地（GND）
2. RS485模块需从STM32取5V，不可接24V
3. 电机24V直接接到电机驱动器电源端子
4. 使用稳压电源，避免使用开关电源（噪声大）
5. 各模块间使用 < 20cm短线，减少干扰
```

#### 串口配置
```
USART1 (调试输出):
  - 波特率: 115200
  - 数据位: 8
  - 停止位: 1
  - 校验位: None
  - 流控: None
  - 功能: printf调试日志输出

USART2 (RS485通信):
  - 波特率: 115200
  - 数据位: 8
  - 停止位: 1
  - 校验位: None
  - 流控: None
  - 功能: 与电机通信（Emm_V5协议）
```

---

## 📊 测试矩阵总览

| 测试ID | 测试项目 | 测试类型 | 优先级 | 预计耗时 | 是否自动化 | 负责人 |
|--------|----------|----------|--------|----------|------------|--------|
| T7.1.1 | 48h连续位置模式运行 | 稳定性 | P0 | 48h | 半自动 | - |
| T7.1.2 | 48h连续速度模式运行 | 稳定性 | P0 | 48h | 半自动 | - |
| T7.1.3 | 内存泄漏检测 | 稳定性 | P1 | 4h | 手动 | - |
| T7.1.4 | 温度循环测试 | 环境 | P1 | 8h | 手动 | - |
| T7.2.1 | 电源跌落恢复 | 容错 | P0 | 2h | 手动 | - |
| T7.2.2 | RS485线缆断开重连 | 容错 | P0 | 1h | 手动 | - |
| T7.2.3 | 通信超时与重试 | 容错 | P1 | 1h | 手动 | - |
| T7.2.4 | 电机堵转保护 | 安全 | P0 | 1h | 手动 | - |
| T7.2.5 | 看门狗复位测试 | 容错 | P1 | 1h | 手动 | - |
| T7.3.1 | 高频命令连发 | 性能 | P0 | 2h | 半自动 | - |
| T7.3.2 | 并发多电机控制 | 性能 | P1 | 2h | 手动 | - |
| T7.3.3 | 极限速度测试 | 性能 | P2 | 1h | 手动 | - |
| T7.3.4 | 通信帧错误注入 | 容错 | P1 | 2h | 手动 | - |

**优先级定义**:
- **P0**: 必须通过，阻塞发布
- **P1**: 应该通过，影响质量
- **P2**: 可选验证，优化项

---

## 🚀 快速开始指南

### 第一次测试的标准流程

#### Step 1: 系统上电自检（5分钟）
```bash
1. 连接所有硬件，按上述拓扑图检查连接
2. 上电前确认：
   - 电源电压24V±0.5V
   - STM32与电机共地
   - RS485 A-B极性正确
3. 给STM32上电，观察LED0闪烁（心跳灯）
4. 打开串口助手连接USART1，查看启动日志：
   ✓ "System Init OK"
   ✓ "Motor Init OK"
   ✓ "USMART v3.x"
```

#### Step 2: 基础功能验证（10分钟）
```bash
# 通过串口助手发送USMART命令
motor_enable(1,1)         # 使能电机，应听到电机"嘟"一声锁定
motor_pos_move(1,0,300,10,3200)  # 顺时针转1圈
motor_pos_move(1,1,300,10,3200)  # 逆时针转1圈
motor_stop(1)             # 急停测试

# 观察日志输出是否有错误
# 观察LED1状态指示
```

#### Step 3: 选择测试场景（根据时间安排）

**场景A: 完整验证（推荐生产前）**
```
总耗时: 约60小时
执行顺序:
  Day 1-2: 48h长时间运行测试 (T7.1.1)
  Day 3上午: 故障注入测试 (T7.2.1-T7.2.5)
  Day 3下午: 通信压力测试 (T7.3.1-T7.3.4)
```

**场景B: 快速验证（开发阶段）**
```
总耗时: 约4小时
执行顺序:
  1小时: 短时间稳定性（6小时版本）
  1小时: 关键故障注入（电源跌落+通信超时）
  2小时: 通信压力测试
```

**场景C: 单项调试（问题复现）**
```
根据问题类型选择对应的测试章节
```

---

## 📈 测试数据管理

### 数据收集方式

#### 自动记录
```c
// 在固件中启用统计功能（已在V3.0集成）
emm_uart_stats_t stats;
emm_uart_get_stats(&stats);

// 定期通过USART1输出统计信息
printf("TX_Success=%lu, TX_Error=%lu, RX_Frames=%lu\n",
       stats.tx_success, stats.tx_error, stats.rx_frames);
```

#### 手动记录
使用Excel表格记录关键数据：
- 测试时间戳
- 测试项目ID
- 测试结果（Pass/Fail）
- 测量数据（电压、电流、温度）
- 异常现象描述
- 复现步骤

**模板位置**: `Docs/V3.5-Phase7-04-测试记录模板.md`

### 日志保存规范
```
日志文件命名: 
  YYYYMMDD_HHMM_TestID_Description.log

示例:
  20251202_1430_T7.1.1_48h_Position_Mode.log
  20251202_1635_T7.2.1_Power_Drop_Test.log

保存路径:
  d:\STM32\Projects\ZDT\STM32_485\Test_Logs\
```

---

## ⚠️ 安全注意事项

### 人员安全
1. **电气安全**: 操作24V电源时注意触电风险，确保绝缘良好
2. **机械安全**: 电机运行时保持安全距离，避免衣物被卷入
3. **紧急停止**: 测试区域准备急停开关，可快速切断电源
4. **防护装备**: 长时间测试建议佩戴护目镜（防飞溅物）

### 设备保护
1. **过流保护**: 电源设置电流限制为3A，防止短路损坏
2. **散热管理**: 长时间运行时给STM32和电机加装散热片
3. **防静电**: 操作开发板前先释放人体静电
4. **备份固件**: 测试前保存可工作的固件版本

### 测试中断处理
```
如遇以下情况立即停止测试:
1. 冒烟、异味、异常发热（>80°C）
2. 电机异常噪音（刺耳尖叫、卡顿）
3. 开发板复位频繁（>5次/分钟）
4. 电源电压跌落至21V以下
5. 通信完全中断超过30秒

停止步骤:
1. 按下急停开关或拔掉电源
2. 记录中断时间和现象
3. 拍照保存现场
4. 分析日志文件
5. 排除故障后重新开始测试
```

---

## 📝 测试报告模板

### 测试摘要表（每日填写）

| 日期 | 测试项 | 执行时间 | 结果 | 问题数 | 备注 |
|------|--------|----------|------|--------|------|
| 2025-12-02 | T7.1.1 48h测试启动 | 14:00-14:30 | 进行中 | 0 | - |
| 2025-12-04 | T7.1.1 48h测试完成 | 14:30 | Pass | 2 | 2次看门狗复位 |
| 2025-12-04 | T7.2.1 电源跌落 | 15:00-17:00 | Pass | 0 | - |

### 问题跟踪表

| 问题ID | 发现日期 | 严重级别 | 问题描述 | 复现步骤 | 状态 | 解决方案 |
|--------|----------|----------|----------|----------|------|----------|
| BUG-001 | 2025-12-02 | P2 | 连续运行12h后LED闪烁变慢 | 长时间运行 | 已修复 | 定时器溢出处理 |
| BUG-002 | 2025-12-03 | P0 | 电源跌落后电机失步 | 电源跌至10V | 待修复 | 增加位置校准 |

---

## 🔍 常见问题FAQ

### Q1: 48小时测试中途可以暂停吗？
**A**: 不建议暂停。如必须暂停：
1. 记录暂停时间点和运行状态
2. 暂停期间保持系统上电
3. 重启后先进行30分钟自检
4. 测试总时长需重新累计48小时

### Q2: 如何判断测试是否通过？
**A**: 参考验收标准：
- 硬指标：无系统崩溃、通信成功率>99.9%
- 软指标：看门狗复位<5次、无数据丢失
- 如有1项硬指标不达标，整体测试Fail

### Q3: 测试中发现Bug如何处理？
**A**: 
1. 立即记录到问题跟踪表
2. 根据严重级别决定是否中断测试
3. P0级别Bug需修复后重新测试
4. P1/P2级别可继续测试，后续修复

### Q4: 没有示波器可以做测试吗？
**A**: 可以，但建议至少有万用表：
- 必须监测：电源电压、电流
- 可选监测：RS485波形质量
- 替代方案：使用串口助手监控通信日志

### Q5: 单电机测试和多电机测试的区别？
**A**: 
- 单电机：主要验证单机稳定性
- 多电机：验证总线负载和同步性能
- 建议先完成单电机测试再做多电机

---

## 📞 技术支持

### 项目联系方式
```
项目仓库: https://github.com/dvtps/STM32_485
问题反馈: GitHub Issues
文档版本: V1.0 (2025-12-02)
```

### 参考资料
- **电机协议**: `Docs/doc_Y57/README.md`
- **STM32集成**: `Docs/doc_Y57/07-STM32集成指南.md`
- **架构说明**: `.github/copilot-instructions.md`
- **项目变更**: `bak/migration_guide.md`

---

## 📅 测试计划建议

### 完整验证时间表（5天计划）

```
Day 1 (周一):
  08:00-09:00  硬件连接与自检
  09:00-10:00  基础功能验证
  10:00-10:30  启动48h长时间测试
  10:30-18:00  并行进行短周期测试（故障注入）

Day 2 (周二):
  全天        48h测试进行中（定期巡检）
  09:00-12:00  通信压力测试
  14:00-18:00  多电机并发测试

Day 3 (周三):
  10:30       48h测试结束，数据分析
  14:00-18:00  补充测试（温度循环等）

Day 4 (周四):
  全天        问题修复与回归测试

Day 5 (周五):
  09:00-12:00  测试报告编写
  14:00-16:00  评审与归档
```

---

## ✅ 测试完成检查清单

在宣布Phase 7完成前，请确认以下所有项：

- [ ] 所有P0级别测试项已通过
- [ ] 80%以上P1级别测试项已通过
- [ ] 测试日志已完整保存并归档
- [ ] 问题跟踪表中所有P0 Bug已修复
- [ ] 测试报告已完成并经过评审
- [ ] 固件版本已打Tag（例如V3.1-Verified）
- [ ] 测试数据已备份到安全位置
- [ ] 测试硬件已清点并妥善保管

---

## 🎓 附录

### 附录A: 术语表
- **MTBF**: Mean Time Between Failures，平均无故障时间
- **EMI**: Electromagnetic Interference，电磁干扰
- **IDLE中断**: 串口空闲中断，用于检测帧结束
- **看门狗**: Watchdog，防止程序死机的硬件定时器

### 附录B: 测试工具下载
- **XCOM串口助手**: https://www.openedv.com/
- **Putty**: https://www.putty.org/
- **STM32CubeProgrammer**: https://www.st.com/

### 附录C: 快速命令参考
```bash
# USMART常用命令
motor_enable(addr,en)           # 使能控制
motor_pos_move(addr,dir,spd,acc,pul)  # 位置模式
motor_vel_move(addr,dir,spd,acc)      # 速度模式
motor_stop(addr)                # 紧急停止
motor_home(addr)                # 回零
delay_ms(ms)                    # 延时（测试用）

# 地址参数：1-255（0为广播地址）
# 方向参数：0=CW顺时针, 1=CCW逆时针
# 速度范围：0-5000 RPM
# 加速度：0-255（0=直接启动）
```

---

**文档结束 | 请继续阅读子文档获取详细测试步骤**

*下一步: 阅读 `V3.5-Phase7-01-长时间运行测试.md` 开始48小时稳定性测试*
