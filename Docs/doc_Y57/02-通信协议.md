# 02 - 通信协议

[← 上一章：产品概述](01-产品概述.md) | [返回目录](README.md) | [下一章：控制命令详解 →](03-控制命令详解.md)

---

## 2.1 协议总览

Y系列电机采用**串行通信协议**，支持三种物理接口：

| 接口类型 | 电平标准 | 最大距离 | 适用场景 |
|---------|---------|---------|---------|
| **TTL串口** | 3.3V/5V | < 3米 | 单机直连、开发调试 |
| **RS485** | 差分 | < 1200米 | 多机总线、工业现场 |
| **CAN总线** | 差分 | < 1000米 | 高可靠、强抗干扰 |

---

## 2.2 通信参数配置

### 2.2.1 串口参数（TTL/RS485）

```
波特率（Baud Rate）: 9600 / 19200 / 38400 / 57600 / 115200 bps
数据位（Data Bits） : 8 位
停止位（Stop Bits） : 1 位
校验位（Parity）    : 无校验（None）
流控制（Flow Ctrl）  : 无
```

**推荐配置**: 115200, 8N1（8数据位，无校验，1停止位）

### 2.2.2 CAN总线参数

```
波特率: 250K / 500K / 1M bps
帧格式: 标准帧（11位ID）或扩展帧（29位ID）
```

---

## 2.3 命令帧格式

### 2.3.1 通用帧结构

所有命令和响应均采用以下格式：

```
┌──────┬──────┬──────────────┬──────┐
│ 地址 │功能码│  参数/数据    │校验码│
│(1字节)│(1~2字节)│ (0~N字节)  │(1字节)│
└──────┴──────┴──────────────┴──────┘
```

**字段说明**:

| 字段 | 长度 | 说明 |
|------|------|------|
| **地址** | 1字节 | 目标电机地址（1~255），0为广播地址 |
| **功能码** | 1~2字节 | 命令类型标识 |
| **参数** | 可变 | 命令参数，大端序（高字节在前） |
| **校验** | 1字节 | 固定值 **0x6B** |

### 2.3.2 数据类型编码

| 数据类型 | 长度 | 字节序 | 示例 |
|---------|------|-------|------|
| **uint8_t** | 1字节 | - | 0x12 |
| **uint16_t** | 2字节 | 大端 | 1000 → 0x03 0xE8 |
| **uint32_t** | 4字节 | 大端 | 3200 → 0x00 0x00 0x0C 0x80 |
| **bool** | 1字节 | - | false=0x00, true=0x01 |

**大端序示例**（高字节在前）:
```c
uint32_t pulse = 3200;  // 0x00000C80
发送字节序列:
  cmd[6] = 0x00;  // bit24-31
  cmd[7] = 0x00;  // bit16-23
  cmd[8] = 0x0C;  // bit8-15
  cmd[9] = 0x80;  // bit0-7
```

---

## 2.4 命令响应机制

### 2.4.1 响应帧格式

电机收到命令后会返回执行状态：

```
┌──────┬──────┬──────┬────────┬──────┐
│ 地址 │功能码│状态码│返回数据│校验码│
└──────┴──────┴──────┴────────┴──────┘
```

**状态码定义**:

| 状态码 | 含义 | 处理建议 |
|--------|------|---------|
| 0x00 | 执行成功 | 无需处理 |
| 0x01 | 参数错误 | 检查命令参数范围 |
| 0x02 | 命令不支持 | 检查功能码是否正确 |
| 0x03 | 电机未使能 | 先发送使能命令 |
| 0x04 | 堵转保护 | 检查负载，调用解除堵转命令 |
| 0x05 | 校验错误 | 重新发送命令 |

### 2.4.2 超时处理

- **发送超时**: 50ms内未完成发送，放弃并报错
- **接收超时**: 发送命令后100ms内未收到响应，视为通信失败
- **重试机制**: 建议最多重试3次，间隔10ms

---

## 2.5 RS485多机通讯

### 2.5.1 硬件连接

```
MCU(STM32)        RS485模块        电机1         电机2         电机N
   TX  ──→  TX                      A────────A────────A
   RX  ←──  RX                      B────────B────────B
  GND  ──→  GND                    GND──────GND──────GND
              A   ──→
              B   ──→
```

**接线要点**:
- 所有电机的A、B、GND菊花链并联
- 总线两端（首尾）各接一个120Ω终端电阻（A-B之间）
- 总线长度超过100米建议使用屏蔽双绞线

### 2.5.2 地址设置

每个电机必须设置**唯一地址**（1~255）：

```c
// 方法1: 通过上位机软件设置（保存到电机Flash）
// 方法2: 通过按键组合设置
// 方法3: 出厂默认地址为 1
```

**广播地址**:
- 地址 `0x00` 为广播地址，所有电机都会响应
- ⚠️ 广播命令不会有响应帧返回
- 适用场景：同步使能、紧急停止等

### 2.5.3 总线冲突避免

- 主机采用**主从模式**，MCU为主机，电机为从机
- 从机只在收到命令后才发送响应
- 不支持电机之间的点对点通信

---

## 2.6 通信示例

### 示例1: 使能电机（地址1）

**发送命令**:
```
0x01 0xF3 0xAB 0x01 0x00 0x6B
 │    │    │    │    │    └─ 校验字节
 │    │    │    │    └────── 同步标志(false)
 │    │    │    └─────────── 使能状态(true)
 │    │    └──────────────── 辅助码
 │    └───────────────────── 功能码(使能控制)
 └────────────────────────── 电机地址1
```

**响应帧**:
```
0x01 0xF3 0x00 0x6B
 │    │    │    └─ 校验字节
 │    │    └────── 状态码(0x00=成功)
 │    └─────────── 功能码
 └──────────────── 电机地址1
```

### 示例2: 位置控制（转动1圈）

**发送命令**: 地址1，CW方向，1000RPM，加速度20，3200脉冲（1圈），相对运动
```
0x01 0xFD 0x00 0x03 0xE8 0x14 0x00 0x00 0x0C 0x80 0x00 0x00 0x6B
 │    │    │    │    │    │    │────────│────│    │    │    └─ 校验
 │    │    │    │    │    │         脉冲数3200       │    └────── 同步标志(false)
 │    │    │    │    │    │                          └─────────── 相对/绝对(false)
 │    │    │    │    │    └──────────────────────────────────── 加速度20
 │    │    │    └────────────────────────────────────────────── 速度1000RPM
 │    │    └─────────────────────────────────────────────────── 方向CW(0)
 │    └──────────────────────────────────────────────────────── 功能码(位置控制)
 └───────────────────────────────────────────────────────────── 地址1
```

### 示例3: 多机同步运动

**步骤**:

1. 发送带同步标志的位置命令给电机1（snF=true）
2. 发送带同步标志的位置命令给电机2（snF=true）
3. 发送同步触发命令（广播地址0）

```c
// 1. 电机1准备运动（不立即执行）
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, false, true);  // snF=true

// 2. 电机2准备运动（不立即执行）
Emm_V5_Pos_Control(2, 0, 1000, 20, 3200, false, true);  // snF=true

// 3. 统一触发所有电机同步启动
Emm_V5_Synchronous_motion(0);  // 广播地址0
```

---

## 2.7 STM32通信实现

### 2.7.1 硬件层（RS485）

```c
// 初始化USART2作为RS485通信
void atk_rs485_init(uint32_t baudrate)
{
    // GPIO配置: PA2=TX, PA3=RX
    // USART2配置: 8N1, baudrate
    // 中断配置: 使能RXNE中断
}

// 发送数据函数
void atk_rs485_send_data(uint8_t *buf, uint8_t len)
{
    // 切换到发送模式（如果需要DE/RE控制）
    // 调用HAL_UART_Transmit()发送数据
    // 切换回接收模式
}

// 接收数据（中断方式）
void USART2_IRQHandler(void)
{
    if(__HAL_UART_GET_FLAG(&g_rs458_handler, UART_FLAG_RXNE))
    {
        // 将接收字节存入缓冲区
        g_RS485_rx_buf[g_RS485_rx_cnt++] = USART2->DR;
    }
}
```

### 2.7.2 协议层（命令封装）

```c
// 使能电机
void Emm_V5_En_Control(uint8_t addr, bool state, bool snF)
{
    uint8_t cmd[6];
    cmd[0] = addr;
    cmd[1] = 0xF3;
    cmd[2] = 0xAB;
    cmd[3] = (uint8_t)state;
    cmd[4] = snF;
    cmd[5] = 0x6B;
    
    atk_rs485_send_data(cmd, 6);
}

// 位置控制
void Emm_V5_Pos_Control(uint8_t addr, uint8_t dir, uint16_t vel, 
                        uint8_t acc, uint32_t clk, bool raF, bool snF)
{
    uint8_t cmd[13];
    cmd[0]  = addr;
    cmd[1]  = 0xFD;
    cmd[2]  = dir;
    cmd[3]  = (uint8_t)(vel >> 8);
    cmd[4]  = (uint8_t)(vel >> 0);
    cmd[5]  = acc;
    cmd[6]  = (uint8_t)(clk >> 24);
    cmd[7]  = (uint8_t)(clk >> 16);
    cmd[8]  = (uint8_t)(clk >> 8);
    cmd[9]  = (uint8_t)(clk >> 0);
    cmd[10] = raF;
    cmd[11] = snF;
    cmd[12] = 0x6B;
    
    atk_rs485_send_data(cmd, 13);
}
```

### 2.7.3 帧接收处理（IDLE中断）

```c
// 使用IDLE中断检测帧结束
void USART2_IRQHandler(void)
{
    // RXNE中断：接收数据
    if(__HAL_UART_GET_FLAG(&huart, UART_FLAG_RXNE))
    {
        rx_buffer[rx_count++] = USART2->DR;
    }
    
    // IDLE中断：一帧接收完成
    if(__HAL_UART_GET_FLAG(&huart, UART_FLAG_IDLE))
    {
        __HAL_UART_CLEAR_IDLEFLAG(&huart);  // 清除标志
        
        // 处理接收到的完整帧
        process_rx_frame(rx_buffer, rx_count);
        rx_count = 0;  // 重置计数器
    }
}
```

---

## 2.8 通信故障诊断

### 常见问题排查

| 现象 | 可能原因 | 解决方案 |
|------|---------|---------|
| 无响应 | 波特率不匹配 | 确认双方波特率一致 |
| 无响应 | RS485 A/B接反 | 检查A-A、B-B连接 |
| 数据错乱 | 未接GND | 连接信号地 |
| 间歇失败 | 终端电阻未接 | 总线两端各接120Ω |
| 多机冲突 | 地址冲突 | 确保每个电机地址唯一 |
| 校验错误 | 命令格式错误 | 检查校验字节是否为0x6B |

### 调试技巧

1. **示波器/逻辑分析仪**: 观察波形，确认电平和时序
2. **串口助手**: 发送十六进制数据，观察电机响应
3. **回环测试**: 短接TX/RX，确认MCU串口正常
4. **逐步排查**: 先单机通信，再多机组网

---

[← 上一章：产品概述](01-产品概述.md) | [返回目录](README.md) | [下一章：控制命令详解 →](03-控制命令详解.md)
