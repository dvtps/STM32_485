# 03 - 控制命令详解

[← 上一章：通信协议](02-通信协议.md) | [返回目录](README.md) | [下一章：位置和速度控制 →](04-位置和速度控制.md)

---

## 3.1 命令分类

Y系列电机支持以下命令类别：

| 类别 | 功能 | 常用度 |
|------|------|-------|
| **基础控制** | 使能、位置、速度、停止 | ⭐⭐⭐⭐⭐ |
| **参数读取** | 版本、位置、速度、状态 | ⭐⭐⭐⭐ |
| **回零功能** | 触发回零、修改回零参数 | ⭐⭐⭐⭐ |
| **系统配置** | 修改控制模式、存储参数 | ⭐⭐⭐ |
| **多机同步** | 同步运动触发 | ⭐⭐⭐ |
| **故障处理** | 解除堵转、位置清零 | ⭐⭐ |

---

## 3.2 基础控制命令

### 3.2.1 使能/失能控制

**功能**: 启用或关闭电机力矩输出

**命令格式**:
```
[addr] [0xF3] [0xAB] [state] [snF] [0x6B]
```

**参数说明**:
| 参数 | 类型 | 说明 |
|------|------|------|
| addr | uint8_t | 电机地址（1~255） |
| state | bool | true=使能，false=失能 |
| snF | bool | 同步标志（true=等待同步命令） |

**C语言实现**:
```c
void Emm_V5_En_Control(uint8_t addr, bool state, bool snF)
{
    uint8_t cmd[6];
    cmd[0] = addr;
    cmd[1] = 0xF3;
    cmd[2] = 0xAB;
    cmd[3] = (uint8_t)state;
    cmd[4] = snF;
    cmd[5] = 0x6B;
    
    usart_SendCmd(cmd, 6);
}
```

**使用示例**:
```c
// 使能1号电机
Emm_V5_En_Control(1, true, false);

// 失能所有电机（广播）
Emm_V5_En_Control(0, false, false);
```

---

### 3.2.2 立即停止

**功能**: 紧急停止电机运动（所有模式通用）

**命令格式**:
```
[addr] [0xFE] [0x98] [snF] [0x6B]
```

**参数说明**:
| 参数 | 类型 | 说明 |
|------|------|------|
| addr | uint8_t | 电机地址 |
| snF | bool | 同步标志 |

**C语言实现**:
```c
void Emm_V5_Stop_Now(uint8_t addr, bool snF)
{
    uint8_t cmd[5];
    cmd[0] = addr;
    cmd[1] = 0xFE;
    cmd[2] = 0x98;
    cmd[3] = snF;
    cmd[4] = 0x6B;
    
    usart_SendCmd(cmd, 5);
}
```

**使用示例**:
```c
// 紧急停止1号电机
Emm_V5_Stop_Now(1, false);

// 紧急停止所有电机（广播）
Emm_V5_Stop_Now(0, false);
```

---

### 3.2.3 位置模式控制

**功能**: 控制电机转动指定圈数或角度

**命令格式**:
```
[addr] [0xFD] [dir] [vel_H] [vel_L] [acc] [clk_HH] [clk_HL] [clk_LH] [clk_LL] [raF] [snF] [0x6B]
```

**参数说明**:
| 参数 | 类型 | 范围 | 说明 |
|------|------|------|------|
| addr | uint8_t | 1~255 | 电机地址 |
| dir | uint8_t | 0/1 | 0=CW顺时针，1=CCW逆时针 |
| vel | uint16_t | 0~5000 | 速度(RPM)，建议≤3000 |
| acc | uint8_t | 0~255 | 加速度，0=直接启动 |
| clk | uint32_t | 0~2³²-1 | 脉冲数（16细分：3200=1圈） |
| raF | bool | 0/1 | false=相对运动，true=绝对运动 |
| snF | bool | 0/1 | 同步标志 |

**C语言实现**:
```c
void Emm_V5_Pos_Control(uint8_t addr, uint8_t dir, uint16_t vel, 
                        uint8_t acc, uint32_t clk, bool raF, bool snF)
{
    uint8_t cmd[13];
    cmd[0]  = addr;
    cmd[1]  = 0xFD;
    cmd[2]  = dir;
    cmd[3]  = (uint8_t)(vel >> 8);    // 速度高字节
    cmd[4]  = (uint8_t)(vel >> 0);    // 速度低字节
    cmd[5]  = acc;
    cmd[6]  = (uint8_t)(clk >> 24);   // 脉冲数最高字节
    cmd[7]  = (uint8_t)(clk >> 16);
    cmd[8]  = (uint8_t)(clk >> 8);
    cmd[9]  = (uint8_t)(clk >> 0);    // 脉冲数最低字节
    cmd[10] = raF;
    cmd[11] = snF;
    cmd[12] = 0x6B;
    
    usart_SendCmd(cmd, 13);
}
```

**使用示例**:
```c
// 示例1: 转动1圈（16细分，3200脉冲）
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, false, false);
//                 地址1, CW, 1000RPM, 加速度20, 3200脉冲, 相对, 立即执行

// 示例2: 转动半圈
Emm_V5_Pos_Control(1, 1, 500, 10, 1600, false, false);
//                 地址1, CCW, 500RPM, 加速度10, 1600脉冲, 相对, 立即执行

// 示例3: 转动到绝对位置3200（从原点开始计算）
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, true, false);
//                 地址1, CW, 1000RPM, 加速度20, 3200脉冲, 绝对, 立即执行
```

**脉冲数与角度换算**:
```
16细分: 3200脉冲 = 360° = 1圈
每度对应脉冲数 = 3200 / 360 ≈ 8.89

示例计算:
- 转动90°  : 3200 / 4 = 800脉冲
- 转动180° : 3200 / 2 = 1600脉冲
- 转动360° : 3200脉冲
- 转动720° : 6400脉冲
```

---

### 3.2.4 速度模式控制

**功能**: 让电机以恒定速度持续旋转

**命令格式**:
```
[addr] [0xF6] [dir] [vel_H] [vel_L] [acc] [snF] [0x6B]
```

**参数说明**:
| 参数 | 类型 | 范围 | 说明 |
|------|------|------|------|
| addr | uint8_t | 1~255 | 电机地址 |
| dir | uint8_t | 0/1 | 0=CW，1=CCW |
| vel | uint16_t | 0~5000 | 速度(RPM) |
| acc | uint8_t | 0~255 | 加速度 |
| snF | bool | 0/1 | 同步标志 |

**C语言实现**:
```c
void Emm_V5_Vel_Control(uint8_t addr, uint8_t dir, uint16_t vel, 
                        uint8_t acc, bool snF)
{
    uint8_t cmd[8];
    cmd[0] = addr;
    cmd[1] = 0xF6;
    cmd[2] = dir;
    cmd[3] = (uint8_t)(vel >> 8);
    cmd[4] = (uint8_t)(vel >> 0);
    cmd[5] = acc;
    cmd[6] = snF;
    cmd[7] = 0x6B;
    
    usart_SendCmd(cmd, 8);
}
```

**使用示例**:
```c
// 以1000RPM顺时针旋转
Emm_V5_Vel_Control(1, 0, 1000, 20, false);

// 停止速度模式（设置速度为0）
Emm_V5_Vel_Control(1, 0, 0, 0, false);

// 或使用立即停止命令
Emm_V5_Stop_Now(1, false);
```

---

## 3.3 参数读取命令

### 3.3.1 读取系统参数

**功能**: 查询电机版本、状态、位置等信息

**命令格式**:
```
[addr] [功能码] [0x6B]   或   [addr] [功能码] [辅助码] [0x6B]
```

**支持的参数类型**:

| 参数类型 | 功能码 | 返回数据 | 说明 |
|---------|-------|---------|------|
| S_VER | 0x1F | 版本号 | 固件版本和硬件型号 |
| S_RL | 0x20 | 转动方向 | CW/CCW |
| S_PID | 0x21 | PID参数 | P、I、D值 |
| S_VBUS | 0x24 | 总线电压 | 实时电压(V) |
| S_CPHA | 0x27 | 当前相位 | 编码器相位 |
| S_ENCL | 0x31 | 编码器值 | 编码器原始数据 |
| S_TPOS | 0x33 | 目标位置 | 位置模式目标值 |
| S_VEL | 0x35 | 实时速度 | 当前转速(RPM) |
| S_CPOS | 0x36 | 当前位置 | 实时位置角度 |
| S_PERR | 0x37 | 位置误差 | 目标-当前 |
| S_FLAG | 0x3A | 状态标志位 | 使能/回零/堵转 |
| S_ORG | 0x3B | 回零状态 | 回零进度标志 |
| S_Conf | 0x42 0x6C | 配置参数 | 系统配置 |
| S_State | 0x43 0x7A | 系统状态 | 完整状态信息 |

**C语言实现**:
```c
typedef enum {
    S_VER   = 0,    // 版本
    S_RL    = 1,    // 方向
    S_PID   = 2,    // PID
    S_VBUS  = 3,    // 电压
    S_CPHA  = 5,    // 相位
    S_ENCL  = 7,    // 编码器
    S_TPOS  = 8,    // 目标位置
    S_VEL   = 9,    // 速度
    S_CPOS  = 10,   // 当前位置
    S_PERR  = 11,   // 位置误差
    S_FLAG  = 13,   // 标志位
    S_Conf  = 14,   // 配置
    S_State = 15,   // 状态
    S_ORG   = 16    // 回零状态
} SysParams_t;

void Emm_V5_Read_Sys_Params(uint8_t addr, SysParams_t s)
{
    uint8_t i = 0;
    uint8_t cmd[16] = {0};
    
    cmd[i++] = addr;
    
    switch(s) {
        case S_VER:   cmd[i++] = 0x1F; break;
        case S_RL:    cmd[i++] = 0x20; break;
        case S_PID:   cmd[i++] = 0x21; break;
        case S_VBUS:  cmd[i++] = 0x24; break;
        case S_CPHA:  cmd[i++] = 0x27; break;
        case S_ENCL:  cmd[i++] = 0x31; break;
        case S_TPOS:  cmd[i++] = 0x33; break;
        case S_VEL:   cmd[i++] = 0x35; break;
        case S_CPOS:  cmd[i++] = 0x36; break;
        case S_PERR:  cmd[i++] = 0x37; break;
        case S_FLAG:  cmd[i++] = 0x3A; break;
        case S_ORG:   cmd[i++] = 0x3B; break;
        case S_Conf:  cmd[i++] = 0x42; cmd[i++] = 0x6C; break;
        case S_State: cmd[i++] = 0x43; cmd[i++] = 0x7A; break;
        default: break;
    }
    
    cmd[i++] = 0x6B;
    usart_SendCmd(cmd, i);
}
```

**使用示例**:
```c
// 读取电机版本信息
Emm_V5_Read_Sys_Params(1, S_VER);

// 读取当前速度
Emm_V5_Read_Sys_Params(1, S_VEL);

// 读取当前位置
Emm_V5_Read_Sys_Params(1, S_CPOS);

// 等待响应...
while(rxFrameFlag == false);  // 等待接收完成标志
rxFrameFlag = false;

// 解析响应数据
parse_response(rxCmd, rxCount);
```

---

## 3.4 系统配置命令

### 3.4.1 修改控制模式

**功能**: 切换开环/闭环/脉冲模式

**命令格式**:
```
[addr] [0x46] [0x69] [svF] [ctrl_mode] [0x6B]
```

**参数说明**:
| 参数 | 类型 | 说明 |
|------|------|------|
| svF | bool | true=保存到Flash，false=临时设置 |
| ctrl_mode | uint8_t | 0=关闭脉冲，1=开环，2=闭环，3=复用模式 |

**C语言实现**:
```c
void Emm_V5_Modify_Ctrl_Mode(uint8_t addr, bool svF, uint8_t ctrl_mode)
{
    uint8_t cmd[6];
    cmd[0] = addr;
    cmd[1] = 0x46;
    cmd[2] = 0x69;
    cmd[3] = svF;
    cmd[4] = ctrl_mode;
    cmd[5] = 0x6B;
    
    usart_SendCmd(cmd, 6);
}
```

**使用示例**:
```c
// 切换到闭环模式并保存
Emm_V5_Modify_Ctrl_Mode(1, true, 2);

// 临时切换到开环模式（掉电后恢复）
Emm_V5_Modify_Ctrl_Mode(1, false, 1);
```

---

### 3.4.2 清零当前位置

**功能**: 将当前位置设为零点（绝对位置模式用）

**命令格式**:
```
[addr] [0x0A] [0x6D] [0x6B]
```

**C语言实现**:
```c
void Emm_V5_Reset_CurPos_To_Zero(uint8_t addr)
{
    uint8_t cmd[4];
    cmd[0] = addr;
    cmd[1] = 0x0A;
    cmd[2] = 0x6D;
    cmd[3] = 0x6B;
    
    usart_SendCmd(cmd, 4);
}
```

**使用示例**:
```c
// 将1号电机当前位置设为零点
Emm_V5_Reset_CurPos_To_Zero(1);

// 之后使用绝对位置控制时，会以此为参考
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, true, false);  // 从零点移动到3200位置
```

---

### 3.4.3 解除堵转保护

**功能**: 清除堵转报警状态

**命令格式**:
```
[addr] [0x0E] [0x52] [0x6B]
```

**C语言实现**:
```c
void Emm_V5_Reset_Clog_Pro(uint8_t addr)
{
    uint8_t cmd[4];
    cmd[0] = addr;
    cmd[1] = 0x0E;
    cmd[2] = 0x52;
    cmd[3] = 0x6B;
    
    usart_SendCmd(cmd, 4);
}
```

**使用场景**:
```c
// 当电机堵转后，需要先解除堵转
Emm_V5_Reset_Clog_Pro(1);
delay_ms(10);

// 然后重新使能电机
Emm_V5_En_Control(1, true, false);
```

---

## 3.5 命令快速参考表

### 常用命令速查

| 命令名称 | 功能码 | 参数长度 | 说明 |
|---------|-------|---------|------|
| **使能控制** | 0xF3 0xAB | 6字节 | 启用/关闭电机 |
| **位置控制** | 0xFD | 13字节 | 转动指定圈数 |
| **速度控制** | 0xF6 | 8字节 | 恒速旋转 |
| **立即停止** | 0xFE 0x98 | 5字节 | 紧急停止 |
| **同步触发** | 0xFF 0x66 | 4字节 | 多机同步启动 |
| **清零位置** | 0x0A 0x6D | 4字节 | 当前位置归零 |
| **解除堵转** | 0x0E 0x52 | 4字节 | 清除堵转状态 |
| **读取速度** | 0x35 | 3字节 | 查询实时转速 |
| **读取位置** | 0x36 | 3字节 | 查询当前位置 |
| **修改模式** | 0x46 0x69 | 6字节 | 开环/闭环切换 |

---

[← 上一章：通信协议](02-通信协议.md) | [返回目录](README.md) | [下一章：位置和速度控制 →](04-位置和速度控制.md)
