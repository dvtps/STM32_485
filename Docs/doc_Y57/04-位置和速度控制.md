# 04 - 位置和速度控制

[← 上一章：控制命令详解](03-控制命令详解.md) | [返回目录](README.md) | [下一章：回零功能 →](05-回零功能.md)

---

## 4.1 位置模式详解

位置模式是最常用的控制方式，用于让电机精确转动到指定位置。

### 4.1.1 相对位置与绝对位置

**相对位置模式** (`raF = false`):
- 从**当前位置**开始计算
- 每次运动相互独立
- 适合增量式运动（如每次前进1圈）

**绝对位置模式** (`raF = true`):
- 从**零点位置**开始计算
- 运动到指定的绝对坐标
- 适合位置定位（如移动到第3圈位置）

**对比示例**:
```c
// 假设当前位置在 0 

// 相对运动：转动1圈（从0到3200）
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, false, false);
// 结果：位置 = 3200

// 再次相对运动：再转1圈（从3200到6400）
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, false, false);
// 结果：位置 = 6400

//------ 对比绝对位置 ------

// 复位到零点
Emm_V5_Reset_CurPos_To_Zero(1);  // 位置 = 0

// 绝对运动：移动到位置3200
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, true, false);
// 结果：位置 = 3200

// 再次绝对运动：移动到位置6400
Emm_V5_Pos_Control(1, 0, 1000, 20, 6400, true, false);
// 结果：位置 = 6400（从3200移动到6400，实际运动3200脉冲）
```

---

### 4.1.2 方向控制

**顺时针 (CW)**: `dir = 0`
**逆时针 (CCW)**: `dir = 1` 或任何非零值

```c
// 顺时针转动1圈
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, false, false);

// 逆时针转动1圈
Emm_V5_Pos_Control(1, 1, 1000, 20, 3200, false, false);
```

**注意**: 在绝对位置模式下，方向参数会被忽略，电机会自动选择最短路径。

---

### 4.1.3 速度设置

**单位**: RPM (Revolutions Per Minute，转/分钟)

**范围**: 0 ~ 5000 RPM
**推荐**: 500 ~ 3000 RPM（根据负载调整）

**速度与脉冲频率的关系**:
```
频率(Hz) = 速度(RPM) × 细分数 / 60
         = RPM × 3200 / 60
         = RPM × 53.33

示例:
1000 RPM → 53,330 Hz (53.33 kHz)
3000 RPM → 160,000 Hz (160 kHz)
```

**速度选择建议**:
| 负载情况 | 推荐速度 | 说明 |
|---------|---------|------|
| 重负载 | 500~1000 RPM | 大惯量、重物体 |
| 中等负载 | 1000~2000 RPM | 常规应用 |
| 轻负载 | 2000~3000 RPM | 空载、轻物体 |
| 高速应用 | 3000~5000 RPM | 需测试稳定性 |

```c
// 低速精确运动
Emm_V5_Pos_Control(1, 0, 500, 20, 3200, false, false);

// 中速常规运动
Emm_V5_Pos_Control(1, 0, 1500, 20, 3200, false, false);

// 高速快速运动
Emm_V5_Pos_Control(1, 0, 3000, 20, 3200, false, false);
```

---

### 4.1.4 加速度控制

**单位**: 无量纲（0~255）
**特殊值**: `acc = 0` 表示**直接启动**（无加减速过程）

**加速度效果**:
```
acc = 0   → 立即达到目标速度（可能丢步）
acc = 10  → 缓慢加速（平滑但耗时）
acc = 20  → 中等加速（常用）
acc = 50  → 快速加速
acc = 255 → 极快加速（接近直接启动）
```

**选择建议**:
- **精密定位**: acc = 10~20（平稳，精度高）
- **快速运动**: acc = 30~50（响应快）
- **紧急场景**: acc = 0（最快，但可能失步）

```c
// 平滑加速（适合重负载）
Emm_V5_Pos_Control(1, 0, 2000, 10, 3200, false, false);

// 快速加速（适合轻负载）
Emm_V5_Pos_Control(1, 0, 2000, 50, 3200, false, false);

// 直接启动（无加减速）
Emm_V5_Pos_Control(1, 0, 2000, 0, 3200, false, false);
```

---

### 4.1.5 脉冲数计算

**16细分标准**: 
```
3200 脉冲 = 360° = 1 圈
```

**常用换算**:

| 转动角度 | 脉冲数计算 | 结果 |
|---------|-----------|------|
| 1圈 (360°) | 3200 | 3200 |
| 半圈 (180°) | 3200 / 2 | 1600 |
| 1/4圈 (90°) | 3200 / 4 | 800 |
| 2圈 | 3200 × 2 | 6400 |
| 10圈 | 3200 × 10 | 32000 |
| 任意角度 θ | 3200 × θ / 360 | - |

**C语言换算函数**:
```c
// 角度转脉冲
uint32_t degree_to_pulse(float degree)
{
    return (uint32_t)(degree * 3200.0 / 360.0);
}

// 圈数转脉冲
uint32_t revs_to_pulse(float revolutions)
{
    return (uint32_t)(revolutions * 3200.0);
}

// 使用示例
uint32_t pulse_90deg  = degree_to_pulse(90);      // 800
uint32_t pulse_2revs  = revs_to_pulse(2.5);       // 8000
```

---

### 4.1.6 实际应用示例

**示例1: 摄影滑轨往返运动**
```c
void camera_slider_move(void)
{
    // 初始化
    Emm_V5_En_Control(1, true, false);
    delay_ms(100);
    
    while(1)
    {
        // 向右移动10圈（假设丝杆导程5mm/圈，移动50mm）
        Emm_V5_Pos_Control(1, 0, 800, 20, 32000, false, false);
        delay_ms(5000);  // 等待运动完成
        
        // 向左返回10圈
        Emm_V5_Pos_Control(1, 1, 800, 20, 32000, false, false);
        delay_ms(5000);
    }
}
```

**示例2: 旋转台精确定位**
```c
void rotate_to_angle(uint8_t motor_addr, float angle)
{
    // 将角度转换为脉冲数
    uint32_t pulse = degree_to_pulse(angle);
    
    // 使用绝对位置模式移动到指定角度
    Emm_V5_Pos_Control(motor_addr, 0, 1000, 20, pulse, true, false);
}

// 使用
rotate_to_angle(1, 90.0);   // 转到90度位置
rotate_to_angle(1, 180.0);  // 转到180度位置
rotate_to_angle(1, 0.0);    // 回到0度位置
```

**示例3: 多段连续运动**
```c
void multi_step_motion(void)
{
    // 使能电机
    Emm_V5_En_Control(1, true, false);
    delay_ms(100);
    
    // 第1段：慢速移动1圈
    Emm_V5_Pos_Control(1, 0, 500, 10, 3200, false, false);
    delay_ms(8000);  // 等待完成
    
    // 第2段：中速移动2圈
    Emm_V5_Pos_Control(1, 0, 1500, 20, 6400, false, false);
    delay_ms(5000);
    
    // 第3段：快速移动3圈
    Emm_V5_Pos_Control(1, 0, 3000, 50, 9600, false, false);
    delay_ms(4000);
    
    // 失能电机
    Emm_V5_En_Control(1, false, false);
}
```

---

## 4.2 速度模式详解

速度模式用于让电机以恒定转速持续旋转，直到收到停止命令或速度改变命令。

### 4.2.1 速度模式特点

- ✅ 持续旋转，无脉冲数限制
- ✅ 支持加减速过程
- ✅ 可动态改变速度
- ✅ 适合传送带、风扇等应用

### 4.2.2 启动和停止

**启动**:
```c
// 以1000RPM顺时针旋转
Emm_V5_Vel_Control(1, 0, 1000, 20, false);
```

**停止方法1**: 速度设为0
```c
// 减速停止
Emm_V5_Vel_Control(1, 0, 0, 20, false);
```

**停止方法2**: 立即停止命令
```c
// 紧急停止
Emm_V5_Stop_Now(1, false);
```

**停止方法3**: 失能电机
```c
// 失能（电机无保持力矩）
Emm_V5_En_Control(1, false, false);
```

---

### 4.2.3 动态调速

速度模式支持在运行中改变速度：

```c
void variable_speed_demo(void)
{
    // 使能电机
    Emm_V5_En_Control(1, true, false);
    delay_ms(100);
    
    // 启动：500RPM
    Emm_V5_Vel_Control(1, 0, 500, 20, false);
    delay_ms(3000);
    
    // 加速到1000RPM
    Emm_V5_Vel_Control(1, 0, 1000, 20, false);
    delay_ms(3000);
    
    // 加速到2000RPM
    Emm_V5_Vel_Control(1, 0, 2000, 30, false);
    delay_ms(3000);
    
    // 减速到500RPM
    Emm_V5_Vel_Control(1, 0, 500, 20, false);
    delay_ms(3000);
    
    // 停止
    Emm_V5_Vel_Control(1, 0, 0, 10, false);
    delay_ms(2000);
    
    // 失能
    Emm_V5_En_Control(1, false, false);
}
```

---

### 4.2.4 方向切换

```c
// 顺时针旋转
Emm_V5_Vel_Control(1, 0, 1000, 20, false);
delay_ms(5000);

// 先停止
Emm_V5_Stop_Now(1, false);
delay_ms(100);

// 逆时针旋转
Emm_V5_Vel_Control(1, 1, 1000, 20, false);
delay_ms(5000);
```

⚠️ **注意**: 不要直接反向，需先停止后再切换方向。

---

### 4.2.5 实际应用示例

**示例1: 恒速传送带**
```c
void conveyor_belt_control(bool enable, uint16_t speed)
{
    if(enable)
    {
        Emm_V5_En_Control(1, true, false);
        delay_ms(50);
        Emm_V5_Vel_Control(1, 0, speed, 20, false);
    }
    else
    {
        Emm_V5_Vel_Control(1, 0, 0, 10, false);
        delay_ms(500);
        Emm_V5_En_Control(1, false, false);
    }
}

// 使用
conveyor_belt_control(true, 800);   // 启动，800RPM
delay_ms(10000);                     // 运行10秒
conveyor_belt_control(false, 0);    // 停止
```

**示例2: 搅拌器变速控制**
```c
void mixer_speed_control(uint8_t level)
{
    uint16_t speed;
    
    switch(level)
    {
        case 1: speed = 300;  break;  // 低速
        case 2: speed = 800;  break;  // 中速
        case 3: speed = 1500; break;  // 高速
        default: speed = 0;   break;  // 停止
    }
    
    if(speed > 0)
    {
        Emm_V5_Vel_Control(1, 0, speed, 20, false);
    }
    else
    {
        Emm_V5_Stop_Now(1, false);
    }
}

// 使用
mixer_speed_control(1);  // 低速挡
delay_ms(5000);
mixer_speed_control(2);  // 中速挡
delay_ms(5000);
mixer_speed_control(3);  // 高速挡
delay_ms(5000);
mixer_speed_control(0);  // 停止
```

---

## 4.3 位置模式 vs 速度模式

| 对比项 | 位置模式 | 速度模式 |
|-------|---------|---------|
| **运动方式** | 移动到指定位置后停止 | 持续旋转直到收到停止命令 |
| **脉冲数** | 必须指定 | 无（无限旋转） |
| **精度** | 高精度定位 | 恒速度控制 |
| **结束条件** | 到达目标位置 | 手动停止 |
| **典型应用** | 定位、往返运动 | 传送带、风扇、泵 |
| **加减速** | 启停时有加减速 | 启停和变速时有加减速 |

---

## 4.4 运动时间估算

**位置模式运动时间计算**:
```
时间(秒) ≈ 脉冲数 / (速度(RPM) × 3200 / 60)
         = 脉冲数 × 60 / (速度 × 3200)

示例:
脉冲数 = 32000 (10圈)
速度 = 1000 RPM
时间 = 32000 × 60 / (1000 × 3200) = 0.6秒

考虑加减速，实际时间会更长约 10%~30%
```

**C语言估算函数**:
```c
float estimate_motion_time(uint32_t pulse, uint16_t rpm, uint8_t acc)
{
    float base_time = (float)pulse * 60.0 / ((float)rpm * 3200.0);
    float acc_factor = 1.0 + (50.0 - (float)acc) / 500.0;  // 加速影响系数
    return base_time * acc_factor;
}

// 使用
float time = estimate_motion_time(32000, 1000, 20);
printf("预计运动时间: %.2f 秒\n", time);
```

---

[← 上一章：控制命令详解](03-控制命令详解.md) | [返回目录](README.md) | [下一章：回零功能 →](05-回零功能.md)
