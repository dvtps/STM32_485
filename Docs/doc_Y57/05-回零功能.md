# 05 - 回零功能

[← 上一章：位置和速度控制](04-位置和速度控制.md) | [返回目录](README.md) | [下一章：多机通讯 →](06-多机通讯.md)

---

## 5.1 回零功能概述

回零（Homing）是建立位置参考坐标系的过程，电机通过回零确定绝对位置的零点。

**应用场景**:
- 上电后建立位置参考
- 长时间运行后校准累积误差
- 绝对位置模式的前置条件

---

## 5.2 四种回零模式

| 模式 | o_mode | 特点 | 适用场景 |
|------|--------|------|---------|
| **单圈就近回零** | 0 | 转动不超过1圈到达零点 | 单圈应用，快速回零 |
| **单圈方向回零** | 1 | 按指定方向转动到零点 | 单圈应用，确定方向 |
| **多圈无限位碰撞回零** | 2 | 转动直到碰撞阻挡物（电流检测） | 没有限位开关的设备 |
| **多圈有限位开关回零** | 3 | 转动直到触发限位开关 | 有限位开关的设备 |

---

## 5.3 单圈回零（模式0和1）

### 5.3.1 单圈就近回零（模式0）

**原理**: 电机选择最短路径（≤180°）转动到编码器零点。

**命令格式**:
```c
Emm_V5_Origin_Trigger_Return(addr, 0, false);
```

**使用步骤**:
```c
// 1. 使能电机
Emm_V5_En_Control(1, true, false);
delay_ms(100);

// 2. 触发就近回零
Emm_V5_Origin_Trigger_Return(1, 0, false);

// 3. 等待回零完成（通过读取状态或延时）
delay_ms(3000);

// 4. 确认回零成功
Emm_V5_Read_Sys_Params(1, S_ORG);
```

**特点**:
- ✅ 最快速（转动角度≤180°）
- ✅ 适合快速启动应用
- ⚠️ 回零方向不固定

---

### 5.3.2 单圈方向回零（模式1）

**原理**: 按指定方向转动，直到到达编码器零点（可能转动接近1圈）。

**命令前需先设置回零方向**:
```c
// 修改回零参数：方向为CW
Emm_V5_Origin_Modify_Params(
    1,          // 地址
    true,       // 保存参数
    1,          // 模式1：方向回零
    0,          // 方向：CW
    500,        // 回零速度：500RPM
    10000,      // 超时时间：10秒
    0, 0, 0,    // 碰撞检测参数（单圈模式不用）
    false       // 上电不自动回零
);
delay_ms(100);

// 触发回零
Emm_V5_Origin_Trigger_Return(1, 1, false);
```

**特点**:
- ✅ 回零方向可控
- ✅ 适合有方向要求的应用
- ⚠️ 可能转动接近1圈

---

## 5.4 多圈无限位碰撞回零（模式2）

### 5.4.1 工作原理

电机按指定方向转动，当检测到：
1. **电流超过阈值**（sl_ma）
2. **速度低于阈值**（sl_vel）  
3. **持续时间超过**（sl_ms）

同时满足以上条件，判定为碰撞到机械限位，停止并将当前位置设为零点。

---

### 5.4.2 参数配置

```c
void setup_collision_homing(void)
{
    Emm_V5_Origin_Modify_Params(
        1,          // 电机地址
        true,       // 保存到Flash
        2,          // 模式2：无限位碰撞回零
        0,          // 回零方向：CW
        300,        // 回零速度：300RPM（建议低速）
        30000,      // 超时时间：30秒
        100,        // 检测转速：低于100RPM视为堵转
        1000,       // 检测电流：超过1000mA视为堵转
        200,        // 检测时间：持续200ms确认堵转
        false       // 上电不自动回零
    );
}
```

**参数调整建议**:

| 参数 | 推荐范围 | 说明 |
|------|---------|------|
| o_vel | 200~500 RPM | 速度越低越安全 |
| sl_vel | 50~200 RPM | 低于此速度判定为堵转 |
| sl_ma | 500~2000 mA | 根据负载调整 |
| sl_ms | 100~500 ms | 过短易误判，过长反应慢 |

---

### 5.4.3 完整使用流程

```c
void collision_homing_demo(void)
{
    printf("开始无限位碰撞回零...\n");
    
    // 1. 配置回零参数
    Emm_V5_Origin_Modify_Params(
        1, true, 2, 0, 300, 30000,
        100, 1000, 200, false
    );
    delay_ms(100);
    
    // 2. 使能电机
    Emm_V5_En_Control(1, true, false);
    delay_ms(100);
    
    // 3. 触发回零
    Emm_V5_Origin_Trigger_Return(1, 2, false);
    
    // 4. 等待回零完成
    for(int i = 0; i < 300; i++)  // 最多等待30秒
    {
        delay_ms(100);
        
        // 读取回零状态
        Emm_V5_Read_Sys_Params(1, S_ORG);
        // 解析响应判断是否完成（需实现）
        
        if(is_homing_complete())  // 假设有此函数
        {
            printf("回零完成!\n");
            break;
        }
    }
    
    printf("回零流程结束\n");
}
```

---

## 5.5 多圈有限位开关回零（模式3）

### 5.5.1 硬件连接

将限位开关连接到电机的 **ORG** 端口：
```
限位开关NO端 ──→ ORG
限位开关COM端 ──→ GND
```

**触发方式**: 低电平有效（开关闭合时回零）

---

### 5.5.2 参数配置

```c
void setup_switch_homing(void)
{
    Emm_V5_Origin_Modify_Params(
        1,          // 电机地址
        true,       // 保存参数
        3,          // 模式3：有限位开关回零
        1,          // 回零方向：CCW（根据限位开关位置）
        800,        // 回零速度：800RPM
        60000,      // 超时时间：60秒
        0, 0, 0,    // 碰撞检测参数（有限位模式不用）
        true        // 上电自动回零
    );
}
```

---

### 5.5.3 回零过程

```
[启动] → [按o_dir方向转动] → [检测ORG信号] → [触发低电平] → [停止并反向微调] → [到达零点]
```

**完整示例**:
```c
void switch_homing_demo(void)
{
    // 1. 配置回零参数（只需配置一次，会保存到Flash）
    Emm_V5_Origin_Modify_Params(
        1, true, 3, 1, 800, 60000,
        0, 0, 0, false  // 手动触发，不上电自动回零
    );
    delay_ms(100);
    
    // 2. 使能电机
    Emm_V5_En_Control(1, true, false);
    delay_ms(100);
    
    // 3. 触发回零
    Emm_V5_Origin_Trigger_Return(1, 3, false);
    
    // 4. 等待回零完成
    printf("正在回零，请等待...\n");
    delay_ms(10000);  // 根据实际行程时间调整
    
    printf("回零完成，可以开始位置控制\n");
}
```

---

## 5.6 上电自动回零

### 5.6.1 配置上电自动回零

```c
// 配置参数时设置 potF = true
Emm_V5_Origin_Modify_Params(
    1, true, 3, 1, 800, 60000,
    0, 0, 0, 
    true  // ← 上电自动触发回零
);
```

**效果**: 
- 电机上电后自动执行回零
- 回零完成后进入待命状态
- 适合无人值守的设备

---

### 5.6.2 禁用自动回零

```c
// 将 potF 设为 false
Emm_V5_Origin_Modify_Params(
    1, true, 3, 1, 800, 60000,
    0, 0, 0, 
    false  // ← 禁用上电自动回零
);
```

---

## 5.7 回零状态查询

### 5.7.1 查询回零进度

```c
// 读取回零状态
Emm_V5_Read_Sys_Params(1, S_ORG);

// 等待响应
while(rxFrameFlag == false);
rxFrameFlag = false;

// 解析响应帧
// 返回数据格式：[addr] [功能码] [状态] [数据...] [0x6B]
// 状态字节含义：
//   bit0: 回零中
//   bit1: 回零完成
//   bit2: 回零失败
//   bit3: 回零超时
```

---

### 5.7.2 中断回零过程

如果需要强制停止回零：

```c
// 强制中断并退出回零
Emm_V5_Origin_Interrupt(1);

// 或使用紧急停止
Emm_V5_Stop_Now(1, false);
```

---

## 5.8 回零参数优化建议

### 5.8.1 速度选择

| 应用场景 | 推荐速度 | 原因 |
|---------|---------|------|
| 精密设备 | 200~400 RPM | 降低冲击，提高精度 |
| 常规设备 | 500~800 RPM | 平衡速度和安全性 |
| 快速启动 | 1000~1500 RPM | 缩短初始化时间 |

---

### 5.8.2 碰撞检测参数（模式2）

**测试方法**:
1. 设置较低的电流阈值（如500mA）
2. 手动触发回零，观察是否能正确检测
3. 如误判，逐步提高电流阈值
4. 如检测不到，降低速度阈值或增加检测时间

**典型参数组合**:
```c
// 轻负载
sl_vel = 100, sl_ma = 800, sl_ms = 150

// 中等负载
sl_vel = 80, sl_ma = 1200, sl_ms = 200

// 重负载
sl_vel = 50, sl_ma = 1800, sl_ms = 300
```

---

## 5.9 回零故障排查

| 故障现象 | 可能原因 | 解决方案 |
|---------|---------|---------|
| 回零超时 | 方向设置错误 | 检查o_dir参数 |
| 回零超时 | 行程过长 | 增加o_tm超时时间 |
| 碰撞不停止 | 电流阈值过高 | 降低sl_ma值 |
| 误判碰撞 | 电流阈值过低 | 提高sl_ma值 |
| 限位开关不响应 | 接线错误 | 检查ORG和GND连接 |
| 限位开关不响应 | 开关类型错误 | 使用常开(NO)触点 |

---

## 5.10 回零后的应用

回零完成后，可以进行绝对位置控制：

```c
// 1. 回零
Emm_V5_Origin_Trigger_Return(1, 3, false);
delay_ms(10000);  // 等待完成

// 2. 使用绝对位置模式
Emm_V5_Pos_Control(1, 0, 1000, 20, 3200, true, false);   // 移动到1圈位置
delay_ms(5000);

Emm_V5_Pos_Control(1, 0, 1000, 20, 6400, true, false);   // 移动到2圈位置
delay_ms(5000);

Emm_V5_Pos_Control(1, 0, 1000, 20, 0, true, false);      // 回到零点
delay_ms(5000);
```

---

[← 上一章：位置和速度控制](04-位置和速度控制.md) | [返回目录](README.md) | [下一章：多机通讯 →](06-多机通讯.md)
