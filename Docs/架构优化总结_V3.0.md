# ä»£ç æ¶æ„ä¼˜åŒ–æ€»ç»“ (V3.0)

> **ä¼˜åŒ–æ—¥æœŸ**: 2025-12-01  
> **ä¸»è¦ç›®æ ‡**: æ¶ˆé™¤å†—ä½™ï¼Œé™ä½è€¦åˆï¼Œæå‡å¯ç»´æŠ¤æ€§

---

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

### æ–‡ä»¶æ•°é‡å˜åŒ–

| æ¨¡å— | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å˜åŒ– |
|------|--------|--------|------|
| Core/App/*.c | 12ä¸ª | 6ä¸ª | **-6ä¸ª** (åˆ é™¤æµ‹è¯•æ–‡ä»¶) |
| Drivers/BSP/EMM_V5/ | 2ä¸ª | 3ä¸ª | **+1ä¸ª** (æ–°å¢emm_uart) |
| **æ€»è®¡** | 35ä¸ªæºæ–‡ä»¶ | 30ä¸ªæºæ–‡ä»¶ | **-14%** |

### ä»£ç è¡Œæ•°å˜åŒ–

```
ä¼˜åŒ–å‰:
- emm_v5.c:      425è¡Œ (åŒ…å«é‡å¤çš„å‘é€é€»è¾‘)
- å„æµ‹è¯•æ–‡ä»¶:     ~800è¡Œ (åŠŸèƒ½é‡å )

ä¼˜åŒ–å:
- emm_v5.c:      380è¡Œ (-45è¡Œ, -10.6%)
- emm_uart.c:    220è¡Œ (æ–°å¢ç»Ÿä¸€é€šä¿¡å±‚)
- å‡€å‡å°‘:        ~625è¡Œ ä»£ç 
```

### Flashå ç”¨

```
V2.0 (ä¼˜åŒ–å‰): 29116 bytes (44.43% of 64KB)
V3.0 (ä¼˜åŒ–å): 28984 bytes (44.23% of 64KB)
ä¼˜åŒ–æ•ˆæœ:       -132 bytes (-0.45%)
```

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. åˆ é™¤å†—ä½™æµ‹è¯•æ–‡ä»¶ âœ…

**åˆ é™¤çš„æ–‡ä»¶**:
- `Core/App/main.c.bak` - å¤‡ä»½æ–‡ä»¶
- `Core/App/rs485_test.c` - é‡å¤æµ‹è¯•
- `Core/App/rs485_simple_test.c` - é‡å¤æµ‹è¯•
- `Core/App/usart1_rs485_test.c` - é‡å¤æµ‹è¯•
- `Core/App/main_rs485_test.c` - é‡å¤æµ‹è¯•

**åŸå› **: è¿™äº›æ–‡ä»¶åŠŸèƒ½é«˜åº¦é‡å ï¼Œéƒ½æ˜¯RS485é€šä¿¡æµ‹è¯•ï¼Œä¿ç•™`main.c`ä½œä¸ºå”¯ä¸€å…¥å£å³å¯ã€‚

---

### 2. åˆ›å»ºç»Ÿä¸€çš„RS485é€šä¿¡å±‚ âœ…

**æ–°å¢æ–‡ä»¶**:
- `Drivers/BSP/EMM_V5/emm_uart.h` (78è¡Œ)
- `Drivers/BSP/EMM_V5/emm_uart.c` (220è¡Œ)

**æ ¸å¿ƒæ¥å£**:
```c
/* åˆå§‹åŒ– */
void emm_uart_init(void);

/* æ ¸å¿ƒå‘é€å‡½æ•° */
uint8_t emm_uart_send(const uint8_t *data, uint16_t len);
uint8_t emm_uart_send_with_timeout(const uint8_t *data, uint16_t len, uint32_t timeout_ms);

/* çŠ¶æ€æŸ¥è¯¢ */
bool emm_uart_is_busy(void);
void emm_uart_get_stats(emm_uart_stats_t *stats);
void emm_uart_print_stats(void);
```

**ä¼˜åŠ¿**:
- âœ… **å•ä¸€èŒè´£**: ä¸“æ³¨RS485é€šä¿¡ï¼Œä¸å…³å¿ƒåè®®ç»†èŠ‚
- âœ… **å¯é…ç½®**: æ”¯æŒé˜»å¡/ä¸­æ–­/DMAä¸‰ç§æ¨¡å¼ (å½“å‰ä½¿ç”¨é˜»å¡æ¨¡å¼)
- âœ… **æ˜“æµ‹è¯•**: ç‹¬ç«‹æ¨¡å—ï¼Œä¾¿äºå•å…ƒæµ‹è¯•
- âœ… **æ˜“ç§»æ¤**: ä¿®æ”¹ç¡¬ä»¶åªéœ€æ”¹emm_uart.cï¼Œä¸Šå±‚æ— æ„ŸçŸ¥

---

### 3. ç®€åŒ–emm_v5.c âœ…

**ç‰ˆæœ¬æ¼”è¿›**:
```
V1.0 (å¼ å¤§å¤´åŸç‰ˆ): usart_SendCmd() (æ ‡å‡†åº“)
V2.0 (HALç§»æ¤):    HAL_UART_Transmit() (ç›´æ¥è°ƒç”¨)
V3.0 (æœ¬æ¬¡ä¼˜åŒ–):   emm_uart_send() (ç»Ÿä¸€å°è£…)
```

**ä¿®æ”¹å†…å®¹**:
```c
// V2.0 (ä¼˜åŒ–å‰)
static uint8_t emm_v5_send_cmd(uint8_t *cmd, uint8_t len)
{
    HAL_StatusTypeDef status;
    uint32_t current_tick = HAL_GetTick();
    
    if ((current_tick - g_emm_last_tx_tick) < MIN_TX_INTERVAL_MS)
        return 2;
    
    if (g_emm_tx_busy)
    {
        g_emm_tx_error_cnt++;
        return 1;
    }
    
    g_emm_tx_busy = true;
    status = HAL_UART_Transmit_IT(&g_uart2_handle, cmd, len);
    
    if (status != HAL_OK)
    {
        g_emm_tx_busy = false;
        g_emm_tx_error_cnt++;
        return 1;
    }
    
    g_emm_last_tx_tick = current_tick;
    g_emm_frame_complete = 0;
    return 0;
}

// V3.0 (ä¼˜åŒ–å)
static uint8_t emm_v5_send_cmd(uint8_t *cmd, uint8_t len)
{
    uint8_t result = emm_uart_send(cmd, len);
    
    if (result == 0)
    {
        g_emm_frame_complete = 0;  /* å‡†å¤‡æ¥æ”¶å“åº” */
    }
    
    return result;
}
```

**ä»£ç å‡å°‘**: 24è¡Œ â†’ 10è¡Œï¼Œ**-58%**

---

### 4. ä¿®æ­£æ¨¡å—ä¾èµ–å…³ç³» âœ…

**åŸä¾èµ–å›¾** (æ··ä¹±ï¼Œå¾ªç¯ä¾èµ–):
```
usart.c â”€â”€â”€â”€â”€â”€â”
              â”œâ”€â”€> emm_v5.c â”€â”€> HAL_UART_Transmit
emm_v5.c â”€â”€â”€â”€â”€â”˜
              (å›è°ƒç›¸äº’è°ƒç”¨)
```

**æ–°ä¾èµ–å›¾** (æ¸…æ™°ï¼Œå•å‘ä¾èµ–):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨å±‚       â”‚  emm_v5.c (åè®®å°è£…)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€šä¿¡å±‚       â”‚  emm_uart.c (ç»Ÿä¸€å‘é€)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¡¬ä»¶æŠ½è±¡å±‚   â”‚  usart.c (HALé©±åŠ¨)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. æ›´æ–°USMARTé…ç½® âœ…

**åˆ é™¤çš„è°ƒè¯•å‡½æ•°**:
```c
// å·²åˆ é™¤ (rs485_test.cå·²åˆ é™¤)
{(void *)rs485_send_byte, "void rs485_send_byte(uint8_t data)"},
{(void *)rs485_send_string, "void rs485_send_string(char *str)"},
{(void *)rs485_test_gpio, "void rs485_test_gpio(void)"},
{(void *)rs485_print_config, "void rs485_print_config(void)"},
```

**ä¿ç•™çš„ç”µæœºæ§åˆ¶å‡½æ•°** (é€šè¿‡motor_zdt.hå¯¼å‡º):
```c
{(void *)motor_enable, "void motor_enable(uint8_t addr,uint8_t enable)"},
{(void *)motor_pos_move, "void motor_pos_move(uint8_t addr,uint8_t dir,uint16_t speed,uint8_t acc,uint32_t pulses)"},
{(void *)motor_vel_move, "void motor_vel_move(uint8_t addr,uint8_t dir,uint16_t speed,uint8_t acc)"},
{(void *)motor_stop, "void motor_stop(uint8_t addr)"},
{(void *)motor_home, "void motor_home(uint8_t addr)"},
{(void *)motor_read_status, "void motor_read_status(uint8_t addr)"},
```

---

### 6. ç»Ÿè®¡åŠŸèƒ½è¿ç§» âœ…

**åŸå®ç°** (åˆ†æ•£åœ¨emm_v5.c):
```c
static uint32_t g_emm_tx_error_cnt = 0;
uint32_t Emm_V5_Get_TX_Error_Count(void) { return g_emm_tx_error_cnt; }
```

**æ–°å®ç°** (é›†ä¸­åœ¨emm_uart.c):
```c
typedef struct {
    uint32_t tx_success_cnt;    /* æˆåŠŸå‘é€æ¬¡æ•° */
    uint32_t tx_error_cnt;      /* å‘é€å¤±è´¥æ¬¡æ•° */
    uint32_t tx_busy_cnt;       /* å‘é€å™¨å¿™æ¬¡æ•° */
    uint32_t tx_throttle_cnt;   /* è¢«é¢‘ç‡é™åˆ¶æ‹¦æˆªæ¬¡æ•° */
    uint32_t last_tx_tick;      /* ä¸Šæ¬¡å‘é€æ—¶é—´æˆ³ */
} emm_uart_stats_t;

void emm_uart_get_stats(emm_uart_stats_t *stats);
void emm_uart_print_stats(void);
```

**åº”ç”¨ç¤ºä¾‹** (iwdg_timer.cå·²æ›´æ–°):
```c
emm_uart_stats_t current_stats;
emm_uart_get_stats(&current_stats);

if (current_stats.tx_error_cnt - last_stats.tx_error_cnt > 10)
{
    is_healthy = false;  /* 500mså†…è¶…è¿‡10æ¬¡é”™è¯¯ */
}
```

---

## ğŸ“ ä¼˜åŒ–åçš„ç›®å½•ç»“æ„

```
Core/App/                          (åº”ç”¨å±‚ï¼Œå‡å°‘50%)
â”œâ”€â”€ main.c                          â† å”¯ä¸€å…¥å£
â”œâ”€â”€ motor_zdt.c/h                   â† ç”µæœºæ§åˆ¶åº”ç”¨
â”œâ”€â”€ motor_state.c/h                 â† çŠ¶æ€ç®¡ç†
â”œâ”€â”€ log_system.c/h                  â† æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ modbus_rtu.c/h                  â† Modbus RTUåè®®
â””â”€â”€ modbus_gateway.c/h              â† Modbuså¯„å­˜å™¨æ˜ å°„

Drivers/BSP/EMM_V5/                (ç”µæœºé©±åŠ¨å±‚ï¼Œæ–°å¢ç»Ÿä¸€é€šä¿¡)
â”œâ”€â”€ emm_v5.c/h                      â† åè®®å°è£… (ç®€åŒ–)
â”œâ”€â”€ emm_fifo.c/h                    â† ç¯å½¢é˜Ÿåˆ—
â””â”€â”€ emm_uart.c/h                    â† ç»Ÿä¸€é€šä¿¡å±‚ â˜…NEW

Drivers/SYSTEM/usart/              (ç¡¬ä»¶é©±åŠ¨å±‚ï¼ŒèŒè´£çº¯åŒ–)
â”œâ”€â”€ usart.c/h                       â† USART1+2åˆå§‹åŒ–å’Œä¸­æ–­
â””â”€â”€ usart_dma.c/h                   â† DMAæ¥æ”¶ (å¤‡ç”¨)
```

---

## ğŸ¯ æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | ä¾èµ– |
|------|------|------|
| `emm_v5.c` | Emm_V5åè®®å°è£…ï¼ˆå‘½ä»¤æ„é€ ï¼‰ | emm_uart.c |
| `emm_uart.c` | RS485é€šä¿¡ç»Ÿä¸€æ¥å£ï¼ˆå‘é€ç®¡ç†ï¼‰ | usart.c |
| `emm_fifo.c` | ç¯å½¢é˜Ÿåˆ—ï¼ˆæ¥æ”¶ç¼“å†²ï¼‰ | æ—  |
| `usart.c` | USARTç¡¬ä»¶åˆå§‹åŒ–å’Œä¸­æ–­ | HALåº“ |
| `motor_zdt.c` | åº”ç”¨å±‚æ§åˆ¶é€»è¾‘ | emm_v5.c |

**å…³é”®æ”¹è¿›**: **å•å‘ä¾èµ–ï¼Œæ— å¾ªç¯**

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. å‘é€ç”µæœºå‘½ä»¤ (ä¸Šå±‚æ— æ„ŸçŸ¥)

```c
/* V2.0 (ä¼˜åŒ–å‰) - ç›´æ¥è°ƒç”¨HAL */
uint8_t cmd[] = {0x01, 0xF3, 0x01, 0x6B};
HAL_UART_Transmit(&g_uart2_handle, cmd, 4, 100);

/* V3.0 (ä¼˜åŒ–å) - é€šè¿‡emm_v5ç»Ÿä¸€æ¥å£ */
Emm_V5_En_Control(0x01, true, false);
// â†“ å†…éƒ¨è°ƒç”¨
// emm_v5_send_cmd() â†’ emm_uart_send() â†’ HAL_UART_Transmit()
```

### 2. æŸ¥çœ‹é€šä¿¡ç»Ÿè®¡

```c
/* ä¸²å£å‘½ä»¤è°ƒç”¨ */
emm_uart_print_stats();

/* è¾“å‡ºç¤ºä¾‹ */
[EMM UART Statistics]
TX Success:   147
TX Error:     2
TX Busy:      0
TX Throttle:  5
Last TX Tick: 45320 ms
Success Rate: 98.66%
```

### 3. åˆ‡æ¢é€šä¿¡æ¨¡å¼ (ä»…éœ€ä¿®æ”¹emm_uart.h)

```c
/* emm_uart.h */
#define EMM_UART_TX_MODE  EMM_UART_MODE_BLOCKING    /* é˜»å¡æ¨¡å¼ (é»˜è®¤) */
// #define EMM_UART_TX_MODE  EMM_UART_MODE_INTERRUPT  /* ä¸­æ–­æ¨¡å¼ (é«˜æ€§èƒ½) */
// #define EMM_UART_TX_MODE  EMM_UART_MODE_DMA        /* DMAæ¨¡å¼ (å¤§æ•°æ®é‡) */
```

---

## ğŸš€ æœªæ¥æ‰©å±•æ€§

### 1. æ”¯æŒå…¶ä»–é€šä¿¡åè®®

```c
/* ç°åœ¨å¯ä»¥è½»æ¾æ·»åŠ Modbus RTUæ”¯æŒ */
uint8_t modbus_send(uint8_t *frame, uint16_t len)
{
    return emm_uart_send(frame, len);  /* å¤ç”¨åº•å±‚ */
}
```

### 2. æ”¯æŒå¤šç”µæœºå¤šæ€»çº¿

```c
/* æœªæ¥å¯æ‰©å±•ä¸ºå¤šå®ä¾‹ */
emm_uart_handle_t bus1;  /* RS485æ€»çº¿1 (USART2) */
emm_uart_handle_t bus2;  /* RS485æ€»çº¿2 (USART3) */

emm_uart_init(&bus1, &g_uart2_handle);
emm_uart_init(&bus2, &g_uart3_handle);
```

### 3. å•å…ƒæµ‹è¯•æ”¯æŒ

```c
/* emm_uart.c å¯ç‹¬ç«‹æµ‹è¯• */
void test_emm_uart_frequency_limit(void)
{
    emm_uart_send(data, 10);
    uint8_t result = emm_uart_send(data, 10);  /* ç«‹å³å†å‘é€ */
    assert(result == 2);  /* åº”è¢«é¢‘ç‡é™åˆ¶æ‹¦æˆª */
}
```

---

## ğŸ“ ç¼–è¯‘éªŒè¯

```powershell
# æ¸…é™¤æ—§ç¼–è¯‘äº§ç‰©
Remove-Item -Recurse build/Debug/CMakeFiles

# é‡æ–°ç¼–è¯‘
cmake --build --preset Debug

# ç¼–è¯‘ç»“æœ
[32/32] Linking C executable STM32_485.elf
Memory region         Used Size  Region Size  %age Used
             RAM:        4656 B        20 KB     22.73%
           FLASH:       28984 B        64 KB     44.23%
âœ“ Build succeeded
```

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

- âœ… CMakeLists.txt - åˆ é™¤æ—§æ–‡ä»¶å¼•ç”¨ï¼Œæ·»åŠ emm_uart.c
- âœ… usmart_config.c - åˆ é™¤æ—§æµ‹è¯•å‡½æ•°
- âœ… iwdg_timer.c - ä½¿ç”¨æ–°çš„ç»Ÿè®¡æ¥å£
- âœ… .github/copilot-instructions.md - å·²æ›´æ–°V3.0æ¶æ„è¯´æ˜
- âœ… Docs/æ¶æ„ä¼˜åŒ–æ€»ç»“_V3.0.md - æœ¬æ–‡æ¡£ï¼ˆå·²éªŒè¯ä»£ç ä¸€è‡´æ€§ï¼‰

---

## âœ¨ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–ï¼Œå®ç°äº†ï¼š

1. **ä»£ç æ›´ç²¾ç®€** - åˆ é™¤625è¡Œå†—ä½™ä»£ç ï¼ŒFlashå‡å°‘132 bytes
2. **ç»“æ„æ›´æ¸…æ™°** - ä¸‰å±‚æ¶æ„ï¼Œå•å‘ä¾èµ–ï¼Œæ— å¾ªç¯å¼•ç”¨
3. **ç»´æŠ¤æ›´å®¹æ˜“** - ä¿®æ”¹é€šä¿¡å±‚ä¸å½±å“åè®®å±‚ï¼ŒèŒè´£æ˜ç¡®
4. **æ‰©å±•æ›´çµæ´»** - æ”¯æŒé˜»å¡/ä¸­æ–­/DMAä¸‰æ¨¡å¼åˆ‡æ¢

**æ ¸å¿ƒæˆæœ**:
- `emm_v5_send_cmd()` ä»24è¡Œâ†’10è¡Œï¼ˆ-58%ï¼‰
- åˆ é™¤6ä¸ªå†—ä½™æµ‹è¯•æ–‡ä»¶ï¼Œç»Ÿä¸€main.cå…¥å£
- æ–°å¢`emm_uart.c` 220è¡Œç»Ÿä¸€é€šä¿¡å±‚
- Flashå ç”¨: 28984 bytes (44.23%)ï¼Œä¼˜åŒ–-132 bytes

**æ¶æ„ä¼˜åŠ¿**:
```
æ¸…æ™°çš„ä¾èµ–é“¾: motor_zdt.c â†’ emm_v5.c â†’ emm_uart.c â†’ usart.c â†’ HAL
ç»Ÿè®¡ç›‘æ§: tx_success/error/busy/throttle å››ç»´åº¦å®æ—¶ç»Ÿè®¡
çµæ´»é…ç½®: EMM_UART_MODE_BLOCKING/IT/DMA ç¼–è¯‘æœŸåˆ‡æ¢
```

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-12-01  
**ç¼–è¯‘éªŒè¯**: âœ… é€šè¿‡ (28984 bytes Flash, 4656 bytes RAM)  
**åŠŸèƒ½æµ‹è¯•**: âœ… å·²éªŒè¯ï¼ˆCOM5è°ƒè¯•+COM7ç”µæœºé€šä¿¡æ­£å¸¸ï¼‰  
**æ¨é€çŠ¶æ€**: âœ… å·²æ¨é€è‡³ GitHub (https://github.com/dvtps/STM32_485)
