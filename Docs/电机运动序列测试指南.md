# 电机运动序列测试指南

## 概述

新增的电机运动序列模块实现了按键触发X轴电机运动序列功能：
- **触发按键**: KEY0 (PC13)
- **运动序列**: 前进5.12mm → 后退10.22mm → 前进15.32mm → 停止

## 硬件连接

1. **电机连接**: X轴电机连接到地址0x01
2. **按键**: KEY0按键 (PC13) 用于触发序列
3. **串口**: USART1用于调试输出 (115200bps)

## 测试步骤

### 1. 编译和烧录
```bash
# 构建项目
cmake --build --preset Debug

# 烧录到开发板 (选择其中一种方式)
# 方式1: 使用STM32CubeProgrammer
./flash.bat

# 方式2: 使用pyOCD
pyocd flash -t stm32f103c8 build/Debug/STM32_485.elf
```

### 2. 上电启动
- 开发板上电后，LED会开始心跳闪烁
- 串口输出会显示初始化信息
- 看到"[SEQ] 运动序列模块已初始化"表示模块加载成功

### 3. 触发测试
- **按下KEY0按键** (PC13)
- 观察串口输出，应该看到：
```
[KEY] KEY0按下，启动X轴运动序列
[SEQ] 开始执行X轴运动序列: 前进5.12mm → 后退10.22mm → 前进15.32mm → 停止
[SEQ] 执行步骤: 前进 5.12mm (819脉冲), 速度=300RPM, 估算时间=82ms
[SEQ] 步骤到位，切换到下一步
[SEQ] 执行步骤: 后退 10.22mm (1635脉冲), 速度=300RPM, 估算时间=164ms
[SEQ] 步骤到位，切换到下一步
[SEQ] 执行步骤: 前进 15.32mm (2451脉冲), 速度=300RPM, 估算时间=245ms
[SEQ] 步骤到位，切换到下一步
[SEQ] 运动序列执行完成
[SEQ] 运动序列全部完成
```

### 4. 电机运动观察
- **第一步**: X轴电机前进5.12mm
- **第二步**: X轴电机后退10.22mm (回到起始位置后再后退5.1mm)
- **第三步**: X轴电机前进15.32mm
- **第四步**: 电机停止

## 技术参数

- **电机地址**: 0x01 (X轴)
- **运动速度**: 300 RPM
- **加速度**: 50
- **脉冲当量**: 160脉冲/mm (3200脉冲/圈 ÷ 20mm导程)
- **控制精度**: 0.02mm单位 (20微米)
- **到位检测**: 实时位置反馈，误差容限10脉冲(±0.0625mm)
- **位置查询**: 50ms间隔非阻塞查询
- **超时保护**: 5秒最大等待时间
- **步长估算**:
  - 5.12mm (256单位): ~82ms
  - 10.22mm (511单位): ~164ms  
  - 15.32mm (766单位): ~245ms
- **控制机制**: 基于位置到位检测，确保每步完成后再进行下一步

### 位置检测参数

- **位置查询**: S_ENCL (编码器校准位置，功能码0x31)
- **到位容差**: ±10脉冲 (±0.0625mm)
- **查询间隔**: 50ms
- **超时时间**: 5秒
- **位置精度**: 0.02mm (电机原生精度)
- **脉冲转换**: 160脉冲/mm

## 故障排查

### 电机无响应
1. 检查RS485连接线 (A-A, B-B)
2. 确认电机地址设置 (默认0x01)
3. 验证电机供电 (24V DC)

### 按键无响应
1. 检查KEY0按键硬件连接
2. 确认串口输出中是否有按键检测信息

### 序列执行异常
1. 检查电机是否已正确使能
2. 观察是否有堵转或通信错误
3. 查看串口输出的详细错误信息

## 位置检测机制详解

### 工作原理

1. **运动命令发送**: 执行每一步运动时，记录目标位置
2. **编码器查询**: 每50ms发送S_ENCL命令获取经过线性化校准的编码器位置
3. **到位判断**: 当当前编码器位置与目标位置差值小于10脉冲时，认为到位
4. **超时保护**: 如果5秒内未到位，强制切换到下一步并记录错误
5. **状态同步**: 到位后立即切换到下一步，确保运动连续性

### 优势对比

| 特性 | 旧版(S_CPOS) | 新版(S_ENCL) |
|------|-------------|--------------|
| 位置数据 | 实时位置 | 经过线性化校准的编码器值 |
| 精度 | 电机计算位置 | 实际编码器反馈，经过校准 |
| 可靠性 | 可能受计算误差影响 | 直接编码器测量，更可靠 |
| 适用性 | 标准位置控制 | 闭环控制系统的最佳选择 |
| 调试性 | 位置显示 | 编码器位置显示，便于调试 |

### 调试信息

正常执行时会看到：
```
[SEQ] 执行步骤: 前进 5.12mm (819脉冲), 速度=300RPM, 估算时间=61ms
[POS] 编码器查询: 当前=0, 目标=819, 差值=819
[POS] 编码器查询: 当前=410, 目标=819, 差值=409
[POS] 编码器查询: 当前=819, 目标=819, 差值=0
[SEQ] 步骤到位，切换到下一步
```

异常情况：
```
[POS] 编码器查询超时，强制切换到下一步
[POS] 编码器查询失败: 通信错误
```

### USMART调试命令
通过串口助手可以调用以下调试函数：

```bash
# 手动触发运动序列
motor_sequence_run_x_axis_demo()

# 查询序列状态
motor_sequence_get_status()

# 位置查询相关
motor_get_current_position(1)      # 查询电机1当前位置（兼容）
motor_get_encoder_position(1)      # 查询电机1编码器位置（S_ENCL）
motor_sequence_query_position()    # 查询序列当前位置状态
motor_sequence_reset_position()    # 重置位置跟踪状态

# 高级调试
motor_pos_query_test(1)           # 测试电机1位置查询功能
motor_encoder_query_test(1)       # 测试电机1编码器查询功能
motor_sequence_set_target(819)    # 设置目标位置为819脉冲
motor_sequence_check_arrival()    # 检查是否到达目标位置

# 强制停止序列
motor_sequence_stop()
```

### 自定义序列
修改 `motor_sequence.c` 中的参数可以自定义运动序列：
- `SEQ_FORWARD_1_MM`: 第一步前进距离
- `SEQ_BACKWARD_MM`: 第二步后退距离
- `SEQ_FORWARD_2_MM`: 第三步前进距离
- `SEQ_SPEED_RPM`: 运动速度
- `SEQ_STEP_DELAY_MS`: 步骤间隔时间

## 注意事项

1. **安全第一**: 确保电机工作区域无障碍物
2. **电源稳定**: 使用稳定的24V电源供电
3. **通信稳定**: 确保RS485线缆连接牢固
4. **观察运行**: 首次测试时密切观察电机运行状态

## 版本信息

- **模块版本**: V1.1 (位置检测增强版)
- **创建日期**: 2025-12-05
- **更新日期**: 2025-12-05
- **主要改进**: 添加实时位置反馈和到位检测机制
- **测试平台**: STM32F103C8 + 张大头Y系列电机